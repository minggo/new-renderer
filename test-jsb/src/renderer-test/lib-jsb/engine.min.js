var engine=function(){"use strict";const t=Math.PI/180;const e=180/Math.PI;const n=1e-6;function r(t,e){return Math.abs(t-e)<=n*Math.max(1,Math.abs(t),Math.abs(e))}function i(t,e,r){r=r||n;return Math.abs(t-e)<=r}function s(t,e,n){return t<e?e:t>n?n:t}function a(t){return t<0?0:t>1?1:t}function l(t,e,n){return t+(e-t)*n}function o(e){return e*t}function m(t){return t*e}const h=Math.random;function u(t,e){return Math.random()*(e-t)+t}function c(t,e){return Math.floor(u(t,e))}function f(t){--t;t=t>>1|t;t=t>>2|t;t=t>>4|t;t=t>>8|t;t=t>>16|t;++t;return t}const _=32;const d=2147483647;const p=-1<<_-1;function x(t){return(t>0)-(t<0)}function g(t){let e=t>>_-1;return(t^e)-e}function T(t,e){return e^(t^e)&-(t<e)}function E(t,e){return t^(t^e)&-(t<e)}function A(t){return!(t&t-1)&&!!t}function M(t){let e,n;e=(t>65535)<<4;t>>>=e;n=(t>255)<<3;t>>>=n;e|=n;n=(t>15)<<2;t>>>=n;e|=n;n=(t>3)<<1;t>>>=n;e|=n;return e|t>>1}function y(t){return t>=1e9?9:t>=1e8?8:t>=1e7?7:t>=1e6?6:t>=1e5?5:t>=1e4?4:t>=1e3?3:t>=100?2:t>=10?1:0}function S(t){t=t-(t>>>1&1431655765);t=(t&858993459)+(t>>>2&858993459);return(t+(t>>>4)&252645135)*16843009>>>24}function b(t){let e=32;t&=-t;if(t)e--;if(t&65535)e-=16;if(t&16711935)e-=8;if(t&252645135)e-=4;if(t&858993459)e-=2;if(t&1431655765)e-=1;return e}function R(t){t+=t===0;--t;t|=t>>>1;t|=t>>>2;t|=t>>>4;t|=t>>>8;t|=t>>>16;return t+1}function w(t){t|=t>>>1;t|=t>>>2;t|=t>>>4;t|=t>>>8;t|=t>>>16;return t-(t>>>1)}function v(t){t^=t>>>16;t^=t>>>8;t^=t>>>4;t&=15;return 27030>>>t&1}const F=new Array(256);(function(t){for(let e=0;e<256;++e){let n=e,r=e,i=7;for(n>>>=1;n;n>>>=1){r<<=1;r|=n&1;--i}t[e]=r<<i&255}})(F);function P(t){return F[t&255]<<24|F[t>>>8&255]<<16|F[t>>>16&255]<<8|F[t>>>24&255]}function L(t,e){t&=65535;t=(t|t<<8)&16711935;t=(t|t<<4)&252645135;t=(t|t<<2)&858993459;t=(t|t<<1)&1431655765;e&=65535;e=(e|e<<8)&16711935;e=(e|e<<4)&252645135;e=(e|e<<2)&858993459;e=(e|e<<1)&1431655765;return t|e<<1}function I(t,e){t=t>>>e&1431655765;t=(t|t>>>1)&858993459;t=(t|t>>>2)&252645135;t=(t|t>>>4)&16711935;t=(t|t>>>16)&65535;return t<<16>>16}function D(t,e,n){t&=1023;t=(t|t<<16)&4278190335;t=(t|t<<8)&251719695;t=(t|t<<4)&3272356035;t=(t|t<<2)&1227133513;e&=1023;e=(e|e<<16)&4278190335;e=(e|e<<8)&251719695;e=(e|e<<4)&3272356035;e=(e|e<<2)&1227133513;t|=e<<1;n&=1023;n=(n|n<<16)&4278190335;n=(n|n<<8)&251719695;n=(n|n<<4)&3272356035;n=(n|n<<2)&1227133513;return t|n<<2}function C(t,e){t=t>>>e&1227133513;t=(t|t>>>2)&3272356035;t=(t|t>>>4)&251719695;t=(t|t>>>8)&4278190335;t=(t|t>>>16)&1023;return t<<22>>22}function O(t){let e=t|t-1;return e+1|(~e&-~e)-1>>>b(t)+1}var B=Object.freeze({INT_BITS:_,INT_MAX:d,INT_MIN:p,sign:x,abs:g,min:T,max:E,isPow2:A,log2:M,log10:y,popCount:S,countTrailingZeros:b,nextPow2:R,prevPow2:w,parity:v,reverse:P,interleave2:L,deinterleave2:I,interleave3:D,deinterleave3:C,nextCombination:O});let N=new Array(2);class z{constructor(t,e){this.x=t;this.y=e}toJSON(){N[0]=this.x;N[1]=this.y;return N}}let U={};U.create=function(){return new z(0,0)};U.new=function(t,e){return new z(t,e)};U.clone=function(t){return new z(t.x,t.y)};U.copy=function(t,e){t.x=e.x;t.y=e.y;return t};U.set=function(t,e,n){t.x=e;t.y=n;return t};U.add=function(t,e,n){t.x=e.x+n.x;t.y=e.y+n.y;return t};U.subtract=function(t,e,n){t.x=e.x-n.x;t.y=e.y-n.y;return t};U.sub=U.subtract;U.multiply=function(t,e,n){t.x=e.x*n.x;t.y=e.y*n.y;return t};U.mul=U.multiply;U.divide=function(t,e,n){t.x=e.x/n.x;t.y=e.y/n.y;return t};U.div=U.divide;U.ceil=function(t,e){t.x=Math.ceil(e.x);t.y=Math.ceil(e.y);return t};U.floor=function(t,e){t.x=Math.floor(e.x);t.y=Math.floor(e.y);return t};U.min=function(t,e,n){t.x=Math.min(e.x,n.x);t.y=Math.min(e.y,n.y);return t};U.max=function(t,e,n){t.x=Math.max(e.x,n.x);t.y=Math.max(e.y,n.y);return t};U.round=function(t,e){t.x=Math.round(e.x);t.y=Math.round(e.y);return t};U.scale=function(t,e,n){t.x=e.x*n;t.y=e.y*n;return t};U.scaleAndAdd=function(t,e,n,r){t.x=e.x+n.x*r;t.y=e.y+n.y*r;return t};U.distance=function(t,e){let n=e.x-t.x,r=e.y-t.y;return Math.sqrt(n*n+r*r)};U.dist=U.distance;U.squaredDistance=function(t,e){let n=e.x-t.x,r=e.y-t.y;return n*n+r*r};U.sqrDist=U.squaredDistance;U.length=function(t){let e=t.x,n=t.y;return Math.sqrt(e*e+n*n)};U.len=U.length;U.squaredLength=function(t){let e=t.x,n=t.y;return e*e+n*n};U.sqrLen=U.squaredLength;U.negate=function(t,e){t.x=-e.x;t.y=-e.y;return t};U.inverse=function(t,e){t.x=1/e.x;t.y=1/e.y;return t};U.inverseSafe=function(t,e){let r=e.x,i=e.y;if(Math.abs(r)<n){t.x=0}else{t.x=1/r}if(Math.abs(i)<n){t.y=0}else{t.y=1/e.y}return t};U.normalize=function(t,e){let n=e.x,r=e.y;let i=n*n+r*r;if(i>0){i=1/Math.sqrt(i);t.x=e.x*i;t.y=e.y*i}return t};U.dot=function(t,e){return t.x*e.x+t.y*e.y};U.cross=function(t,e,n){let r=e.x*n.y-e.y*n.x;t.x=t.y=0;t.z=r;return t};U.lerp=function(t,e,n,r){let i=e.x,s=e.y;t.x=i+r*(n.x-i);t.y=s+r*(n.y-s);return t};U.random=function(t,e){e=e||1;let n=h()*2*Math.PI;t.x=Math.cos(n)*e;t.y=Math.sin(n)*e;return t};U.transformMat2=function(t,e,n){let r=e.x,i=e.y;t.x=n.m00*r+n.m02*i;t.y=n.m01*r+n.m03*i;return t};U.transformMat23=function(t,e,n){let r=e.x,i=e.y;t.x=n.m00*r+n.m02*i+n.m04;t.y=n.m01*r+n.m03*i+n.m05;return t};U.transformMat3=function(t,e,n){let r=e.x,i=e.y;t.x=n.m00*r+n.m03*i+n.m06;t.y=n.m01*r+n.m04*i+n.m07;return t};U.transformMat4=function(t,e,n){let r=e.x,i=e.y;t.x=n.m00*r+n.m04*i+n.m12;t.y=n.m01*r+n.m05*i+n.m13;return t};U.forEach=function(){let t=U.create();return function(e,n,r,i,s,a){let l,o;if(!n){n=2}if(!r){r=0}if(i){o=Math.min(i*n+r,e.length)}else{o=e.length}for(l=r;l<o;l+=n){t.x=e[l];t.y=e[l+1];s(t,t,a);e[l]=t.x;e[l+1]=t.y}return e}}();U.str=function(t){return`vec2(${t.x}, ${t.y})`};U.array=function(t,e){t[0]=e.x;t[1]=e.y;return t};U.exactEquals=function(t,e){return t.x===e.x&&t.y===e.y};U.equals=function(t,e){let r=t.x,i=t.y;let s=e.x,a=e.y;return Math.abs(r-s)<=n*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(i-a)<=n*Math.max(1,Math.abs(i),Math.abs(a))};let V=new Array(3);class k{constructor(t,e,n){this.x=t;this.y=e;this.z=n}toJSON(){V[0]=this.x;V[1]=this.y;V[2]=this.z;return V}}let q={};q.create=function(){return new k(0,0,0)};q.new=function(t,e,n){return new k(t,e,n)};q.clone=function(t){return new k(t.x,t.y,t.z)};q.copy=function(t,e){t.x=e.x;t.y=e.y;t.z=e.z;return t};q.set=function(t,e,n,r){t.x=e;t.y=n;t.z=r;return t};q.add=function(t,e,n){t.x=e.x+n.x;t.y=e.y+n.y;t.z=e.z+n.z;return t};q.subtract=function(t,e,n){t.x=e.x-n.x;t.y=e.y-n.y;t.z=e.z-n.z;return t};q.sub=q.subtract;q.multiply=function(t,e,n){t.x=e.x*n.x;t.y=e.y*n.y;t.z=e.z*n.z;return t};q.mul=q.multiply;q.divide=function(t,e,n){t.x=e.x/n.x;t.y=e.y/n.y;t.z=e.z/n.z;return t};q.div=q.divide;q.ceil=function(t,e){t.x=Math.ceil(e.x);t.y=Math.ceil(e.y);t.z=Math.ceil(e.z);return t};q.floor=function(t,e){t.x=Math.floor(e.x);t.y=Math.floor(e.y);t.z=Math.floor(e.z);return t};q.min=function(t,e,n){t.x=Math.min(e.x,n.x);t.y=Math.min(e.y,n.y);t.z=Math.min(e.z,n.z);return t};q.max=function(t,e,n){t.x=Math.max(e.x,n.x);t.y=Math.max(e.y,n.y);t.z=Math.max(e.z,n.z);return t};q.round=function(t,e){t.x=Math.round(e.x);t.y=Math.round(e.y);t.z=Math.round(e.z);return t};q.scale=function(t,e,n){t.x=e.x*n;t.y=e.y*n;t.z=e.z*n;return t};q.scaleAndAdd=function(t,e,n,r){t.x=e.x+n.x*r;t.y=e.y+n.y*r;t.z=e.z+n.z*r;return t};q.distance=function(t,e){let n=e.x-t.x,r=e.y-t.y,i=e.z-t.z;return Math.sqrt(n*n+r*r+i*i)};q.dist=q.distance;q.squaredDistance=function(t,e){let n=e.x-t.x,r=e.y-t.y,i=e.z-t.z;return n*n+r*r+i*i};q.sqrDist=q.squaredDistance;q.length=function(t){let e=t.x,n=t.y,r=t.z;return Math.sqrt(e*e+n*n+r*r)};q.len=q.length;q.squaredLength=function(t){let e=t.x,n=t.y,r=t.z;return e*e+n*n+r*r};q.sqrLen=q.squaredLength;q.negate=function(t,e){t.x=-e.x;t.y=-e.y;t.z=-e.z;return t};q.inverse=function(t,e){t.x=1/e.x;t.y=1/e.y;t.z=1/e.z;return t};q.inverseSafe=function(t,e){let r=e.x,i=e.y,s=e.z;if(Math.abs(r)<n){t.x=0}else{t.x=1/r}if(Math.abs(i)<n){t.y=0}else{t.y=1/i}if(Math.abs(s)<n){t.z=0}else{t.z=1/s}return t};q.normalize=function(t,e){let n=e.x,r=e.y,i=e.z;let s=n*n+r*r+i*i;if(s>0){s=1/Math.sqrt(s);t.x=n*s;t.y=r*s;t.z=i*s}return t};q.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z};q.cross=function(t,e,n){let r=e.x,i=e.y,s=e.z,a=n.x,l=n.y,o=n.z;t.x=i*o-s*l;t.y=s*a-r*o;t.z=r*l-i*a;return t};q.lerp=function(t,e,n,r){let i=e.x,s=e.y,a=e.z;t.x=i+r*(n.x-i);t.y=s+r*(n.y-s);t.z=a+r*(n.z-a);return t};q.hermite=function(t,e,n,r,i,s){let a=s*s,l=a*(2*s-3)+1,o=a*(s-2)+s,m=a*(s-1),h=a*(3-2*s);t.x=e.x*l+n.x*o+r.x*m+i.x*h;t.y=e.y*l+n.y*o+r.y*m+i.y*h;t.z=e.z*l+n.z*o+r.z*m+i.z*h;return t};q.bezier=function(t,e,n,r,i,s){let a=1-s,l=a*a,o=s*s,m=l*a,h=3*s*l,u=3*o*a,c=o*s;t.x=e.x*m+n.x*h+r.x*u+i.x*c;t.y=e.y*m+n.y*h+r.y*u+i.y*c;t.z=e.z*m+n.z*h+r.z*u+i.z*c;return t};q.random=function(t,e){e=e||1;let n=h()*2*Math.PI;let r=h()*2-1;let i=Math.sqrt(1-r*r)*e;t.x=Math.cos(n)*i;t.y=Math.sin(n)*i;t.z=r*e;return t};q.transformMat4=function(t,e,n){let r=e.x,i=e.y,s=e.z,a=n.m03*r+n.m07*i+n.m11*s+n.m15;a=a||1;t.x=(n.m00*r+n.m04*i+n.m08*s+n.m12)/a;t.y=(n.m01*r+n.m05*i+n.m09*s+n.m13)/a;t.z=(n.m02*r+n.m06*i+n.m10*s+n.m14)/a;return t};q.transformMat3=function(t,e,n){let r=e.x,i=e.y,s=e.z;t.x=r*n.m00+i*n.m03+s*n.m06;t.y=r*n.m01+i*n.m04+s*n.m07;t.z=r*n.m02+i*n.m05+s*n.m08;return t};q.transformQuat=function(t,e,n){let r=e.x,i=e.y,s=e.z;let a=n.x,l=n.y,o=n.z,m=n.w;let h=m*r+l*s-o*i;let u=m*i+o*r-a*s;let c=m*s+a*i-l*r;let f=-a*r-l*i-o*s;t.x=h*m+f*-a+u*-o-c*-l;t.y=u*m+f*-l+c*-a-h*-o;t.z=c*m+f*-o+h*-l-u*-a;return t};q.rotateX=function(t,e,n,r){let i=[],s=[];i.x=e.x-n.x;i.y=e.y-n.y;i.z=e.z-n.z;s.x=i.x;s.y=i.y*Math.cos(r)-i.z*Math.sin(r);s.z=i.y*Math.sin(r)+i.z*Math.cos(r);t.x=s.x+n.x;t.y=s.y+n.y;t.z=s.z+n.z;return t};q.rotateY=function(t,e,n,r){let i=[],s=[];i.x=e.x-n.x;i.y=e.y-n.y;i.z=e.z-n.z;s.x=i.z*Math.sin(r)+i.x*Math.cos(r);s.y=i.y;s.z=i.z*Math.cos(r)-i.x*Math.sin(r);t.x=s.x+n.x;t.y=s.y+n.y;t.z=s.z+n.z;return t};q.rotateZ=function(t,e,n,r){let i=[],s=[];i.x=e.x-n.x;i.y=e.y-n.y;i.z=e.z-n.z;s.x=i.x*Math.cos(r)-i.y*Math.sin(r);s.y=i.x*Math.sin(r)+i.y*Math.cos(r);s.z=i.z;t.x=s.x+n.x;t.y=s.y+n.y;t.z=s.z+n.z;return t};q.forEach=function(){let t=q.create();return function(e,n,r,i,s,a){let l,o;if(!n){n=3}if(!r){r=0}if(i){o=Math.min(i*n+r,e.length)}else{o=e.length}for(l=r;l<o;l+=n){t.x=e[l];t.y=e[l+1];t.z=e[l+2];s(t,t,a);e[l]=t.x;e[l+1]=t.y;e[l+2]=t.z}return e}}();q.angle=function(){let t=q.create();let e=q.create();return function(n,r){q.copy(t,n);q.copy(e,r);q.normalize(t,t);q.normalize(e,e);let i=q.dot(t,e);if(i>1){return 0}if(i<-1){return Math.PI}return Math.acos(i)}}();q.str=function(t){return`vec3(${t.x}, ${t.y}, ${t.z})`};q.array=function(t,e){t[0]=e.x;t[1]=e.y;t[2]=e.z;return t};q.exactEquals=function(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z};q.equals=function(t,e){let r=t.x,i=t.y,s=t.z;let a=e.x,l=e.y,o=e.z;return Math.abs(r-a)<=n*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(i-l)<=n*Math.max(1,Math.abs(i),Math.abs(l))&&Math.abs(s-o)<=n*Math.max(1,Math.abs(s),Math.abs(o))};let X=new Array(4);class W{constructor(t,e,n,r){this.x=t;this.y=e;this.z=n;this.w=r}toJSON(){X[0]=this.x;X[1]=this.y;X[2]=this.z;X[3]=this.w;return X}}let G={};G.create=function(){return new W(0,0,0,0)};G.new=function(t,e,n,r){return new W(t,e,n,r)};G.clone=function(t){return new W(t.x,t.y,t.z,t.w)};G.copy=function(t,e){t.x=e.x;t.y=e.y;t.z=e.z;t.w=e.w;return t};G.set=function(t,e,n,r,i){t.x=e;t.y=n;t.z=r;t.w=i;return t};G.add=function(t,e,n){t.x=e.x+n.x;t.y=e.y+n.y;t.z=e.z+n.z;t.w=e.w+n.w;return t};G.subtract=function(t,e,n){t.x=e.x-n.x;t.y=e.y-n.y;t.z=e.z-n.z;t.w=e.w-n.w;return t};G.sub=G.subtract;G.multiply=function(t,e,n){t.x=e.x*n.x;t.y=e.y*n.y;t.z=e.z*n.z;t.w=e.w*n.w;return t};G.mul=G.multiply;G.divide=function(t,e,n){t.x=e.x/n.x;t.y=e.y/n.y;t.z=e.z/n.z;t.w=e.w/n.w;return t};G.div=G.divide;G.ceil=function(t,e){t.x=Math.ceil(e.x);t.y=Math.ceil(e.y);t.z=Math.ceil(e.z);t.w=Math.ceil(e.w);return t};G.floor=function(t,e){t.x=Math.floor(e.x);t.y=Math.floor(e.y);t.z=Math.floor(e.z);t.w=Math.floor(e.w);return t};G.min=function(t,e,n){t.x=Math.min(e.x,n.x);t.y=Math.min(e.y,n.y);t.z=Math.min(e.z,n.z);t.w=Math.min(e.w,n.w);return t};G.max=function(t,e,n){t.x=Math.max(e.x,n.x);t.y=Math.max(e.y,n.y);t.z=Math.max(e.z,n.z);t.w=Math.max(e.w,n.w);return t};G.round=function(t,e){t.x=Math.round(e.x);t.y=Math.round(e.y);t.z=Math.round(e.z);t.w=Math.round(e.w);return t};G.scale=function(t,e,n){t.x=e.x*n;t.y=e.y*n;t.z=e.z*n;t.w=e.w*n;return t};G.scaleAndAdd=function(t,e,n,r){t.x=e.x+n.x*r;t.y=e.y+n.y*r;t.z=e.z+n.z*r;t.w=e.w+n.w*r;return t};G.distance=function(t,e){let n=e.x-t.x,r=e.y-t.y,i=e.z-t.z,s=e.w-t.w;return Math.sqrt(n*n+r*r+i*i+s*s)};G.dist=G.distance;G.squaredDistance=function(t,e){let n=e.x-t.x,r=e.y-t.y,i=e.z-t.z,s=e.w-t.w;return n*n+r*r+i*i+s*s};G.sqrDist=G.squaredDistance;G.length=function(t){let e=t.x,n=t.y,r=t.z,i=t.w;return Math.sqrt(e*e+n*n+r*r+i*i)};G.len=G.length;G.squaredLength=function(t){let e=t.x,n=t.y,r=t.z,i=t.w;return e*e+n*n+r*r+i*i};G.sqrLen=G.squaredLength;G.negate=function(t,e){t.x=-e.x;t.y=-e.y;t.z=-e.z;t.w=-e.w;return t};G.inverse=function(t,e){t.x=1/e.x;t.y=1/e.y;t.z=1/e.z;t.w=1/e.w;return t};G.inverseSafe=function(t,e){let r=e.x,i=e.y,s=e.z,a=e.w;if(Math.abs(r)<n){t.x=0}else{t.x=1/r}if(Math.abs(i)<n){t.y=0}else{t.y=1/i}if(Math.abs(s)<n){t.z=0}else{t.z=1/s}if(Math.abs(a)<n){t.w=0}else{t.w=1/a}return t};G.normalize=function(t,e){let n=e.x,r=e.y,i=e.z,s=e.w;let a=n*n+r*r+i*i+s*s;if(a>0){a=1/Math.sqrt(a);t.x=n*a;t.y=r*a;t.z=i*a;t.w=s*a}return t};G.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w};G.lerp=function(t,e,n,r){let i=e.x,s=e.y,a=e.z,l=e.w;t.x=i+r*(n.x-i);t.y=s+r*(n.y-s);t.z=a+r*(n.z-a);t.w=l+r*(n.w-l);return t};G.random=function(t,e){e=e||1;t.x=h();t.y=h();t.z=h();t.w=h();G.normalize(t,t);G.scale(t,t,e);return t};G.transformMat4=function(t,e,n){let r=e.x,i=e.y,s=e.z,a=e.w;t.x=n.m00*r+n.m04*i+n.m08*s+n.m12*a;t.y=n.m01*r+n.m05*i+n.m09*s+n.m13*a;t.z=n.m02*r+n.m06*i+n.m10*s+n.m14*a;t.w=n.m03*r+n.m07*i+n.m11*s+n.m15*a;return t};G.transformQuat=function(t,e,n){let r=e.x,i=e.y,s=e.z;let a=n.x,l=n.y,o=n.z,m=n.w;let h=m*r+l*s-o*i;let u=m*i+o*r-a*s;let c=m*s+a*i-l*r;let f=-a*r-l*i-o*s;t.x=h*m+f*-a+u*-o-c*-l;t.y=u*m+f*-l+c*-a-h*-o;t.z=c*m+f*-o+h*-l-u*-a;t.w=e.w;return t};G.forEach=function(){let t=G.create();return function(e,n,r,i,s,a){let l,o;if(!n){n=4}if(!r){r=0}if(i){o=Math.min(i*n+r,e.length)}else{o=e.length}for(l=r;l<o;l+=n){t.x=e[l];t.y=e[l+1];t.z=e[l+2];t.w=e[l+3];s(t,t,a);e[l]=t.x;e[l+1]=t.y;e[l+2]=t.z;e[l+3]=t.w}return e}}();G.str=function(t){return`vec4(${t.x}, ${t.y}, ${t.z}, ${t.w})`};G.array=function(t,e){t[0]=e.x;t[1]=e.y;t[2]=e.z;t[3]=e.w;return t};G.exactEquals=function(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w};G.equals=function(t,e){let r=t.x,i=t.y,s=t.z,a=t.w;let l=e.x,o=e.y,m=e.z,h=e.w;return Math.abs(r-l)<=n*Math.max(1,Math.abs(r),Math.abs(l))&&Math.abs(i-o)<=n*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(s-m)<=n*Math.max(1,Math.abs(s),Math.abs(m))&&Math.abs(a-h)<=n*Math.max(1,Math.abs(a),Math.abs(h))};let H=new Array(9);class Y{constructor(t,e,n,r,i,s,a,l,o){this.m00=t;this.m01=e;this.m02=n;this.m03=r;this.m04=i;this.m05=s;this.m06=a;this.m07=l;this.m08=o}toJSON(){H[0]=this.m00;H[1]=this.m01;H[2]=this.m02;H[3]=this.m03;H[4]=this.m04;H[5]=this.m05;H[6]=this.m06;H[7]=this.m07;H[8]=this.m08;return H}}let $={};$.create=function(){return new Y(1,0,0,0,1,0,0,0,1)};$.new=function(t,e,n,r,i,s,a,l,o){return new Y(t,e,n,r,i,s,a,l,o)};$.clone=function(t){return new Y(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08)};$.copy=function(t,e){t.m00=e.m00;t.m01=e.m01;t.m02=e.m02;t.m03=e.m03;t.m04=e.m04;t.m05=e.m05;t.m06=e.m06;t.m07=e.m07;t.m08=e.m08;return t};$.set=function(t,e,n,r,i,s,a,l,o,m){t.m00=e;t.m01=n;t.m02=r;t.m03=i;t.m04=s;t.m05=a;t.m06=l;t.m07=o;t.m08=m;return t};$.identity=function(t){t.m00=1;t.m01=0;t.m02=0;t.m03=0;t.m04=1;t.m05=0;t.m06=0;t.m07=0;t.m08=1;return t};$.transpose=function(t,e){if(t===e){let n=e.m01,r=e.m02,i=e.m05;t.m01=e.m03;t.m02=e.m06;t.m03=n;t.m05=e.m07;t.m06=r;t.m07=i}else{t.m00=e.m00;t.m01=e.m03;t.m02=e.m06;t.m03=e.m01;t.m04=e.m04;t.m05=e.m07;t.m06=e.m02;t.m07=e.m05;t.m08=e.m08}return t};$.invert=function(t,e){let n=e.m00,r=e.m01,i=e.m02,s=e.m03,a=e.m04,l=e.m05,o=e.m06,m=e.m07,h=e.m08;let u=h*a-l*m;let c=-h*s+l*o;let f=m*s-a*o;let _=n*u+r*c+i*f;if(!_){return null}_=1/_;t.m00=u*_;t.m01=(-h*r+i*m)*_;t.m02=(l*r-i*a)*_;t.m03=c*_;t.m04=(h*n-i*o)*_;t.m05=(-l*n+i*s)*_;t.m06=f*_;t.m07=(-m*n+r*o)*_;t.m08=(a*n-r*s)*_;return t};$.adjoint=function(t,e){let n=e.m00,r=e.m01,i=e.m02,s=e.m03,a=e.m04,l=e.m05,o=e.m06,m=e.m07,h=e.m08;t.m00=a*h-l*m;t.m01=i*m-r*h;t.m02=r*l-i*a;t.m03=l*o-s*h;t.m04=n*h-i*o;t.m05=i*s-n*l;t.m06=s*m-a*o;t.m07=r*o-n*m;t.m08=n*a-r*s;return t};$.determinant=function(t){let e=t.m00,n=t.m01,r=t.m02,i=t.m03,s=t.m04,a=t.m05,l=t.m06,o=t.m07,m=t.m08;return e*(m*s-a*o)+n*(-m*i+a*l)+r*(o*i-s*l)};$.multiply=function(t,e,n){let r=e.m00,i=e.m01,s=e.m02,a=e.m03,l=e.m04,o=e.m05,m=e.m06,h=e.m07,u=e.m08;let c=n.m00,f=n.m01,_=n.m02;let d=n.m03,p=n.m04,x=n.m05;let g=n.m06,T=n.m07,E=n.m08;t.m00=c*r+f*a+_*m;t.m01=c*i+f*l+_*h;t.m02=c*s+f*o+_*u;t.m03=d*r+p*a+x*m;t.m04=d*i+p*l+x*h;t.m05=d*s+p*o+x*u;t.m06=g*r+T*a+E*m;t.m07=g*i+T*l+E*h;t.m08=g*s+T*o+E*u;return t};$.mul=$.multiply;$.translate=function(t,e,n){let r=e.m00,i=e.m01,s=e.m02,a=e.m03,l=e.m04,o=e.m05,m=e.m06,h=e.m07,u=e.m08;let c=n.x,f=n.y;t.m00=r;t.m01=i;t.m02=s;t.m03=a;t.m04=l;t.m05=o;t.m06=c*r+f*a+m;t.m07=c*i+f*l+h;t.m08=c*s+f*o+u;return t};$.rotate=function(t,e,n){let r=e.m00,i=e.m01,s=e.m02,a=e.m03,l=e.m04,o=e.m05,m=e.m06,h=e.m07,u=e.m08;let c=Math.sin(n);let f=Math.cos(n);t.m00=f*r+c*a;t.m01=f*i+c*l;t.m02=f*s+c*o;t.m03=f*a-c*r;t.m04=f*l-c*i;t.m05=f*o-c*s;t.m06=m;t.m07=h;t.m08=u;return t};$.scale=function(t,e,n){let r=n.x,i=n.y;t.m00=r*e.m00;t.m01=r*e.m01;t.m02=r*e.m02;t.m03=i*e.m03;t.m04=i*e.m04;t.m05=i*e.m05;t.m06=e.m06;t.m07=e.m07;t.m08=e.m08;return t};$.fromMat4=function(t,e){t.m00=e.m00;t.m01=e.m01;t.m02=e.m02;t.m03=e.m04;t.m04=e.m05;t.m05=e.m06;t.m06=e.m08;t.m07=e.m09;t.m08=e.m10;return t};$.fromTranslation=function(t,e){t.m00=1;t.m01=0;t.m02=0;t.m03=0;t.m04=1;t.m05=0;t.m06=e.x;t.m07=e.y;t.m08=1;return t};$.fromRotation=function(t,e){let n=Math.sin(e),r=Math.cos(e);t.m00=r;t.m01=n;t.m02=0;t.m03=-n;t.m04=r;t.m05=0;t.m06=0;t.m07=0;t.m08=1;return t};$.fromScaling=function(t,e){t.m00=e.x;t.m01=0;t.m02=0;t.m03=0;t.m04=e.y;t.m05=0;t.m06=0;t.m07=0;t.m08=1;return t};$.fromMat2d=function(t,e){t.m00=e.m00;t.m01=e.m01;t.m02=0;t.m03=e.m02;t.m04=e.m03;t.m05=0;t.m06=e.m04;t.m07=e.m05;t.m08=1;return t};$.fromQuat=function(t,e){let n=e.x,r=e.y,i=e.z,s=e.w;let a=n+n;let l=r+r;let o=i+i;let m=n*a;let h=r*a;let u=r*l;let c=i*a;let f=i*l;let _=i*o;let d=s*a;let p=s*l;let x=s*o;t.m00=1-u-_;t.m03=h-x;t.m06=c+p;t.m01=h+x;t.m04=1-m-_;t.m07=f-d;t.m02=c-p;t.m05=f+d;t.m08=1-m-u;return t};$.fromViewUp=function(){let t=q.new(0,1,0);let e=q.create();let r=q.create();return function(i,s,a){if(q.sqrLen(s)<n*n){$.identity(i);return i}a=a||t;q.cross(e,a,s);if(q.sqrLen(e)<n*n){$.identity(i);return i}q.cross(r,s,e);$.set(i,e.x,e.y,e.z,r.x,r.y,r.z,s.x,s.y,s.z);return i}}();$.normalFromMat4=function(t,e){let n=e.m00,r=e.m01,i=e.m02,s=e.m03,a=e.m04,l=e.m05,o=e.m06,m=e.m07,h=e.m08,u=e.m09,c=e.m10,f=e.m11,_=e.m12,d=e.m13,p=e.m14,x=e.m15;let g=n*l-r*a;let T=n*o-i*a;let E=n*m-s*a;let A=r*o-i*l;let M=r*m-s*l;let y=i*m-s*o;let S=h*d-u*_;let b=h*p-c*_;let R=h*x-f*_;let w=u*p-c*d;let v=u*x-f*d;let F=c*x-f*p;let P=g*F-T*v+E*w+A*R-M*b+y*S;if(!P){return null}P=1/P;t.m00=(l*F-o*v+m*w)*P;t.m01=(o*R-a*F-m*b)*P;t.m02=(a*v-l*R+m*S)*P;t.m03=(i*v-r*F-s*w)*P;t.m04=(n*F-i*R+s*b)*P;t.m05=(r*R-n*v-s*S)*P;t.m06=(d*y-p*M+x*A)*P;t.m07=(p*E-_*y-x*T)*P;t.m08=(_*M-d*E+x*g)*P;return t};$.str=function(t){return`mat3(${t.m00}, ${t.m01}, ${t.m02}, ${t.m03}, ${t.m04}, ${t.m05}, ${t.m06}, ${t.m07}, ${t.m08})`};$.array=function(t,e){t[0]=e.m00;t[1]=e.m01;t[2]=e.m02;t[3]=e.m03;t[4]=e.m04;t[5]=e.m05;t[6]=e.m06;t[7]=e.m07;t[8]=e.m08;return t};$.frob=function(t){return Math.sqrt(Math.pow(t.m00,2)+Math.pow(t.m01,2)+Math.pow(t.m02,2)+Math.pow(t.m03,2)+Math.pow(t.m04,2)+Math.pow(t.m05,2)+Math.pow(t.m06,2)+Math.pow(t.m07,2)+Math.pow(t.m08,2))};$.add=function(t,e,n){t.m00=e.m00+n.m00;t.m01=e.m01+n.m01;t.m02=e.m02+n.m02;t.m03=e.m03+n.m03;t.m04=e.m04+n.m04;t.m05=e.m05+n.m05;t.m06=e.m06+n.m06;t.m07=e.m07+n.m07;t.m08=e.m08+n.m08;return t};$.subtract=function(t,e,n){t.m00=e.m00-n.m00;t.m01=e.m01-n.m01;t.m02=e.m02-n.m02;t.m03=e.m03-n.m03;t.m04=e.m04-n.m04;t.m05=e.m05-n.m05;t.m06=e.m06-n.m06;t.m07=e.m07-n.m07;t.m08=e.m08-n.m08;return t};$.sub=$.subtract;$.multiplyScalar=function(t,e,n){t.m00=e.m00*n;t.m01=e.m01*n;t.m02=e.m02*n;t.m03=e.m03*n;t.m04=e.m04*n;t.m05=e.m05*n;t.m06=e.m06*n;t.m07=e.m07*n;t.m08=e.m08*n;return t};$.multiplyScalarAndAdd=function(t,e,n,r){t.m00=e.m00+n.m00*r;t.m01=e.m01+n.m01*r;t.m02=e.m02+n.m02*r;t.m03=e.m03+n.m03*r;t.m04=e.m04+n.m04*r;t.m05=e.m05+n.m05*r;t.m06=e.m06+n.m06*r;t.m07=e.m07+n.m07*r;t.m08=e.m08+n.m08*r;return t};$.exactEquals=function(t,e){return t.m00===e.m00&&t.m01===e.m01&&t.m02===e.m02&&t.m03===e.m03&&t.m04===e.m04&&t.m05===e.m05&&t.m06===e.m06&&t.m07===e.m07&&t.m08===e.m08};$.equals=function(t,e){let r=t.m00,i=t.m01,s=t.m02,a=t.m03,l=t.m04,o=t.m05,m=t.m06,h=t.m07,u=t.m08;let c=e.m00,f=e.m01,_=e.m02,d=e.m03,p=e.m04,x=e.m05,g=e.m06,T=e.m07,E=e.m08;return Math.abs(r-c)<=n*Math.max(1,Math.abs(r),Math.abs(c))&&Math.abs(i-f)<=n*Math.max(1,Math.abs(i),Math.abs(f))&&Math.abs(s-_)<=n*Math.max(1,Math.abs(s),Math.abs(_))&&Math.abs(a-d)<=n*Math.max(1,Math.abs(a),Math.abs(d))&&Math.abs(l-p)<=n*Math.max(1,Math.abs(l),Math.abs(p))&&Math.abs(o-x)<=n*Math.max(1,Math.abs(o),Math.abs(x))&&Math.abs(m-g)<=n*Math.max(1,Math.abs(m),Math.abs(g))&&Math.abs(h-T)<=n*Math.max(1,Math.abs(h),Math.abs(T))&&Math.abs(u-E)<=n*Math.max(1,Math.abs(u),Math.abs(E))};let Z=new Array(4);class j{constructor(t,e,n,r){this.x=t;this.y=e;this.z=n;this.w=r}toJSON(){Z[0]=this.x;Z[1]=this.y;Z[2]=this.z;Z[3]=this.w;return Z}}let K={};K.create=function(){return new j(0,0,0,1)};K.new=function(t,e,n,r){return new j(t,e,n,r)};K.clone=function(t){return new j(t.x,t.y,t.z,t.w)};K.copy=G.copy;K.set=G.set;K.identity=function(t){t.x=0;t.y=0;t.z=0;t.w=1;return t};K.rotationTo=function(){let t=q.create();let e=q.new(1,0,0);let n=q.new(0,1,0);return function(r,i,s){let a=q.dot(i,s);if(a<-.999999){q.cross(t,e,i);if(q.length(t)<1e-6){q.cross(t,n,i)}q.normalize(t,t);K.fromAxisAngle(r,t,Math.PI);return r}else if(a>.999999){r.x=0;r.y=0;r.z=0;r.w=1;return r}else{q.cross(t,i,s);r.x=t.x;r.y=t.y;r.z=t.z;r.w=1+a;return K.normalize(r,r)}}}();K.getAxisAngle=function(t,e){let n=Math.acos(e.w)*2;let r=Math.sin(n/2);if(r!=0){t.x=e.x/r;t.y=e.y/r;t.z=e.z/r}else{t.x=1;t.y=0;t.z=0}return n};K.multiply=function(t,e,n){let r=e.x,i=e.y,s=e.z,a=e.w,l=n.x,o=n.y,m=n.z,h=n.w;t.x=r*h+a*l+i*m-s*o;t.y=i*h+a*o+s*l-r*m;t.z=s*h+a*m+r*o-i*l;t.w=a*h-r*l-i*o-s*m;return t};K.mul=K.multiply;K.scale=G.scale;K.rotateX=function(t,e,n){n*=.5;let r=e.x,i=e.y,s=e.z,a=e.w,l=Math.sin(n),o=Math.cos(n);t.x=r*o+a*l;t.y=i*o+s*l;t.z=s*o-i*l;t.w=a*o-r*l;return t};K.rotateY=function(t,e,n){n*=.5;let r=e.x,i=e.y,s=e.z,a=e.w,l=Math.sin(n),o=Math.cos(n);t.x=r*o-s*l;t.y=i*o+a*l;t.z=s*o+r*l;t.w=a*o-i*l;return t};K.rotateZ=function(t,e,n){n*=.5;let r=e.x,i=e.y,s=e.z,a=e.w,l=Math.sin(n),o=Math.cos(n);t.x=r*o+i*l;t.y=i*o-r*l;t.z=s*o+a*l;t.w=a*o-s*l;return t};K.rotateAround=function(){let t=q.create();let e=K.create();return function(n,r,i,s){K.invert(e,r);q.transformQuat(t,i,e);K.fromAxisAngle(e,t,s);K.mul(n,r,e);return n}}();K.rotateAroundLocal=function(){let t=K.create();return function(e,n,r,i){K.fromAxisAngle(t,r,i);K.mul(e,n,t);return e}}();K.calculateW=function(t,e){let n=e.x,r=e.y,i=e.z;t.x=n;t.y=r;t.z=i;t.w=Math.sqrt(Math.abs(1-n*n-r*r-i*i));return t};K.dot=G.dot;K.lerp=G.lerp;K.slerp=function(t,e,n,r){let i=e.x,s=e.y,a=e.z,l=e.w,o=n.x,m=n.y,h=n.z,u=n.w;let c,f,_,d,p;f=i*o+s*m+a*h+l*u;if(f<0){f=-f;o=-o;m=-m;h=-h;u=-u}if(1-f>1e-6){c=Math.acos(f);_=Math.sin(c);d=Math.sin((1-r)*c)/_;p=Math.sin(r*c)/_}else{d=1-r;p=r}t.x=d*i+p*o;t.y=d*s+p*m;t.z=d*a+p*h;t.w=d*l+p*u;return t};K.sqlerp=function(){let t=K.create();let e=K.create();return function(n,r,i,s,a,l){K.slerp(t,r,a,l);K.slerp(e,i,s,l);K.slerp(n,t,e,2*l*(1-l));return n}}();K.invert=function(t,e){let n=e.x,r=e.y,i=e.z,s=e.w;let a=n*n+r*r+i*i+s*s;let l=a?1/a:0;t.x=-n*l;t.y=-r*l;t.z=-i*l;t.w=s*l;return t};K.conjugate=function(t,e){t.x=-e.x;t.y=-e.y;t.z=-e.z;t.w=e.w;return t};K.length=G.length;K.len=K.length;K.squaredLength=G.squaredLength;K.sqrLen=K.squaredLength;K.normalize=G.normalize;K.fromAxes=function(){let t=$.create();return function(e,n,r,i){$.set(t,n.x,n.y,n.z,r.x,r.y,r.z,i.x,i.y,i.z);return K.normalize(e,K.fromMat3(e,t))}}();K.fromViewUp=function(){let t=$.create();return function(e,n,r){$.fromViewUp(t,n,r);if(!t){return null}return K.normalize(e,K.fromMat3(e,t))}}();K.fromAxisAngle=function(t,e,n){n=n*.5;let r=Math.sin(n);t.x=r*e.x;t.y=r*e.y;t.z=r*e.z;t.w=Math.cos(n);return t};K.fromMat3=function(t,e){let n=e.m00,r=e.m03,i=e.m06,s=e.m01,a=e.m04,l=e.m07,o=e.m02,m=e.m05,h=e.m08;let u=n+a+h;if(u>0){let e=.5/Math.sqrt(u+1);t.w=.25/e;t.x=(m-l)*e;t.y=(i-o)*e;t.z=(s-r)*e}else if(n>a&&n>h){let e=2*Math.sqrt(1+n-a-h);t.w=(m-l)/e;t.x=.25*e;t.y=(r+s)/e;t.z=(i+o)/e}else if(a>h){let e=2*Math.sqrt(1+a-n-h);t.w=(i-o)/e;t.x=(r+s)/e;t.y=.25*e;t.z=(l+m)/e}else{let e=2*Math.sqrt(1+h-n-a);t.w=(s-r)/e;t.x=(i+o)/e;t.y=(l+m)/e;t.z=.25*e}return t};K.fromEuler=function(t,e,n,r){let i=.5*Math.PI/180;e*=i;n*=i;r*=i;let s=Math.sin(e);let a=Math.cos(e);let l=Math.sin(n);let o=Math.cos(n);let m=Math.sin(r);let h=Math.cos(r);t.x=s*o*h-a*l*m;t.y=a*l*h+s*o*m;t.z=a*o*m-s*l*h;t.w=a*o*h+s*l*m;return t};K.str=function(t){return`quat(${t.x}, ${t.y}, ${t.z}, ${t.w})`};K.array=function(t,e){t[0]=e.x;t[1]=e.y;t[2]=e.z;t[3]=e.w;return t};K.exactEquals=G.exactEquals;K.equals=G.equals;let J=new Array(4);class Q{constructor(t,e,n,r){this.m00=t;this.m01=e;this.m02=n;this.m03=r}toJSON(){J[0]=this.m00;J[1]=this.m01;J[2]=this.m02;J[3]=this.m03;return J}}let tt={};tt.create=function(){return new Q(1,0,0,1)};tt.new=function(t,e,n,r){return new Q(t,e,n,r)};tt.clone=function(t){return new Q(t.m00,t.m01,t.m02,t.m03)};tt.copy=function(t,e){t.m00=e.m00;t.m01=e.m01;t.m02=e.m02;t.m03=e.m03;return t};tt.identity=function(t){t.m00=1;t.m01=0;t.m02=0;t.m03=1;return t};tt.set=function(t,e,n,r,i){t.m00=e;t.m01=n;t.m02=r;t.m03=i;return t};tt.transpose=function(t,e){if(t===e){let n=e.m01;t.m01=e.m02;t.m02=n}else{t.m00=e.m00;t.m01=e.m02;t.m02=e.m01;t.m03=e.m03}return t};tt.invert=function(t,e){let n=e.m00,r=e.m01,i=e.m02,s=e.m03;let a=n*s-i*r;if(!a){return null}a=1/a;t.m00=s*a;t.m01=-r*a;t.m02=-i*a;t.m03=n*a;return t};tt.adjoint=function(t,e){let n=e.m00;t.m00=e.m03;t.m01=-e.m01;t.m02=-e.m02;t.m03=n;return t};tt.determinant=function(t){return t.m00*t.m03-t.m02*t.m01};tt.multiply=function(t,e,n){let r=e.m00,i=e.m01,s=e.m02,a=e.m03;let l=n.m00,o=n.m01,m=n.m02,h=n.m03;t.m00=r*l+s*o;t.m01=i*l+a*o;t.m02=r*m+s*h;t.m03=i*m+a*h;return t};tt.mul=tt.multiply;tt.rotate=function(t,e,n){let r=e.m00,i=e.m01,s=e.m02,a=e.m03,l=Math.sin(n),o=Math.cos(n);t.m00=r*o+s*l;t.m01=i*o+a*l;t.m02=r*-l+s*o;t.m03=i*-l+a*o;return t};tt.scale=function(t,e,n){let r=e.m00,i=e.m01,s=e.m02,a=e.m03,l=n.x,o=n.y;t.m00=r*l;t.m01=i*l;t.m02=s*o;t.m03=a*o;return t};tt.fromRotation=function(t,e){let n=Math.sin(e),r=Math.cos(e);t.m00=r;t.m01=n;t.m02=-n;t.m03=r;return t};tt.fromScaling=function(t,e){t.m00=e.x;t.m01=0;t.m02=0;t.m03=e.y;return t};tt.str=function(t){return`mat2(${t.m00}, ${t.m01}, ${t.m02}, ${t.m03})`};tt.array=function(t,e){t[0]=e.m00;t[1]=e.m01;t[2]=e.m02;t[3]=e.m03;return t};tt.frob=function(t){return Math.sqrt(Math.pow(t.m00,2)+Math.pow(t.m01,2)+Math.pow(t.m02,2)+Math.pow(t.m03,2))};tt.LDU=function(t,e,n,r){t.m02=r.m02/r.m00;n.m00=r.m00;n.m01=r.m01;n.m03=r.m03-t.m02*n.m01};tt.add=function(t,e,n){t.m00=e.m00+n.m00;t.m01=e.m01+n.m01;t.m02=e.m02+n.m02;t.m03=e.m03+n.m03;return t};tt.subtract=function(t,e,n){t.m00=e.m00-n.m00;t.m01=e.m01-n.m01;t.m02=e.m02-n.m02;t.m03=e.m03-n.m03;return t};tt.sub=tt.subtract;tt.exactEquals=function(t,e){return t.m00===e.m00&&t.m01===e.m01&&t.m02===e.m02&&t.m03===e.m03};tt.equals=function(t,e){let r=t.m00,i=t.m01,s=t.m02,a=t.m03;let l=e.m00,o=e.m01,m=e.m02,h=e.m03;return Math.abs(r-l)<=n*Math.max(1,Math.abs(r),Math.abs(l))&&Math.abs(i-o)<=n*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(s-m)<=n*Math.max(1,Math.abs(s),Math.abs(m))&&Math.abs(a-h)<=n*Math.max(1,Math.abs(a),Math.abs(h))};tt.multiplyScalar=function(t,e,n){t.m00=e.m00*n;t.m01=e.m01*n;t.m02=e.m02*n;t.m03=e.m03*n;return t};tt.multiplyScalarAndAdd=function(t,e,n,r){t.m00=e.m00+n.m00*r;t.m01=e.m01+n.m01*r;t.m02=e.m02+n.m02*r;t.m03=e.m03+n.m03*r;return t};let et=new Array(6);class nt{constructor(t,e,n,r,i,s){this.m00=t;this.m01=e;this.m02=n;this.m03=r;this.m04=i;this.m05=s}toJSON(){et[0]=this.m00;et[1]=this.m01;et[2]=this.m02;et[3]=this.m03;et[4]=this.m04;et[5]=this.m05;return et}}let rt={};rt.create=function(){return new nt(1,0,0,1,0,0)};rt.new=function(t,e,n,r,i,s){return new nt(t,e,n,r,i,s)};rt.clone=function(t){return new nt(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05)};rt.copy=function(t,e){t.m00=e.m00;t.m01=e.m01;t.m02=e.m02;t.m03=e.m03;t.m04=e.m04;t.m05=e.m05;return t};rt.identity=function(t){t.m00=1;t.m01=0;t.m02=0;t.m03=1;t.m04=0;t.m05=0;return t};rt.set=function(t,e,n,r,i,s,a){t.m00=e;t.m01=n;t.m02=r;t.m03=i;t.m04=s;t.m05=a;return t};rt.invert=function(t,e){let n=e.m00,r=e.m01,i=e.m02,s=e.m03,a=e.m04,l=e.m05;let o=n*s-r*i;if(!o){return null}o=1/o;t.m00=s*o;t.m01=-r*o;t.m02=-i*o;t.m03=n*o;t.m04=(i*l-s*a)*o;t.m05=(r*a-n*l)*o;return t};rt.determinant=function(t){return t.m00*t.m03-t.m01*t.m02};rt.multiply=function(t,e,n){let r=e.m00,i=e.m01,s=e.m02,a=e.m03,l=e.m04,o=e.m05,m=n.m00,h=n.m01,u=n.m02,c=n.m03,f=n.m04,_=n.m05;t.m00=r*m+s*h;t.m01=i*m+a*h;t.m02=r*u+s*c;t.m03=i*u+a*c;t.m04=r*f+s*_+l;t.m05=i*f+a*_+o;return t};rt.mul=rt.multiply;rt.rotate=function(t,e,n){let r=e.m00,i=e.m01,s=e.m02,a=e.m03,l=e.m04,o=e.m05,m=Math.sin(n),h=Math.cos(n);t.m00=r*h+s*m;t.m01=i*h+a*m;t.m02=r*-m+s*h;t.m03=i*-m+a*h;t.m04=l;t.m05=o;return t};rt.scale=function(t,e,n){let r=e.m00,i=e.m01,s=e.m02,a=e.m03,l=e.m04,o=e.m05,m=n.x,h=n.y;t.m00=r*m;t.m01=i*m;t.m02=s*h;t.m03=a*h;t.m04=l;t.m05=o;return t};rt.translate=function(t,e,n){let r=e.m00,i=e.m01,s=e.m02,a=e.m03,l=e.m04,o=e.m05,m=n.x,h=n.y;t.m00=r;t.m01=i;t.m02=s;t.m03=a;t.m04=r*m+s*h+l;t.m05=i*m+a*h+o;return t};rt.fromRotation=function(t,e){let n=Math.sin(e),r=Math.cos(e);t.m00=r;t.m01=n;t.m02=-n;t.m03=r;t.m04=0;t.m05=0;return t};rt.fromScaling=function(t,e){t.m00=e.m00;t.m01=0;t.m02=0;t.m03=e.m01;t.m04=0;t.m05=0;return t};rt.fromTranslation=function(t,e){t.m00=1;t.m01=0;t.m02=0;t.m03=1;t.m04=e.x;t.m05=e.y;return t};rt.str=function(t){return`mat23(${t.m00}, ${t.m01}, ${t.m02}, ${t.m03}, ${t.m04}, ${t.m05})`};rt.array=function(t,e){t[0]=e.m00;t[1]=e.m01;t[2]=e.m02;t[3]=e.m03;t[4]=e.m04;t[5]=e.m05;return t};rt.array4x4=function(t,e){t[0]=e.m00;t[1]=e.m01;t[2]=0;t[3]=0;t[4]=e.m02;t[5]=e.m03;t[6]=0;t[7]=0;t[8]=0;t[9]=0;t[10]=1;t[11]=0;t[12]=e.m04;t[13]=e.m05;t[14]=0;t[15]=1;return t};rt.frob=function(t){return Math.sqrt(Math.pow(t.m00,2)+Math.pow(t.m01,2)+Math.pow(t.m02,2)+Math.pow(t.m03,2)+Math.pow(t.m04,2)+Math.pow(t.m05,2)+1)};rt.add=function(t,e,n){t.m00=e.m00+n.m00;t.m01=e.m01+n.m01;t.m02=e.m02+n.m02;t.m03=e.m03+n.m03;t.m04=e.m04+n.m04;t.m05=e.m05+n.m05;return t};rt.subtract=function(t,e,n){t.m00=e.m00-n.m00;t.m01=e.m01-n.m01;t.m02=e.m02-n.m02;t.m03=e.m03-n.m03;t.m04=e.m04-n.m04;t.m05=e.m05-n.m05;return t};rt.sub=rt.subtract;rt.multiplyScalar=function(t,e,n){t.m00=e.m00*n;t.m01=e.m01*n;t.m02=e.m02*n;t.m03=e.m03*n;t.m04=e.m04*n;t.m05=e.m05*n;return t};rt.multiplyScalarAndAdd=function(t,e,n,r){t.m00=e.m00+n.m00*r;t.m01=e.m01+n.m01*r;t.m02=e.m02+n.m02*r;t.m03=e.m03+n.m03*r;t.m04=e.m04+n.m04*r;t.m05=e.m05+n.m05*r;return t};rt.exactEquals=function(t,e){return t.m00===e.m00&&t.m01===e.m01&&t.m02===e.m02&&t.m03===e.m03&&t.m04===e.m04&&t.m05===e.m05};rt.equals=function(t,e){let r=t.m00,i=t.m01,s=t.m02,a=t.m03,l=t.m04,o=t.m05;let m=e.m00,h=e.m01,u=e.m02,c=e.m03,f=e.m04,_=e.m05;return Math.abs(r-m)<=n*Math.max(1,Math.abs(r),Math.abs(m))&&Math.abs(i-h)<=n*Math.max(1,Math.abs(i),Math.abs(h))&&Math.abs(s-u)<=n*Math.max(1,Math.abs(s),Math.abs(u))&&Math.abs(a-c)<=n*Math.max(1,Math.abs(a),Math.abs(c))&&Math.abs(l-f)<=n*Math.max(1,Math.abs(l),Math.abs(f))&&Math.abs(o-_)<=n*Math.max(1,Math.abs(o),Math.abs(_))};let it=new Array(16);class st{constructor(t,e,n,r,i,s,a,l,o,m,h,u,c,f,_,d){this.m00=t;this.m01=e;this.m02=n;this.m03=r;this.m04=i;this.m05=s;this.m06=a;this.m07=l;this.m08=o;this.m09=m;this.m10=h;this.m11=u;this.m12=c;this.m13=f;this.m14=_;this.m15=d}toJSON(){it[0]=this.m00;it[1]=this.m01;it[2]=this.m02;it[3]=this.m03;it[4]=this.m04;it[5]=this.m05;it[6]=this.m06;it[7]=this.m07;it[8]=this.m08;it[9]=this.m09;it[10]=this.m10;it[11]=this.m11;it[12]=this.m12;it[13]=this.m13;it[14]=this.m14;it[15]=this.m15;return it}}let at={};at.create=function(){return new st(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)};at.new=function(t,e,n,r,i,s,a,l,o,m,h,u,c,f,_,d){return new st(t,e,n,r,i,s,a,l,o,m,h,u,c,f,_,d)};at.clone=function(t){return new st(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08,t.m09,t.m10,t.m11,t.m12,t.m13,t.m14,t.m15)};at.copy=function(t,e){t.m00=e.m00;t.m01=e.m01;t.m02=e.m02;t.m03=e.m03;t.m04=e.m04;t.m05=e.m05;t.m06=e.m06;t.m07=e.m07;t.m08=e.m08;t.m09=e.m09;t.m10=e.m10;t.m11=e.m11;t.m12=e.m12;t.m13=e.m13;t.m14=e.m14;t.m15=e.m15;return t};at.set=function(t,e,n,r,i,s,a,l,o,m,h,u,c,f,_,d,p){t.m00=e;t.m01=n;t.m02=r;t.m03=i;t.m04=s;t.m05=a;t.m06=l;t.m07=o;t.m08=m;t.m09=h;t.m10=u;t.m11=c;t.m12=f;t.m13=_;t.m14=d;t.m15=p;return t};at.identity=function(t){t.m00=1;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=1;t.m06=0;t.m07=0;t.m08=0;t.m09=0;t.m10=1;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};at.transpose=function(t,e){if(t===e){let n=e.m01,r=e.m02,i=e.m03,s=e.m06,a=e.m07,l=e.m11;t.m01=e.m04;t.m02=e.m08;t.m03=e.m12;t.m04=n;t.m06=e.m09;t.m07=e.m13;t.m08=r;t.m09=s;t.m11=e.m14;t.m12=i;t.m13=a;t.m14=l}else{t.m00=e.m00;t.m01=e.m04;t.m02=e.m08;t.m03=e.m12;t.m04=e.m01;t.m05=e.m05;t.m06=e.m09;t.m07=e.m13;t.m08=e.m02;t.m09=e.m06;t.m10=e.m10;t.m11=e.m14;t.m12=e.m03;t.m13=e.m07;t.m14=e.m11;t.m15=e.m15}return t};at.invert=function(t,e){let n=e.m00,r=e.m01,i=e.m02,s=e.m03,a=e.m04,l=e.m05,o=e.m06,m=e.m07,h=e.m08,u=e.m09,c=e.m10,f=e.m11,_=e.m12,d=e.m13,p=e.m14,x=e.m15;let g=n*l-r*a;let T=n*o-i*a;let E=n*m-s*a;let A=r*o-i*l;let M=r*m-s*l;let y=i*m-s*o;let S=h*d-u*_;let b=h*p-c*_;let R=h*x-f*_;let w=u*p-c*d;let v=u*x-f*d;let F=c*x-f*p;let P=g*F-T*v+E*w+A*R-M*b+y*S;if(!P){return null}P=1/P;t.m00=(l*F-o*v+m*w)*P;t.m01=(i*v-r*F-s*w)*P;t.m02=(d*y-p*M+x*A)*P;t.m03=(c*M-u*y-f*A)*P;t.m04=(o*R-a*F-m*b)*P;t.m05=(n*F-i*R+s*b)*P;t.m06=(p*E-_*y-x*T)*P;t.m07=(h*y-c*E+f*T)*P;t.m08=(a*v-l*R+m*S)*P;t.m09=(r*R-n*v-s*S)*P;t.m10=(_*M-d*E+x*g)*P;t.m11=(u*E-h*M-f*g)*P;t.m12=(l*b-a*w-o*S)*P;t.m13=(n*w-r*b+i*S)*P;t.m14=(d*T-_*A-p*g)*P;t.m15=(h*A-u*T+c*g)*P;return t};at.adjoint=function(t,e){let n=e.m00,r=e.m01,i=e.m02,s=e.m03,a=e.m04,l=e.m05,o=e.m06,m=e.m07,h=e.m08,u=e.m09,c=e.m10,f=e.m11,_=e.m12,d=e.m13,p=e.m14,x=e.m15;t.m00=l*(c*x-f*p)-u*(o*x-m*p)+d*(o*f-m*c);t.m01=-(r*(c*x-f*p)-u*(i*x-s*p)+d*(i*f-s*c));t.m02=r*(o*x-m*p)-l*(i*x-s*p)+d*(i*m-s*o);t.m03=-(r*(o*f-m*c)-l*(i*f-s*c)+u*(i*m-s*o));t.m04=-(a*(c*x-f*p)-h*(o*x-m*p)+_*(o*f-m*c));t.m05=n*(c*x-f*p)-h*(i*x-s*p)+_*(i*f-s*c);t.m06=-(n*(o*x-m*p)-a*(i*x-s*p)+_*(i*m-s*o));t.m07=n*(o*f-m*c)-a*(i*f-s*c)+h*(i*m-s*o);t.m08=a*(u*x-f*d)-h*(l*x-m*d)+_*(l*f-m*u);t.m09=-(n*(u*x-f*d)-h*(r*x-s*d)+_*(r*f-s*u));t.m10=n*(l*x-m*d)-a*(r*x-s*d)+_*(r*m-s*l);t.m11=-(n*(l*f-m*u)-a*(r*f-s*u)+h*(r*m-s*l));t.m12=-(a*(u*p-c*d)-h*(l*p-o*d)+_*(l*c-o*u));t.m13=n*(u*p-c*d)-h*(r*p-i*d)+_*(r*c-i*u);t.m14=-(n*(l*p-o*d)-a*(r*p-i*d)+_*(r*o-i*l));t.m15=n*(l*c-o*u)-a*(r*c-i*u)+h*(r*o-i*l);return t};at.determinant=function(t){let e=t.m00,n=t.m01,r=t.m02,i=t.m03,s=t.m04,a=t.m05,l=t.m06,o=t.m07,m=t.m08,h=t.m09,u=t.m10,c=t.m11,f=t.m12,_=t.m13,d=t.m14,p=t.m15;let x=e*a-n*s;let g=e*l-r*s;let T=e*o-i*s;let E=n*l-r*a;let A=n*o-i*a;let M=r*o-i*l;let y=m*_-h*f;let S=m*d-u*f;let b=m*p-c*f;let R=h*d-u*_;let w=h*p-c*_;let v=u*p-c*d;return x*v-g*w+T*R+E*b-A*S+M*y};at.multiply=function(t,e,n){let r=e.m00,i=e.m01,s=e.m02,a=e.m03,l=e.m04,o=e.m05,m=e.m06,h=e.m07,u=e.m08,c=e.m09,f=e.m10,_=e.m11,d=e.m12,p=e.m13,x=e.m14,g=e.m15;let T=n.m00,E=n.m01,A=n.m02,M=n.m03;t.m00=T*r+E*l+A*u+M*d;t.m01=T*i+E*o+A*c+M*p;t.m02=T*s+E*m+A*f+M*x;t.m03=T*a+E*h+A*_+M*g;T=n.m04;E=n.m05;A=n.m06;M=n.m07;t.m04=T*r+E*l+A*u+M*d;t.m05=T*i+E*o+A*c+M*p;t.m06=T*s+E*m+A*f+M*x;t.m07=T*a+E*h+A*_+M*g;T=n.m08;E=n.m09;A=n.m10;M=n.m11;t.m08=T*r+E*l+A*u+M*d;t.m09=T*i+E*o+A*c+M*p;t.m10=T*s+E*m+A*f+M*x;t.m11=T*a+E*h+A*_+M*g;T=n.m12;E=n.m13;A=n.m14;M=n.m15;t.m12=T*r+E*l+A*u+M*d;t.m13=T*i+E*o+A*c+M*p;t.m14=T*s+E*m+A*f+M*x;t.m15=T*a+E*h+A*_+M*g;return t};at.mul=at.multiply;at.translate=function(t,e,n){let r=n.x,i=n.y,s=n.z,a,l,o,m,h,u,c,f,_,d,p,x;if(e===t){t.m12=e.m00*r+e.m04*i+e.m08*s+e.m12;t.m13=e.m01*r+e.m05*i+e.m09*s+e.m13;t.m14=e.m02*r+e.m06*i+e.m10*s+e.m14;t.m15=e.m03*r+e.m07*i+e.m11*s+e.m15}else{a=e.m00;l=e.m01;o=e.m02;m=e.m03;h=e.m04;u=e.m05;c=e.m06;f=e.m07;_=e.m08;d=e.m09;p=e.m10;x=e.m11;t.m00=a;t.m01=l;t.m02=o;t.m03=m;t.m04=h;t.m05=u;t.m06=c;t.m07=f;t.m08=_;t.m09=d;t.m10=p;t.m11=x;t.m12=a*r+h*i+_*s+e.m12;t.m13=l*r+u*i+d*s+e.m13;t.m14=o*r+c*i+p*s+e.m14;t.m15=m*r+f*i+x*s+e.m15}return t};at.scale=function(t,e,n){let r=n.x,i=n.y,s=n.z;t.m00=e.m00*r;t.m01=e.m01*r;t.m02=e.m02*r;t.m03=e.m03*r;t.m04=e.m04*i;t.m05=e.m05*i;t.m06=e.m06*i;t.m07=e.m07*i;t.m08=e.m08*s;t.m09=e.m09*s;t.m10=e.m10*s;t.m11=e.m11*s;t.m12=e.m12;t.m13=e.m13;t.m14=e.m14;t.m15=e.m15;return t};at.rotate=function(t,e,r,i){let s=i.x,a=i.y,l=i.z;let o,m,h,u,c,f,_,d,p,x,g,T,E,A,M,y,S,b,R,w,v,F,P,L;let I=Math.sqrt(s*s+a*a+l*l);if(Math.abs(I)<n){return null}I=1/I;s*=I;a*=I;l*=I;o=Math.sin(r);m=Math.cos(r);h=1-m;u=e.m00;c=e.m01;f=e.m02;_=e.m03;d=e.m04;p=e.m05;x=e.m06;g=e.m07;T=e.m08;E=e.m09;A=e.m10;M=e.m11;y=s*s*h+m;S=a*s*h+l*o;b=l*s*h-a*o;R=s*a*h-l*o;w=a*a*h+m;v=l*a*h+s*o;F=s*l*h+a*o;P=a*l*h-s*o;L=l*l*h+m;t.m00=u*y+d*S+T*b;t.m01=c*y+p*S+E*b;t.m02=f*y+x*S+A*b;t.m03=_*y+g*S+M*b;t.m04=u*R+d*w+T*v;t.m05=c*R+p*w+E*v;t.m06=f*R+x*w+A*v;t.m07=_*R+g*w+M*v;t.m08=u*F+d*P+T*L;t.m09=c*F+p*P+E*L;t.m10=f*F+x*P+A*L;t.m11=_*F+g*P+M*L;if(e!==t){t.m12=e.m12;t.m13=e.m13;t.m14=e.m14;t.m15=e.m15}return t};at.rotateX=function(t,e,n){let r=Math.sin(n),i=Math.cos(n),s=e.m04,a=e.m05,l=e.m06,o=e.m07,m=e.m08,h=e.m09,u=e.m10,c=e.m11;if(e!==t){t.m00=e.m00;t.m01=e.m01;t.m02=e.m02;t.m03=e.m03;t.m12=e.m12;t.m13=e.m13;t.m14=e.m14;t.m15=e.m15}t.m04=s*i+m*r;t.m05=a*i+h*r;t.m06=l*i+u*r;t.m07=o*i+c*r;t.m08=m*i-s*r;t.m09=h*i-a*r;t.m10=u*i-l*r;t.m11=c*i-o*r;return t};at.rotateY=function(t,e,n){let r=Math.sin(n),i=Math.cos(n),s=e.m00,a=e.m01,l=e.m02,o=e.m03,m=e.m08,h=e.m09,u=e.m10,c=e.m11;if(e!==t){t.m04=e.m04;t.m05=e.m05;t.m06=e.m06;t.m07=e.m07;t.m12=e.m12;t.m13=e.m13;t.m14=e.m14;t.m15=e.m15}t.m00=s*i-m*r;t.m01=a*i-h*r;t.m02=l*i-u*r;t.m03=o*i-c*r;t.m08=s*r+m*i;t.m09=a*r+h*i;t.m10=l*r+u*i;t.m11=o*r+c*i;return t};at.rotateZ=function(t,e,n){let r=Math.sin(n),i=Math.cos(n),s=e.m00,a=e.m01,l=e.m02,o=e.m03,m=e.m04,h=e.m05,u=e.m06,c=e.m07;if(e!==t){t.m08=e.m08;t.m09=e.m09;t.m10=e.m10;t.m11=e.m11;t.m12=e.m12;t.m13=e.m13;t.m14=e.m14;t.m15=e.m15}t.m00=s*i+m*r;t.m01=a*i+h*r;t.m02=l*i+u*r;t.m03=o*i+c*r;t.m04=m*i-s*r;t.m05=h*i-a*r;t.m06=u*i-l*r;t.m07=c*i-o*r;return t};at.fromTranslation=function(t,e){t.m00=1;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=1;t.m06=0;t.m07=0;t.m08=0;t.m09=0;t.m10=1;t.m11=0;t.m12=e.x;t.m13=e.y;t.m14=e.z;t.m15=1;return t};at.fromScaling=function(t,e){t.m00=e.x;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=e.y;t.m06=0;t.m07=0;t.m08=0;t.m09=0;t.m10=e.z;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};at.fromRotation=function(t,e,r){let i=r.x,s=r.y,a=r.z;let l=Math.sqrt(i*i+s*s+a*a);let o,m,h;if(Math.abs(l)<n){return null}l=1/l;i*=l;s*=l;a*=l;o=Math.sin(e);m=Math.cos(e);h=1-m;t.m00=i*i*h+m;t.m01=s*i*h+a*o;t.m02=a*i*h-s*o;t.m03=0;t.m04=i*s*h-a*o;t.m05=s*s*h+m;t.m06=a*s*h+i*o;t.m07=0;t.m08=i*a*h+s*o;t.m09=s*a*h-i*o;t.m10=a*a*h+m;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};at.fromXRotation=function(t,e){let n=Math.sin(e),r=Math.cos(e);t.m00=1;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=r;t.m06=n;t.m07=0;t.m08=0;t.m09=-n;t.m10=r;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};at.fromYRotation=function(t,e){let n=Math.sin(e),r=Math.cos(e);t.m00=r;t.m01=0;t.m02=-n;t.m03=0;t.m04=0;t.m05=1;t.m06=0;t.m07=0;t.m08=n;t.m09=0;t.m10=r;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};at.fromZRotation=function(t,e){let n=Math.sin(e),r=Math.cos(e);t.m00=r;t.m01=n;t.m02=0;t.m03=0;t.m04=-n;t.m05=r;t.m06=0;t.m07=0;t.m08=0;t.m09=0;t.m10=1;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};at.fromRT=function(t,e,n){let r=e.x,i=e.y,s=e.z,a=e.w;let l=r+r;let o=i+i;let m=s+s;let h=r*l;let u=r*o;let c=r*m;let f=i*o;let _=i*m;let d=s*m;let p=a*l;let x=a*o;let g=a*m;t.m00=1-(f+d);t.m01=u+g;t.m02=c-x;t.m03=0;t.m04=u-g;t.m05=1-(h+d);t.m06=_+p;t.m07=0;t.m08=c+x;t.m09=_-p;t.m10=1-(h+f);t.m11=0;t.m12=n.x;t.m13=n.y;t.m14=n.z;t.m15=1;return t};at.getTranslation=function(t,e){t.x=e.m12;t.y=e.m13;t.z=e.m14;return t};at.getScaling=function(t,e){let n=e.m00,r=e.m01,i=e.m02,s=e.m04,a=e.m05,l=e.m06,o=e.m08,m=e.m09,h=e.m10;t.x=Math.sqrt(n*n+r*r+i*i);t.y=Math.sqrt(s*s+a*a+l*l);t.z=Math.sqrt(o*o+m*m+h*h);return t};at.getRotation=function(t,e){let n=e.m00+e.m05+e.m10;let r=0;if(n>0){r=Math.sqrt(n+1)*2;t.w=.25*r;t.x=(e.m06-e.m09)/r;t.y=(e.m08-e.m02)/r;t.z=(e.m01-e.m04)/r}else if(e.m00>e.m05&e.m00>e.m10){r=Math.sqrt(1+e.m00-e.m05-e.m10)*2;t.w=(e.m06-e.m09)/r;t.x=.25*r;t.y=(e.m01+e.m04)/r;t.z=(e.m08+e.m02)/r}else if(e.m05>e.m10){r=Math.sqrt(1+e.m05-e.m00-e.m10)*2;t.w=(e.m08-e.m02)/r;t.x=(e.m01+e.m04)/r;t.y=.25*r;t.z=(e.m06+e.m09)/r}else{r=Math.sqrt(1+e.m10-e.m00-e.m05)*2;t.w=(e.m01-e.m04)/r;t.x=(e.m08+e.m02)/r;t.y=(e.m06+e.m09)/r;t.z=.25*r}return t};at.fromRTS=function(t,e,n,r){let i=e.x,s=e.y,a=e.z,l=e.w;let o=i+i;let m=s+s;let h=a+a;let u=i*o;let c=i*m;let f=i*h;let _=s*m;let d=s*h;let p=a*h;let x=l*o;let g=l*m;let T=l*h;let E=r.x;let A=r.y;let M=r.z;t.m00=(1-(_+p))*E;t.m01=(c+T)*E;t.m02=(f-g)*E;t.m03=0;t.m04=(c-T)*A;t.m05=(1-(u+p))*A;t.m06=(d+x)*A;t.m07=0;t.m08=(f+g)*M;t.m09=(d-x)*M;t.m10=(1-(u+_))*M;t.m11=0;t.m12=n.x;t.m13=n.y;t.m14=n.z;t.m15=1;return t};at.fromRTSOrigin=function(t,e,n,r,i){let s=e.x,a=e.y,l=e.z,o=e.w;let m=s+s;let h=a+a;let u=l+l;let c=s*m;let f=s*h;let _=s*u;let d=a*h;let p=a*u;let x=l*u;let g=o*m;let T=o*h;let E=o*u;let A=r.x;let M=r.y;let y=r.z;let S=i.x;let b=i.y;let R=i.z;t.m00=(1-(d+x))*A;t.m01=(f+E)*A;t.m02=(_-T)*A;t.m03=0;t.m04=(f-E)*M;t.m05=(1-(c+x))*M;t.m06=(p+g)*M;t.m07=0;t.m08=(_+T)*y;t.m09=(p-g)*y;t.m10=(1-(c+d))*y;t.m11=0;t.m12=n.x+S-(t.m00*S+t.m04*b+t.m08*R);t.m13=n.y+b-(t.m01*S+t.m05*b+t.m09*R);t.m14=n.z+R-(t.m02*S+t.m06*b+t.m10*R);t.m15=1;return t};at.fromQuat=function(t,e){let n=e.x,r=e.y,i=e.z,s=e.w;let a=n+n;let l=r+r;let o=i+i;let m=n*a;let h=r*a;let u=r*l;let c=i*a;let f=i*l;let _=i*o;let d=s*a;let p=s*l;let x=s*o;t.m00=1-u-_;t.m01=h+x;t.m02=c-p;t.m03=0;t.m04=h-x;t.m05=1-m-_;t.m06=f+d;t.m07=0;t.m08=c+p;t.m09=f-d;t.m10=1-m-u;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};at.frustum=function(t,e,n,r,i,s,a){let l=1/(n-e);let o=1/(i-r);let m=1/(s-a);t.m00=s*2*l;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=s*2*o;t.m06=0;t.m07=0;t.m08=(n+e)*l;t.m09=(i+r)*o;t.m10=(a+s)*m;t.m11=-1;t.m12=0;t.m13=0;t.m14=a*s*2*m;t.m15=0;return t};at.perspective=function(t,e,n,r,i){let s=1/Math.tan(e/2);let a=1/(r-i);t.m00=s/n;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=s;t.m06=0;t.m07=0;t.m08=0;t.m09=0;t.m10=(i+r)*a;t.m11=-1;t.m12=0;t.m13=0;t.m14=2*i*r*a;t.m15=0;return t};at.perspectiveFromFieldOfView=function(t,e,n,r){let i=Math.tan(e.upDegrees*Math.PI/180);let s=Math.tan(e.downDegrees*Math.PI/180);let a=Math.tan(e.leftDegrees*Math.PI/180);let l=Math.tan(e.rightDegrees*Math.PI/180);let o=2/(a+l);let m=2/(i+s);t.m00=o;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=m;t.m06=0;t.m07=0;t.m08=-((a-l)*o*.5);t.m09=(i-s)*m*.5;t.m10=r/(n-r);t.m11=-1;t.m12=0;t.m13=0;t.m14=r*n/(n-r);t.m15=0;return t};at.ortho=function(t,e,n,r,i,s,a){let l=1/(e-n);let o=1/(r-i);let m=1/(s-a);t.m00=-2*l;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=-2*o;t.m06=0;t.m07=0;t.m08=0;t.m09=0;t.m10=2*m;t.m11=0;t.m12=(e+n)*l;t.m13=(i+r)*o;t.m14=(a+s)*m;t.m15=1;return t};at.lookAt=function(t,e,r,i){let s,a,l,o,m,h,u,c,f,_;let d=e.x;let p=e.y;let x=e.z;let g=i.x;let T=i.y;let E=i.z;let A=r.x;let M=r.y;let y=r.z;if(Math.abs(d-A)<n&&Math.abs(p-M)<n&&Math.abs(x-y)<n){return at.identity(t)}u=d-A;c=p-M;f=x-y;_=1/Math.sqrt(u*u+c*c+f*f);u*=_;c*=_;f*=_;s=T*f-E*c;a=E*u-g*f;l=g*c-T*u;_=Math.sqrt(s*s+a*a+l*l);if(!_){s=0;a=0;l=0}else{_=1/_;s*=_;a*=_;l*=_}o=c*l-f*a;m=f*s-u*l;h=u*a-c*s;_=Math.sqrt(o*o+m*m+h*h);if(!_){o=0;m=0;h=0}else{_=1/_;o*=_;m*=_;h*=_}t.m00=s;t.m01=o;t.m02=u;t.m03=0;t.m04=a;t.m05=m;t.m06=c;t.m07=0;t.m08=l;t.m09=h;t.m10=f;t.m11=0;t.m12=-(s*d+a*p+l*x);t.m13=-(o*d+m*p+h*x);t.m14=-(u*d+c*p+f*x);t.m15=1;return t};at.str=function(t){return`mat4(${t.m00}, ${t.m01}, ${t.m02}, ${t.m03}, ${t.m04}, ${t.m05}, ${t.m06}, ${t.m07}, ${t.m08}, ${t.m09}, ${t.m10}, ${t.m11}, ${t.m12}, ${t.m13}, ${t.m14}, ${t.m15})`};at.array=function(t,e){t[0]=e.m00;t[1]=e.m01;t[2]=e.m02;t[3]=e.m03;t[4]=e.m04;t[5]=e.m05;t[6]=e.m06;t[7]=e.m07;t[8]=e.m08;t[9]=e.m09;t[10]=e.m10;t[11]=e.m11;t[12]=e.m12;t[13]=e.m13;t[14]=e.m14;t[15]=e.m15;return t};at.frob=function(t){return Math.sqrt(Math.pow(t.m00,2)+Math.pow(t.m01,2)+Math.pow(t.m02,2)+Math.pow(t.m03,2)+Math.pow(t.m04,2)+Math.pow(t.m05,2)+Math.pow(t.m06,2)+Math.pow(t.m07,2)+Math.pow(t.m08,2)+Math.pow(t.m09,2)+Math.pow(t.m10,2)+Math.pow(t.m11,2)+Math.pow(t.m12,2)+Math.pow(t.m13,2)+Math.pow(t.m14,2)+Math.pow(t.m15,2))};at.add=function(t,e,n){t.m00=e.m00+n.m00;t.m01=e.m01+n.m01;t.m02=e.m02+n.m02;t.m03=e.m03+n.m03;t.m04=e.m04+n.m04;t.m05=e.m05+n.m05;t.m06=e.m06+n.m06;t.m07=e.m07+n.m07;t.m08=e.m08+n.m08;t.m09=e.m09+n.m09;t.m10=e.m10+n.m10;t.m11=e.m11+n.m11;t.m12=e.m12+n.m12;t.m13=e.m13+n.m13;t.m14=e.m14+n.m14;t.m15=e.m15+n.m15;return t};at.subtract=function(t,e,n){t.m00=e.m00-n.m00;t.m01=e.m01-n.m01;t.m02=e.m02-n.m02;t.m03=e.m03-n.m03;t.m04=e.m04-n.m04;t.m05=e.m05-n.m05;t.m06=e.m06-n.m06;t.m07=e.m07-n.m07;t.m08=e.m08-n.m08;t.m09=e.m09-n.m09;t.m10=e.m10-n.m10;t.m11=e.m11-n.m11;t.m12=e.m12-n.m12;t.m13=e.m13-n.m13;t.m14=e.m14-n.m14;t.m15=e.m15-n.m15;return t};at.sub=at.subtract;at.multiplyScalar=function(t,e,n){t.m00=e.m00*n;t.m01=e.m01*n;t.m02=e.m02*n;t.m03=e.m03*n;t.m04=e.m04*n;t.m05=e.m05*n;t.m06=e.m06*n;t.m07=e.m07*n;t.m08=e.m08*n;t.m09=e.m09*n;t.m10=e.m10*n;t.m11=e.m11*n;t.m12=e.m12*n;t.m13=e.m13*n;t.m14=e.m14*n;t.m15=e.m15*n;return t};at.multiplyScalarAndAdd=function(t,e,n,r){t.m00=e.m00+n.m00*r;t.m01=e.m01+n.m01*r;t.m02=e.m02+n.m02*r;t.m03=e.m03+n.m03*r;t.m04=e.m04+n.m04*r;t.m05=e.m05+n.m05*r;t.m06=e.m06+n.m06*r;t.m07=e.m07+n.m07*r;t.m08=e.m08+n.m08*r;t.m09=e.m09+n.m09*r;t.m10=e.m10+n.m10*r;t.m11=e.m11+n.m11*r;t.m12=e.m12+n.m12*r;t.m13=e.m13+n.m13*r;t.m14=e.m14+n.m14*r;t.m15=e.m15+n.m15*r;return t};at.exactEquals=function(t,e){return t.m00===e.m00&&t.m01===e.m01&&t.m02===e.m02&&t.m03===e.m03&&t.m04===e.m04&&t.m05===e.m05&&t.m06===e.m06&&t.m07===e.m07&&t.m08===e.m08&&t.m09===e.m09&&t.m10===e.m10&&t.m11===e.m11&&t.m12===e.m12&&t.m13===e.m13&&t.m14===e.m14&&t.m15===e.m15};at.equals=function(t,e){let r=t.m00,i=t.m01,s=t.m02,a=t.m03,l=t.m04,o=t.m05,m=t.m06,h=t.m07,u=t.m08,c=t.m09,f=t.m10,_=t.m11,d=t.m12,p=t.m13,x=t.m14,g=t.m15;let T=e.m00,E=e.m01,A=e.m02,M=e.m03,y=e.m04,S=e.m05,b=e.m06,R=e.m07,w=e.m08,v=e.m09,F=e.m10,P=e.m11,L=e.m12,I=e.m13,D=e.m14,C=e.m15;return Math.abs(r-T)<=n*Math.max(1,Math.abs(r),Math.abs(T))&&Math.abs(i-E)<=n*Math.max(1,Math.abs(i),Math.abs(E))&&Math.abs(s-A)<=n*Math.max(1,Math.abs(s),Math.abs(A))&&Math.abs(a-M)<=n*Math.max(1,Math.abs(a),Math.abs(M))&&Math.abs(l-y)<=n*Math.max(1,Math.abs(l),Math.abs(y))&&Math.abs(o-S)<=n*Math.max(1,Math.abs(o),Math.abs(S))&&Math.abs(m-b)<=n*Math.max(1,Math.abs(m),Math.abs(b))&&Math.abs(h-R)<=n*Math.max(1,Math.abs(h),Math.abs(R))&&Math.abs(u-w)<=n*Math.max(1,Math.abs(u),Math.abs(w))&&Math.abs(c-v)<=n*Math.max(1,Math.abs(c),Math.abs(v))&&Math.abs(f-F)<=n*Math.max(1,Math.abs(f),Math.abs(F))&&Math.abs(_-P)<=n*Math.max(1,Math.abs(_),Math.abs(P))&&Math.abs(d-L)<=n*Math.max(1,Math.abs(d),Math.abs(L))&&Math.abs(p-I)<=n*Math.max(1,Math.abs(p),Math.abs(I))&&Math.abs(x-D)<=n*Math.max(1,Math.abs(x),Math.abs(D))&&Math.abs(g-C)<=n*Math.max(1,Math.abs(g),Math.abs(C))};let lt=new Array(3);class ot{constructor(t,e,n){this.r=t;this.g=e;this.b=n}toJSON(){lt[0]=this.r;lt[1]=this.g;lt[2]=this.b;return lt}}let mt={};mt.create=function(){return new ot(1,1,1)};mt.new=function(t,e,n){return new ot(t,e,n)};mt.clone=function(t){return new ot(t.r,t.g,t.b,t.a)};mt.copy=function(t,e){t.r=e.r;t.g=e.g;t.b=e.b;return t};mt.set=function(t,e,n,r){t.r=e;t.g=n;t.b=r;return t};mt.fromHex=function(t,e){let n=(e>>16)/255;let r=(e>>8&255)/255;let i=(e&255)/255;t.r=n;t.g=r;t.b=i;return t};mt.add=function(t,e,n){t.r=e.r+n.r;t.g=e.g+n.g;t.b=e.b+n.b;return t};mt.subtract=function(t,e,n){t.r=e.r-n.r;t.g=e.g-n.g;t.b=e.b-n.b;return t};mt.sub=mt.subtract;mt.multiply=function(t,e,n){t.r=e.r*n.r;t.g=e.g*n.g;t.b=e.b*n.b;return t};mt.mul=mt.multiply;mt.divide=function(t,e,n){t.r=e.r/n.r;t.g=e.g/n.g;t.b=e.b/n.b;return t};mt.div=mt.divide;mt.scale=function(t,e,n){t.r=e.r*n;t.g=e.g*n;t.b=e.b*n;return t};mt.lerp=function(t,e,n,r){let i=e.r,s=e.g,a=e.b;t.r=i+r*(n.r-i);t.g=s+r*(n.g-s);t.b=a+r*(n.b-a);return t};mt.str=function(t){return`color3(${t.r}, ${t.g}, ${t.b})`};mt.array=function(t,e){t[0]=e.r;t[1]=e.g;t[2]=e.b;return t};mt.exactEquals=function(t,e){return t.r===e.r&&t.g===e.g&&t.b===e.b};mt.equals=function(t,e){let r=t.r,i=t.g,s=t.b;let a=e.r,l=e.g,o=e.b;return Math.abs(r-a)<=n*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(i-l)<=n*Math.max(1,Math.abs(i),Math.abs(l))&&Math.abs(s-o)<=n*Math.max(1,Math.abs(s),Math.abs(o))};mt.hex=function(t){return t.r*255<<16|t.g*255<<8|t.b*255};let ht=new Array(4);class ut{constructor(t,e,n,r){this.r=t;this.g=e;this.b=n;this.a=r}toJSON(){ht[0]=this.r;ht[1]=this.g;ht[2]=this.b;ht[3]=this.a;return ht}}let ct={};ct.create=function(){return new ut(1,1,1,1)};ct.new=function(t,e,n,r){return new ut(t,e,n,r)};ct.clone=function(t){return new ut(t.r,t.g,t.b,t.a)};ct.copy=function(t,e){t.r=e.r;t.g=e.g;t.b=e.b;t.a=e.a;return t};ct.set=function(t,e,n,r,i){t.r=e;t.g=n;t.b=r;t.a=i;return t};ct.fromHex=function(t,e){let n=(e>>24)/255;let r=(e>>16&255)/255;let i=(e>>8&255)/255;let s=(e&255)/255;t.r=n;t.g=r;t.b=i;t.a=s;return t};ct.add=function(t,e,n){t.r=e.r+n.r;t.g=e.g+n.g;t.b=e.b+n.b;t.a=e.a+n.a;return t};ct.subtract=function(t,e,n){t.r=e.r-n.r;t.g=e.g-n.g;t.b=e.b-n.b;t.a=e.a-n.a;return t};ct.sub=ct.subtract;ct.multiply=function(t,e,n){t.r=e.r*n.r;t.g=e.g*n.g;t.b=e.b*n.b;t.a=e.a*n.a;return t};ct.mul=ct.multiply;ct.divide=function(t,e,n){t.r=e.r/n.r;t.g=e.g/n.g;t.b=e.b/n.b;t.a=e.a/n.a;return t};ct.div=ct.divide;ct.scale=function(t,e,n){t.r=e.r*n;t.g=e.g*n;t.b=e.b*n;t.a=e.a*n;return t};ct.lerp=function(t,e,n,r){let i=e.r,s=e.g,a=e.b,l=e.a;t.r=i+r*(n.r-i);t.g=s+r*(n.g-s);t.b=a+r*(n.b-a);t.a=l+r*(n.a-l);return t};ct.str=function(t){return`color4(${t.r}, ${t.g}, ${t.b}, ${t.a})`};ct.array=function(t,e){t[0]=e.r;t[1]=e.g;t[2]=e.b;t[3]=e.a;return t};ct.exactEquals=function(t,e){return t.r===e.r&&t.g===e.g&&t.b===e.b&&t.a===e.a};ct.equals=function(t,e){let r=t.r,i=t.g,s=t.b,a=t.a;let l=e.r,o=e.g,m=e.b,h=e.a;return Math.abs(r-l)<=n*Math.max(1,Math.abs(r),Math.abs(l))&&Math.abs(i-o)<=n*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(s-m)<=n*Math.max(1,Math.abs(s),Math.abs(m))&&Math.abs(a-h)<=n*Math.max(1,Math.abs(a),Math.abs(h))};ct.hex=function(t){return(t.r*255<<24|t.g*255<<16|t.b*255<<8|t.a*255)>>>0};let ft=B;var _t=Object.freeze({bits:ft,vec2:U,vec3:q,vec4:G,quat:K,mat2:tt,mat23:rt,mat3:$,mat4:at,color3:mt,color4:ct,EPSILON:n,equals:r,approx:i,clamp:s,clamp01:a,lerp:l,toRadian:o,toDegree:m,random:h,randomRange:u,randomRangeInt:c,nextPow2:f});var dt={PROJ_PERSPECTIVE:0,PROJ_ORTHO:1,LIGHT_DIRECTIONAL:0,LIGHT_POINT:1,LIGHT_SPOT:2,SHADOW_NONE:0,SHADOW_HARD:1,SHADOW_SOFT:2,PARAM_INT:0,PARAM_INT2:1,PARAM_INT3:2,PARAM_INT4:3,PARAM_FLOAT:4,PARAM_FLOAT2:5,PARAM_FLOAT3:6,PARAM_FLOAT4:7,PARAM_COLOR3:8,PARAM_COLOR4:9,PARAM_MAT2:10,PARAM_MAT3:11,PARAM_MAT4:12,PARAM_TEXTURE_2D:13,PARAM_TEXTURE_CUBE:14,CLEAR_COLOR:1,CLEAR_DEPTH:2,CLEAR_STENCIL:4};const pt=9728;const xt=9729;const gt=9984;const Tt=9985;const Et=9986;const At=9987;const Mt=5121;const yt=5123;const St=5125;const bt=5126;const Rt=33635;const wt=32819;const vt=32820;const Ft=36193;const Pt=6402;const Lt=6406;const It=6407;const Dt=6408;const Ct=6409;const Ot=6410;const Bt=33776;const Nt=33777;const zt=33778;const Ut=33779;const Vt=35840;const kt=35841;const qt=35842;const Xt=35843;const Wt=36196;const Gt=[[pt,gt,Et],[xt,Tt,At]];const Ht=[{format:It,internalFormat:Bt,pixelType:null},{format:Dt,internalFormat:Nt,pixelType:null},{format:Dt,internalFormat:zt,pixelType:null},{format:Dt,internalFormat:Ut,pixelType:null},{format:It,internalFormat:Wt,pixelType:null},{format:It,internalFormat:kt,pixelType:null},{format:Dt,internalFormat:Xt,pixelType:null},{format:It,internalFormat:Vt,pixelType:null},{format:Dt,internalFormat:qt,pixelType:null},{format:Lt,internalFormat:Lt,pixelType:Mt},{format:Ct,internalFormat:Ct,pixelType:Mt},{format:Ot,internalFormat:Ot,pixelType:Mt},{format:It,internalFormat:It,pixelType:Rt},{format:Dt,internalFormat:Dt,pixelType:vt},{format:Dt,internalFormat:Dt,pixelType:wt},{format:It,internalFormat:It,pixelType:Mt},{format:Dt,internalFormat:Dt,pixelType:Mt},{format:It,internalFormat:It,pixelType:Ft},{format:Dt,internalFormat:Dt,pixelType:Ft},{format:It,internalFormat:It,pixelType:bt},{format:Dt,internalFormat:Dt,pixelType:bt},{format:null,internalFormat:null,pixelType:null},{format:null,internalFormat:null,pixelType:null},{format:null,internalFormat:null,pixelType:null},{format:null,internalFormat:null,pixelType:null},{format:Pt,internalFormat:Pt,pixelType:yt},{format:Pt,internalFormat:Pt,pixelType:St},{format:null,internalFormat:null,pixelType:null}];const Yt={USAGE_STATIC:35044,USAGE_DYNAMIC:35048,USAGE_STREAM:35040,INDEX_FMT_UINT8:5121,INDEX_FMT_UINT16:5123,INDEX_FMT_UINT32:5125,ATTR_POSITION:"a_position",ATTR_NORMAL:"a_normal",ATTR_TANGENT:"a_tangent",ATTR_BITANGENT:"a_bitangent",ATTR_WEIGHTS:"a_weights",ATTR_JOINTS:"a_joints",ATTR_COLOR:"a_color",ATTR_COLOR0:"a_color0",ATTR_COLOR1:"a_color1",ATTR_UV:"a_uv",ATTR_UV0:"a_uv0",ATTR_UV1:"a_uv1",ATTR_UV2:"a_uv2",ATTR_UV3:"a_uv3",ATTR_UV4:"a_uv4",ATTR_UV5:"a_uv5",ATTR_UV6:"a_uv6",ATTR_UV7:"a_uv7",ATTR_TYPE_INT8:5120,ATTR_TYPE_UINT8:5121,ATTR_TYPE_INT16:5122,ATTR_TYPE_UINT16:5123,ATTR_TYPE_INT32:5124,ATTR_TYPE_UINT32:5125,ATTR_TYPE_FLOAT32:5126,FILTER_NEAREST:0,FILTER_LINEAR:1,WRAP_REPEAT:10497,WRAP_CLAMP:33071,WRAP_MIRROR:33648,TEXTURE_FMT_RGB_DXT1:0,TEXTURE_FMT_RGBA_DXT1:1,TEXTURE_FMT_RGBA_DXT3:2,TEXTURE_FMT_RGBA_DXT5:3,TEXTURE_FMT_RGB_ETC1:4,TEXTURE_FMT_RGB_PVRTC_2BPPV1:5,TEXTURE_FMT_RGBA_PVRTC_2BPPV1:6,TEXTURE_FMT_RGB_PVRTC_4BPPV1:7,TEXTURE_FMT_RGBA_PVRTC_4BPPV1:8,TEXTURE_FMT_A8:9,TEXTURE_FMT_L8:10,TEXTURE_FMT_L8_A8:11,TEXTURE_FMT_R5_G6_B5:12,TEXTURE_FMT_R5_G5_B5_A1:13,TEXTURE_FMT_R4_G4_B4_A4:14,TEXTURE_FMT_RGB8:15,TEXTURE_FMT_RGBA8:16,TEXTURE_FMT_RGB16F:17,TEXTURE_FMT_RGBA16F:18,TEXTURE_FMT_RGB32F:19,TEXTURE_FMT_RGBA32F:20,TEXTURE_FMT_R32F:21,TEXTURE_FMT_111110F:22,TEXTURE_FMT_SRGB:23,TEXTURE_FMT_SRGBA:24,TEXTURE_FMT_D16:25,TEXTURE_FMT_D32:26,TEXTURE_FMT_D24S8:27,DS_FUNC_NEVER:512,DS_FUNC_LESS:513,DS_FUNC_EQUAL:514,DS_FUNC_LEQUAL:515,DS_FUNC_GREATER:516,DS_FUNC_NOTEQUAL:517,DS_FUNC_GEQUAL:518,DS_FUNC_ALWAYS:519,RB_FMT_RGBA4:32854,RB_FMT_RGB5_A1:32855,RB_FMT_RGB565:36194,RB_FMT_D16:33189,RB_FMT_S8:36168,RB_FMT_D24S8:34041,BLEND_FUNC_ADD:32774,BLEND_FUNC_SUBTRACT:32778,BLEND_FUNC_REVERSE_SUBTRACT:32779,BLEND_ZERO:0,BLEND_ONE:1,BLEND_SRC_COLOR:768,BLEND_ONE_MINUS_SRC_COLOR:769,BLEND_DST_COLOR:774,BLEND_ONE_MINUS_DST_COLOR:775,BLEND_SRC_ALPHA:770,BLEND_ONE_MINUS_SRC_ALPHA:771,BLEND_DST_ALPHA:772,BLEND_ONE_MINUS_DST_ALPHA:773,BLEND_CONSTANT_COLOR:32769,BLEND_ONE_MINUS_CONSTANT_COLOR:32770,BLEND_CONSTANT_ALPHA:32771,BLEND_ONE_MINUS_CONSTANT_ALPHA:32772,BLEND_SRC_ALPHA_SATURATE:776,STENCIL_OP_KEEP:7680,STENCIL_OP_ZERO:0,STENCIL_OP_REPLACE:7681,STENCIL_OP_INCR:7682,STENCIL_OP_INCR_WRAP:34055,STENCIL_OP_DECR:7683,STENCIL_OP_DECR_WRAP:34056,STENCIL_OP_INVERT:5386,CULL_NONE:0,CULL_FRONT:1028,CULL_BACK:1029,CULL_FRONT_AND_BACK:1032,PT_POINTS:0,PT_LINES:1,PT_LINE_LOOP:2,PT_LINE_STRIP:3,PT_TRIANGLES:4,PT_TRIANGLE_STRIP:5,PT_TRIANGLE_FAN:6};function $t(t){if(t===Yt.ATTR_TYPE_INT8){return 1}else if(t===Yt.ATTR_TYPE_UINT8){return 1}else if(t===Yt.ATTR_TYPE_INT16){return 2}else if(t===Yt.ATTR_TYPE_UINT16){return 2}else if(t===Yt.ATTR_TYPE_INT32){return 4}else if(t===Yt.ATTR_TYPE_UINT32){return 4}else if(t===Yt.ATTR_TYPE_FLOAT32){return 4}console.warn(`Unknown ATTR_TYPE: ${t}`);return 0}function Zt(t,e,n=-1){let r=Gt[e][n+1];if(r===undefined){console.warn(`Unknown FILTER: ${e}`);return n===-1?t.LINEAR:t.LINEAR_MIPMAP_LINEAR}return r}function jt(t){let e=Ht[t];if(e===undefined){console.warn(`Unknown TEXTURE_FMT: ${t}`);return Ht[Yt.TEXTURE_FMT_RGBA8]}return e}class Kt{constructor(t){this._attr2el={};this._elements=[];this._bytes=0;let e=0;for(let n=0,r=t.length;n<r;++n){let r=t[n];let i={name:r.name,offset:e,stride:0,stream:-1,type:r.type,num:r.num,normalize:r.normalize===undefined?false:r.normalize,bytes:r.num*$t(r.type)};this._attr2el[i.name]=i;this._elements.push(i);this._bytes+=i.bytes;e+=i.bytes}for(let t=0,e=this._elements.length;t<e;++t){let e=this._elements[t];e.stride=this._bytes}}element(t){return this._attr2el[t]}}class Jt{constructor(t,e,n,r,i){this._device=t;this._format=e;this._usage=n;this._numIndices=i;this._bytesPerIndex=0;let s=0;if(e===Yt.INDEX_FMT_UINT8){this._bytesPerIndex=1}else if(e===Yt.INDEX_FMT_UINT16){this._bytesPerIndex=2}else if(e===Yt.INDEX_FMT_UINT32){this._bytesPerIndex=4}this._bytes=this._bytesPerIndex*i;this._glID=t._gl.createBuffer();this.update(0,r);t._stats.ib+=s}destroy(){if(this._glID===-1){console.error("The buffer already destroyed");return}let t=this._device._gl;t.deleteBuffer(this._glID);this._device._stats.ib-=this.bytes;this._glID=-1}update(t,e){if(this._glID===-1){console.error("The buffer is destroyed");return}if(e&&e.byteLength+t>this._bytes){console.error("Failed to update data, bytes exceed.");return}let n=this._device._gl;let r=this._usage;n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this._glID);if(!e){n.bufferData(n.ELEMENT_ARRAY_BUFFER,this._bytes,r)}else{if(t){n.bufferSubData(n.ELEMENT_ARRAY_BUFFER,e,r)}else{n.bufferData(n.ELEMENT_ARRAY_BUFFER,e,r)}}this._device._restoreIndexBuffer()}get count(){return this._numIndices}}class Qt{constructor(t,e,n,r,i){this._device=t;this._format=e;this._usage=n;this._numVertices=i;this._bytes=this._format._bytes*i;this._glID=t._gl.createBuffer();this.update(0,r);t._stats.vb+=this._bytes}destroy(){if(this._glID===-1){console.error("The buffer already destroyed");return}let t=this._device._gl;t.deleteBuffer(this._glID);this._device._stats.vb-=this.bytes;this._glID=-1}update(t,e){if(this._glID===-1){console.error("The buffer is destroyed");return}if(e&&e.byteLength+t>this._bytes){console.error("Failed to update data, bytes exceed.");return}let n=this._device._gl;let r=this._usage;n.bindBuffer(n.ARRAY_BUFFER,this._glID);if(!e){n.bufferData(n.ARRAY_BUFFER,this._bytes,r)}else{if(t){n.bufferSubData(n.ARRAY_BUFFER,t,e)}else{n.bufferData(n.ARRAY_BUFFER,e,r)}}n.bindBuffer(n.ARRAY_BUFFER,null)}get count(){return this._numVertices}}let te=0;function ee(t,e,n){n.split("\n").forEach(n=>{if(n.length<5){return}let r=/^ERROR\:\s+(\d+)\:(\d+)\:\s*(.*)$/.exec(n);if(r){t.push({type:e,fileID:r[1]|0,line:r[2]|0,message:r[3].trim()})}else if(n.length>0){t.push({type:e,fileID:-1,line:0,message:n})}})}class ne{constructor(t,e){this._device=t;this._attributes=[];this._uniforms=[];this._samplers=[];this._errors=[];this._linked=false;this._vertSource=e.vert;this._fragSource=e.frag;this._glID=null;this._id=te++}get id(){return this._id}link(){if(this._linked){return}let t=this._device._gl;let e=re(t,t.VERTEX_SHADER,this._vertSource);let n=re(t,t.FRAGMENT_SHADER,this._fragSource);let r=t.createProgram();t.attachShader(r,e);t.attachShader(r,n);t.linkProgram(r);let i=false;let s=this._errors;if(!t.getShaderParameter(e,t.COMPILE_STATUS)){ee(s,"vs",t.getShaderInfoLog(e));i=true}if(!t.getShaderParameter(n,t.COMPILE_STATUS)){ee(s,"fs",t.getShaderInfoLog(n));i=true}t.deleteShader(e);t.deleteShader(n);if(i){s.forEach(t=>{console.error(`Failed to compile ${t.type} ${t.fileID} (ln ${t.line}): ${t.message}`)});return}if(!t.getProgramParameter(r,t.LINK_STATUS)){console.error(`Failed to link shader program: ${t.getProgramInfoLog(r)}`);i=true}if(i){return}this._glID=r;let a=t.getProgramParameter(r,t.ACTIVE_ATTRIBUTES);for(let e=0;e<a;++e){let n=t.getActiveAttrib(r,e);let i=t.getAttribLocation(r,n.name);this._attributes.push({name:n.name,location:i,type:n.type})}let l=t.getProgramParameter(r,t.ACTIVE_UNIFORMS);for(let e=0;e<l;++e){let n=t.getActiveUniform(r,e);let i=n.name;let s=t.getUniformLocation(r,i);let a=i.substr(i.length-3)==="[0]";if(a){i=i.substr(0,i.length-3)}this._uniforms.push({name:i,location:s,type:n.type,size:a?n.size:undefined})}this._linked=true}destroy(){let t=this._device._gl;t.deleteProgram(this._glID);this._linked=false;this._glID=null;this._attributes=[];this._uniforms=[];this._samplers=[]}}function re(t,e,n){let r=t.createShader(e);t.shaderSource(r,n);t.compileShader(r);return r}class ie{constructor(t){this._device=t;this._width=4;this._height=4;this._hasMipmap=false;this._compressed=false;this._anisotropy=1;this._minFilter=Yt.FILTER_LINEAR;this._magFilter=Yt.FILTER_LINEAR;this._mipFilter=Yt.FILTER_LINEAR;this._wrapS=Yt.WRAP_REPEAT;this._wrapT=Yt.WRAP_REPEAT;this._format=Yt.TEXTURE_FMT_RGBA8;this._target=-1}destroy(){if(this._glID===-1){console.error("The texture already destroyed");return}let t=this._device._gl;t.deleteTexture(this._glID);this._device._stats.tex-=this.bytes;this._glID=-1}}function se(t){return!(t&t-1)&&!!t}class ae extends ie{constructor(t,e){super(t);let n=this._device._gl;this._target=n.TEXTURE_2D;this._glID=n.createTexture();e.images=e.images||[null];this.update(e)}update(t){let e=this._device._gl;let n=this._hasMipmap;if(t){if(t.width!==undefined){this._width=t.width}if(t.height!==undefined){this._height=t.height}if(t.anisotropy!==undefined){this._anisotropy=t.anisotropy}if(t.minFilter!==undefined){this._minFilter=t.minFilter}if(t.magFilter!==undefined){this._magFilter=t.magFilter}if(t.mipFilter!==undefined){this._mipFilter=t.mipFilter}if(t.wrapS!==undefined){this._wrapS=t.wrapS}if(t.wrapT!==undefined){this._wrapT=t.wrapT}if(t.format!==undefined){this._format=t.format;this._compressed=this._format>=Yt.TEXTURE_FMT_RGB_DXT1&&this._format<=Yt.TEXTURE_FMT_RGBA_PVRTC_4BPPV1}if(t.mipmap!==undefined){this._hasMipmap=t.mipmap;n=t.mipmap}if(t.images!==undefined){if(t.images.length>1){n=false;let e=t.width>t.height?t.width:t.height;if(e>>t.images.length-1!==1){console.error("texture-2d mipmap is invalid, should have a 1x1 mipmap.")}}}}let r=se(this._width)&&se(this._height);if(!r){n=false}e.activeTexture(e.TEXTURE0);e.bindTexture(e.TEXTURE_2D,this._glID);if(t.images!==undefined){this._setMipmap(t.images,t.flipY,t.premultiplyAlpha)}this._setTexInfo();if(n){e.hint(e.GENERATE_MIPMAP_HINT,e.NICEST);e.generateMipmap(e.TEXTURE_2D)}this._device._restoreTexture(0)}updateSubImage(t){let e=this._device._gl;let n=jt(this._format);e.activeTexture(e.TEXTURE0);e.bindTexture(e.TEXTURE_2D,this._glID);this._setSubImage(n,t);this._device._restoreTexture(0)}updateImage(t){let e=this._device._gl;let n=jt(this._format);e.activeTexture(e.TEXTURE0);e.bindTexture(e.TEXTURE_2D,this._glID);this._setImage(n,t);this._device._restoreTexture(0)}_setSubImage(t,e){let n=this._device._gl;let r=e.flipY;let i=e.premultiplyAlpha;let s=e.image;if(s instanceof HTMLCanvasElement||s instanceof HTMLImageElement||s instanceof HTMLVideoElement){if(r===undefined){n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,true)}else{n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,r)}if(i===undefined){n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)}else{n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i)}n.texSubImage2D(n.TEXTURE_2D,e.level,e.x,e.y,t.format,t.pixelType,s)}else{if(r===undefined){n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,false)}else{n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,r)}if(i===undefined){n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)}else{n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i)}if(this._compressed){n.compressedTexSubImage2D(n.TEXTURE_2D,e.level,e.x,e.y,e.width,e.height,t.format,s)}else{n.texSubImage2D(n.TEXTURE_2D,e.level,e.x,e.y,e.width,e.height,t.format,t.pixelType,s)}}}_setImage(t,e){let n=this._device._gl;let r=e.flipY;let i=e.premultiplyAlpha;let s=e.image;if(s instanceof HTMLCanvasElement||s instanceof HTMLImageElement||s instanceof HTMLVideoElement){if(r===undefined){n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,true)}else{n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,r)}if(i===undefined){n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)}else{n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i)}n.texImage2D(n.TEXTURE_2D,e.level,t.internalFormat,t.format,t.pixelType,s)}else{if(r===undefined){n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,false)}else{n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,r)}if(i===undefined){n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)}else{n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i)}if(this._compressed){n.compressedTexImage2D(n.TEXTURE_2D,e.level,t.internalFormat,e.width,e.height,0,s)}else{n.texImage2D(n.TEXTURE_2D,e.level,t.internalFormat,e.width,e.height,0,t.format,t.pixelType,s)}}}_setMipmap(t,e,n){let r=jt(this._format);let i={width:this._width,height:this._height,flipY:e,premultiplyAlpha:n,level:0,image:null};for(let e=0;e<t.length;++e){i.level=e;i.width=this._width>>e;i.height=this._height>>e;i.image=t[e];this._setImage(r,i)}}_setTexInfo(){let t=this._device._gl;let e=se(this._width)&&se(this._height);if(!e&&(this._wrapS!==Yt.WRAP_CLAMP||this._wrapT!==Yt.WRAP_CLAMP)){console.warn("WebGL1 doesn't support all wrap modes with NPOT textures");this._wrapS=Yt.WRAP_CLAMP;this._wrapT=Yt.WRAP_CLAMP}let n=this._hasMipmap?this._mipFilter:-1;if(!e&&n!==-1){console.warn("NPOT textures do not support mipmap filter");n=-1}t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,Zt(t,this._minFilter,n));t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,Zt(t,this._magFilter,-1));t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,this._wrapS);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,this._wrapT);let r=this._device.ext("EXT_texture_filter_anisotropic");if(r){t.texParameteri(t.TEXTURE_2D,r.TEXTURE_MAX_ANISOTROPY_EXT,this._anisotropy)}}}class le extends ie{constructor(t,e){super(t);let n=this._device._gl;this._target=n.TEXTURE_CUBE_MAP;this._glID=n.createTexture();this.update(e)}update(t){let e=this._device._gl;let n=this._hasMipmap;if(t){if(t.width!==undefined){this._width=t.width}if(t.height!==undefined){this._height=t.height}if(t.anisotropy!==undefined){this._anisotropy=t.anisotropy}if(t.minFilter!==undefined){this._minFilter=t.minFilter}if(t.magFilter!==undefined){this._magFilter=t.magFilter}if(t.mipFilter!==undefined){this._mipFilter=t.mipFilter}if(t.wrapS!==undefined){this._wrapS=t.wrapS}if(t.wrapT!==undefined){this._wrapT=t.wrapT}if(t.format!==undefined){this._format=t.format;this._compressed=this._format>=Yt.TEXTURE_FMT_RGB_DXT1&&this._format<=Yt.TEXTURE_FMT_RGBA_PVRTC_4BPPV1}if(t.mipmap!==undefined){this._hasMipmap=t.mipmap;n=t.mipmap}if(t.images!==undefined){if(t.images.length>1){n=false;if(t.width!==t.height){console.warn("texture-cube width and height should be identical.")}if(t.width>>t.images.length-1!==1){console.error("texture-cube mipmap is invalid. please set mipmap as 1x1, 2x2, 4x4 ... nxn")}}}}let r=se(this._width)&&se(this._height);if(!r){n=false}e.activeTexture(e.TEXTURE0);e.bindTexture(e.TEXTURE_CUBE_MAP,this._glID);if(t.images!==undefined){this._setMipmap(t.images,t.flipY,t.premultiplyAlpha)}this._setTexInfo();if(n){e.hint(e.GENERATE_MIPMAP_HINT,e.NICEST);e.generateMipmap(e.TEXTURE_CUBE_MAP)}this._device._restoreTexture(0)}updateSubImage(t){let e=this._device._gl;let n=jt(this._format);e.activeTexture(e.TEXTURE0);e.bindTexture(e.TEXTURE_CUBE_MAP,this._glID);this._setSubImage(n,t);this._device._restoreTexture(0)}updateImage(t){let e=this._device._gl;let n=jt(this._format);e.activeTexture(e.TEXTURE0);e.bindTexture(e.TEXTURE_CUBE_MAP,this._glID);this._setImage(n,t);this._device._restoreTexture(0)}_setSubImage(t,e){let n=this._device._gl;let r=e.flipY;let i=e.premultiplyAlpha;let s=e.faceIndex;let a=e.image;if(r===undefined){n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,false)}else{n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,r)}if(i===undefined){n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)}else{n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i)}if(a instanceof HTMLCanvasElement||a instanceof HTMLImageElement||a instanceof HTMLVideoElement){n.texSubImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+s,e.level,e.x,e.y,t.format,t.pixelType,a)}else{if(this._compressed){n.compressedTexSubImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+s,e.level,e.x,e.y,e.width,e.height,t.format,a)}else{n.texSubImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+s,e.level,e.x,e.y,e.width,e.height,t.format,t.pixelType,a)}}}_setImage(t,e){let n=this._device._gl;let r=e.flipY;let i=e.premultiplyAlpha;let s=e.faceIndex;let a=e.image;if(r===undefined){n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,false)}else{n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,r)}if(i===undefined){n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)}else{n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i)}if(a instanceof HTMLCanvasElement||a instanceof HTMLImageElement||a instanceof HTMLVideoElement){n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+s,e.level,t.internalFormat,t.format,t.pixelType,a)}else{if(this._compressed){n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+s,e.level,t.internalFormat,e.width,e.height,0,a)}else{n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+s,e.level,t.internalFormat,e.width,e.height,0,t.format,t.pixelType,a)}}}_setMipmap(t,e,n){let r=jt(this._format);let i={width:this._width,height:this._height,faceIndex:0,flipY:e,premultiplyAlpha:n,level:0,image:null};for(let e=0;e<t.length;++e){let n=t[e];i.level=e;i.width=this._width>>e;i.height=this._height>>e;for(let t=0;t<6;++t){i.faceIndex=t;i.image=n[t];this._setImage(r,i)}}}_setTexInfo(){let t=this._device._gl;let e=se(this._width)&&se(this._height);if(!e&&(this._wrapS!==Yt.WRAP_CLAMP||this._wrapT!==Yt.WRAP_CLAMP)){console.warn("WebGL1 doesn't support all wrap modes with NPOT textures");this._wrapS=Yt.WRAP_CLAMP;this._wrapT=Yt.WRAP_CLAMP}let n=this._hasMipmap?this._mipFilter:-1;if(!e&&n!==-1){console.warn("NPOT textures do not support mipmap filter");n=-1}t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,Zt(t,this._minFilter,n));t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,Zt(t,this._magFilter,-1));t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_S,this._wrapS);t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_T,this._wrapT);let r=this._device.ext("EXT_texture_filter_anisotropic");if(r){t.texParameteri(t.TEXTURE_CUBE_MAP,r.TEXTURE_MAX_ANISOTROPY_EXT,this._anisotropy)}}}class oe{constructor(t,e,n,r){this._device=t;this._format=e;this._width=n;this._height=r;const i=t._gl;this._glID=i.createRenderbuffer();i.bindRenderbuffer(i.RENDERBUFFER,this._glID);i.renderbufferStorage(i.RENDERBUFFER,e,n,r);i.bindRenderbuffer(i.RENDERBUFFER,null)}destroy(){if(this._glID===null){console.error("The render-buffer already destroyed");return}const t=this._device._gl;t.bindRenderbuffer(t.RENDERBUFFER,null);t.deleteRenderbuffer(this._glID);this._glID=null}}class me{constructor(t,e,n,r){this._device=t;this._width=e;this._height=n;this._colors=r.colors||[];this._depth=r.depth||null;this._stencil=r.stencil||null;this._depthStencil=r.depthStencil||null;this._glID=t._gl.createFramebuffer()}destroy(){if(this._glID===null){console.error("The frame-buffer already destroyed");return}const t=this._device._gl;t.deleteFramebuffer(this._glID);this._glID=null}}const he={blend:false,blendSep:false,blendColor:4294967295,blendEq:Yt.BLEND_FUNC_ADD,blendAlphaEq:Yt.BLEND_FUNC_ADD,blendSrc:Yt.BLEND_ONE,blendDst:Yt.BLEND_ZERO,blendSrcAlpha:Yt.BLEND_ONE,blendDstAlpha:Yt.BLEND_ZERO,depthTest:false,depthWrite:false,depthFunc:Yt.DS_FUNC_LESS,stencilTest:false,stencilSep:false,stencilFuncFront:Yt.DS_FUNC_ALWAYS,stencilRefFront:0,stencilMaskFront:255,stencilFailOpFront:Yt.STENCIL_OP_KEEP,stencilZFailOpFront:Yt.STENCIL_OP_KEEP,stencilZPassOpFront:Yt.STENCIL_OP_KEEP,stencilWriteMaskFront:255,stencilFuncBack:Yt.DS_FUNC_ALWAYS,stencilRefBack:0,stencilMaskBack:255,stencilFailOpBack:Yt.STENCIL_OP_KEEP,stencilZFailOpBack:Yt.STENCIL_OP_KEEP,stencilZPassOpBack:Yt.STENCIL_OP_KEEP,stencilWriteMaskBack:255,cullMode:Yt.CULL_BACK,primitiveType:Yt.PT_TRIANGLES,maxStream:-1,vertexBuffers:[],vertexBufferOffsets:[],indexBuffer:null,textureUnits:[],program:null};class ue{constructor(){this.vertexBuffers=[];this.vertexBufferOffsets=[];this.textureUnits=[];this.set(he)}reset(){this.set(he)}set(t){this.blend=t.blend;this.blendSep=t.blendSep;this.blendColor=t.blendColor;this.blendEq=t.blendEq;this.blendAlphaEq=t.blendAlphaEq;this.blendSrc=t.blendSrc;this.blendDst=t.blendDst;this.blendSrcAlpha=t.blendSrcAlpha;this.blendDstAlpha=t.blendDstAlpha;this.depthTest=t.depthTest;this.depthWrite=t.depthWrite;this.depthFunc=t.depthFunc;this.stencilTest=t.stencilTest;this.stencilSep=t.stencilSep;this.stencilFuncFront=t.stencilFuncFront;this.stencilRefFront=t.stencilRefFront;this.stencilMaskFront=t.stencilMaskFront;this.stencilFailOpFront=t.stencilFailOpFront;this.stencilZFailOpFront=t.stencilZFailOpFront;this.stencilZPassOpFront=t.stencilZPassOpFront;this.stencilWriteMaskFront=t.stencilWriteMaskFront;this.stencilFuncBack=t.stencilFuncBack;this.stencilRefBack=t.stencilRefBack;this.stencilMaskBack=t.stencilMaskBack;this.stencilFailOpBack=t.stencilFailOpBack;this.stencilZFailOpBack=t.stencilZFailOpBack;this.stencilZPassOpBack=t.stencilZPassOpBack;this.stencilWriteMaskBack=t.stencilWriteMaskBack;this.cullMode=t.cullMode;this.primitiveType=t.primitiveType;this.maxStream=t.maxStream;for(let e=0;e<t.vertexBuffers.length;++e){this.vertexBuffers[e]=t.vertexBuffers[e]}for(let e=0;e<t.vertexBufferOffsets.length;++e){this.vertexBufferOffsets[e]=t.vertexBufferOffsets[e]}this.indexBuffer=t.indexBuffer;for(let e=0;e<t.textureUnits.length;++e){this.textureUnits[e]=t.textureUnits[e]}this.program=t.program}}const ce=5124;const fe=5126;const _e=35664;const de=35665;const pe=35666;const xe=35667;const ge=35668;const Te=35669;const Ee=35670;const Ae=35671;const Me=35672;const ye=35673;const Se=35674;const be=35675;const Re=35676;const we=35678;const ve=35680;let Fe={[ce]:function(t,e,n){t.uniform1i(e,n)},[fe]:function(t,e,n){t.uniform1f(e,n)},[_e]:function(t,e,n){t.uniform2fv(e,n)},[de]:function(t,e,n){t.uniform3fv(e,n)},[pe]:function(t,e,n){t.uniform4fv(e,n)},[xe]:function(t,e,n){t.uniform2iv(e,n)},[ge]:function(t,e,n){t.uniform3iv(e,n)},[Te]:function(t,e,n){t.uniform4iv(e,n)},[Ee]:function(t,e,n){t.uniform1i(e,n)},[Ae]:function(t,e,n){t.uniform2iv(e,n)},[Me]:function(t,e,n){t.uniform3iv(e,n)},[ye]:function(t,e,n){t.uniform4iv(e,n)},[Se]:function(t,e,n){t.uniformMatrix2fv(e,false,n)},[be]:function(t,e,n){t.uniformMatrix3fv(e,false,n)},[Re]:function(t,e,n){t.uniformMatrix4fv(e,false,n)},[we]:function(t,e,n){t.uniform1i(e,n)},[ve]:function(t,e,n){t.uniform1i(e,n)}};let Pe={[ce]:function(t,e,n){t.uniform1iv(e,n)},[fe]:function(t,e,n){t.uniform1fv(e,n)},[_e]:function(t,e,n){t.uniform2fv(e,n)},[de]:function(t,e,n){t.uniform3fv(e,n)},[pe]:function(t,e,n){t.uniform4fv(e,n)},[xe]:function(t,e,n){t.uniform2iv(e,n)},[ge]:function(t,e,n){t.uniform3iv(e,n)},[Te]:function(t,e,n){t.uniform4iv(e,n)},[Ee]:function(t,e,n){t.uniform1iv(e,n)},[Ae]:function(t,e,n){t.uniform2iv(e,n)},[Me]:function(t,e,n){t.uniform3iv(e,n)},[ye]:function(t,e,n){t.uniform4iv(e,n)},[Se]:function(t,e,n){t.uniformMatrix2fv(e,false,n)},[be]:function(t,e,n){t.uniformMatrix3fv(e,false,n)},[Re]:function(t,e,n){t.uniformMatrix4fv(e,false,n)},[we]:function(t,e,n){t.uniform1iv(e,n)},[ve]:function(t,e,n){t.uniform1iv(e,n)}};function Le(t,e,n){if(e.blend!==n.blend){if(!n.blend){t.disable(t.BLEND);return}t.enable(t.BLEND);if(n.blendSrc===Yt.BLEND_CONSTANT_COLOR||n.blendSrc===Yt.BLEND_ONE_MINUS_CONSTANT_COLOR||n.blendDst===Yt.BLEND_CONSTANT_COLOR||n.blendDst===Yt.BLEND_ONE_MINUS_CONSTANT_COLOR){t.blendColor((n.blendColor>>24)/255,(n.blendColor>>16&255)/255,(n.blendColor>>8&255)/255,(n.blendColor&255)/255)}if(n.blendSep){t.blendFuncSeparate(n.blendSrc,n.blendDst,n.blendSrcAlpha,n.blendDstAlpha);t.blendEquationSeparate(n.blendEq,n.blendAlphaEq)}else{t.blendFunc(n.blendSrc,n.blendDst);t.blendEquation(n.blendEq)}return}if(n.blend===false){return}if(e.blendColor!==n.blendColor){t.blendColor((n.blendColor>>24)/255,(n.blendColor>>16&255)/255,(n.blendColor>>8&255)/255,(n.blendColor&255)/255)}if(e.blendSep!==n.blendSep){if(n.blendSep){t.blendFuncSeparate(n.blendSrc,n.blendDst,n.blendSrcAlpha,n.blendDstAlpha);t.blendEquationSeparate(n.blendEq,n.blendAlphaEq)}else{t.blendFunc(n.blendSrc,n.blendDst);t.blendEquation(n.blendEq)}return}if(n.blendSep){if(e.blendSrc!==n.blendSrc||e.blendDst!==n.blendDst||e.blendSrcAlpha!==n.blendSrcAlpha||e.blendDstAlpha!==n.blendDstAlpha){t.blendFuncSeparate(n.blendSrc,n.blendDst,n.blendSrcAlpha,n.blendDstAlpha)}if(e.blendEq!==n.blendEq||e.blendAlphaEq!==n.blendAlphaEq){t.blendEquationSeparate(n.blendEq,n.blendAlphaEq)}}else{if(e.blendSrc!==n.blendSrc||e.blendDst!==n.blendDst){t.blendFunc(n.blendSrc,n.blendDst)}if(e.blendEq!==n.blendEq){t.blendEquation(n.blendEq)}}}function Ie(t,e,n){if(e.depthTest!==n.depthTest){if(!n.depthTest){t.disable(t.DEPTH_TEST);return}t.enable(t.DEPTH_TEST);t.depthFunc(n.depthFunc);t.depthMask(n.depthWrite);return}if(e.depthWrite!==n.depthWrite){t.depthMask(n.depthWrite)}if(n.depthTest===false){if(n.depthWrite){n.depthTest=true;n.depthFunc=Yt.DS_FUNC_ALWAYS;t.enable(t.DEPTH_TEST);t.depthFunc(n.depthFunc)}return}if(e.depthFunc!==n.depthFunc){t.depthFunc(n.depthFunc)}}function De(t,e,n){if(n.stencilTest!==e.stencilTest){if(!n.stencilTest){t.disable(t.STENCIL_TEST);return}t.enable(t.STENCIL_TEST);if(n.stencilSep){t.stencilFuncSeparate(t.FRONT,n.stencilFuncFront,n.stencilRefFront,n.stencilMaskFront);t.stencilMaskSeparate(t.FRONT,n.stencilWriteMaskFront);t.stencilOpSeparate(t.FRONT,n.stencilFailOpFront,n.stencilZFailOpFront,n.stencilZPassOpFront);t.stencilFuncSeparate(t.BACK,n.stencilFuncBack,n.stencilRefBack,n.stencilMaskBack);t.stencilMaskSeparate(t.BACK,n.stencilWriteMaskBack);t.stencilOpSeparate(t.BACK,n.stencilFailOpBack,n.stencilZFailOpBack,n.stencilZPassOpBack)}else{t.stencilFunc(n.stencilFuncFront,n.stencilRefFront,n.stencilMaskFront);t.stencilMask(n.stencilWriteMaskFront);t.stencilOp(n.stencilFailOpFront,n.stencilZFailOpFront,n.stencilZPassOpFront)}return}if(!n.stencilTest){return}if(e.stencilSep!==n.stencilSep){if(n.stencilSep){t.stencilFuncSeparate(t.FRONT,n.stencilFuncFront,n.stencilRefFront,n.stencilMaskFront);t.stencilMaskSeparate(t.FRONT,n.stencilWriteMaskFront);t.stencilOpSeparate(t.FRONT,n.stencilFailOpFront,n.stencilZFailOpFront,n.stencilZPassOpFront);t.stencilFuncSeparate(t.BACK,n.stencilFuncBack,n.stencilRefBack,n.stencilMaskBack);t.stencilMaskSeparate(t.BACK,n.stencilWriteMaskBack);t.stencilOpSeparate(t.BACK,n.stencilFailOpBack,n.stencilZFailOpBack,n.stencilZPassOpBack)}else{t.stencilFunc(n.stencilFuncFront,n.stencilRefFront,n.stencilMaskFront);t.stencilMask(n.stencilWriteMaskFront);t.stencilOp(n.stencilFailOpFront,n.stencilZFailOpFront,n.stencilZPassOpFront)}return}if(n.stencilSep){if(e.stencilFuncFront!==n.stencilFuncFront||e.stencilRefFront!==n.stencilRefFront||e.stencilMaskFront!==n.stencilMaskFront){t.stencilFuncSeparate(t.FRONT,n.stencilFuncFront,n.stencilRefFront,n.stencilMaskFront)}if(e.stencilWriteMaskFront!==n.stencilWriteMaskFront){t.stencilMaskSeparate(t.FRONT,n.stencilWriteMaskFront)}if(e.stencilFailOpFront!==n.stencilFailOpFront||e.stencilZFailOpFront!==n.stencilZFailOpFront||e.stencilZPassOpFront!==n.stencilZPassOpFront){t.stencilOpSeparate(t.FRONT,n.stencilFailOpFront,n.stencilZFailOpFront,n.stencilZPassOpFront)}if(e.stencilFuncBack!==n.stencilFuncBack||e.stencilRefBack!==n.stencilRefBack||e.stencilMaskBack!==n.stencilMaskBack){t.stencilFuncSeparate(t.BACK,n.stencilFuncBack,n.stencilRefBack,n.stencilMaskBack)}if(e.stencilWriteMaskBack!==n.stencilWriteMaskBack){t.stencilMaskSeparate(t.BACK,n.stencilWriteMaskBack)}if(e.stencilFailOpBack!==n.stencilFailOpBack||e.stencilZFailOpBack!==n.stencilZFailOpBack||e.stencilZPassOpBack!==n.stencilZPassOpBack){t.stencilOpSeparate(t.BACK,n.stencilFailOpBack,n.stencilZFailOpBack,n.stencilZPassOpBack)}}else{if(e.stencilFuncFront!==n.stencilFuncFront||e.stencilRefFront!==n.stencilRefFront||e.stencilMaskFront!==n.stencilMaskFront){t.stencilFunc(n.stencilFuncFront,n.stencilRefFront,n.stencilMaskFront)}if(e.stencilWriteMaskFront!==n.stencilWriteMaskFront){t.stencilMask(n.stencilWriteMaskFront)}if(e.stencilFailOpFront!==n.stencilFailOpFront||e.stencilZFailOpFront!==n.stencilZFailOpFront||e.stencilZPassOpFront!==n.stencilZPassOpFront){t.stencilOp(n.stencilFailOpFront,n.stencilZFailOpFront,n.stencilZPassOpFront)}}}function Ce(t,e,n){if(e.cullMode===n.cullMode){return}if(n.cullMode===Yt.CULL_NONE){t.disable(t.CULL_FACE);return}t.enable(t.CULL_FACE);t.cullFace(n.cullMode)}function Oe(t,e,n,r){let i=false;if(r.maxStream===-1){console.warn("VertexBuffer not assigned, please call setVertexBuffer before every draw.");return}if(n.maxStream!==r.maxStream){i=true}else if(n.program!==r.program){i=true}else{for(let t=0;t<r.maxStream+1;++t){if(n.vertexBuffers[t]!==r.vertexBuffers[t]||n.vertexBufferOffsets[t]!==r.vertexBufferOffsets[t]){i=true;break}}}if(i){for(let e=0;e<t._caps.maxVertexAttribs;++e){t._newAttributes[e]=0}for(let n=0;n<r.maxStream+1;++n){let i=r.vertexBuffers[n];let s=r.vertexBufferOffsets[n];if(!i){continue}e.bindBuffer(e.ARRAY_BUFFER,i._glID);for(let n=0;n<r.program._attributes.length;++n){let a=r.program._attributes[n];let l=i._format.element(a.name);if(!l){console.warn(`Can not find vertex attribute: ${a.name}`);continue}if(t._enabledAttributes[a.location]===0){e.enableVertexAttribArray(a.location);t._enabledAttributes[a.location]=1}t._newAttributes[a.location]=1;e.vertexAttribPointer(a.location,l.num,l.type,l.normalize,l.stride,l.offset+s*l.stride)}}for(let n=0;n<t._caps.maxVertexAttribs;++n){if(t._enabledAttributes[n]!==t._newAttributes[n]){e.disableVertexAttribArray(n);t._enabledAttributes[n]=0}}}}function Be(t,e,n){for(let r=0;r<n.textureUnits.length;++r){if(e.textureUnits[r]!==n.textureUnits[r]){let e=n.textureUnits[r];t.activeTexture(t.TEXTURE0+r);t.bindTexture(e._target,e._glID)}}}function Ne(t,e,n,r=0){if(n instanceof ae){t.framebufferTexture2D(t.FRAMEBUFFER,e,t.TEXTURE_2D,n._glID,0)}else if(n instanceof le){t.framebufferTexture2D(t.FRAMEBUFFER,e,t.TEXTURE_CUBE_MAP_POSITIVE_X+r,n._glID,0)}else{t.framebufferRenderbuffer(t.FRAMEBUFFER,e,t.RENDERBUFFER,n._glID)}}class ze{constructor(t,e){let n;e=e||{};if(e.alpha===undefined){e.alpha=false}if(e.stencil===undefined){e.stencil=true}if(e.depth===undefined){e.depth=true}if(e.antialias===undefined){e.antialias=false}if(e.preserveDrawingBuffer===undefined){e.preserveDrawingBuffer=false}try{n=t.getContext("webgl",e)}catch(t){console.error(t);return}this._gl=n;this._extensions={};this._caps={};this._stats={texture:0,vb:0,ib:0,drawcalls:0};this._current=new ue;this._next=new ue;this._uniforms={};this._vx=this._vy=this._vw=this._vh=0;this._sx=this._sy=this._sw=this._sh=0;this._framebuffer=null;this._initExtensions(["EXT_texture_filter_anisotropic","EXT_shader_texture_lod","OES_standard_derivatives","OES_texture_float","OES_texture_float_linear","OES_texture_half_float","OES_texture_half_float_linear","OES_vertex_array_object","WEBGL_compressed_texture_atc","WEBGL_compressed_texture_etc1","WEBGL_compressed_texture_pvrtc","WEBGL_compressed_texture_s3tc","WEBGL_depth_texture","WEBGL_draw_buffers"]);this._initCaps();this._initStates();this._enabledAttributes=new Array(this._caps.maxVertexAttribs);this._newAttributes=new Array(this._caps.maxVertexAttribs);for(let t=0;t<this._caps.maxVertexAttribs;++t){this._enabledAttributes[t]=0;this._newAttributes[t]=0}}_initExtensions(t){const e=this._gl;for(let n=0;n<t.length;++n){let r=t[n];try{let t=e.getExtension(r);if(t){this._extensions[r]=t}}catch(t){console.error(t)}}}_initCaps(){const t=this._gl;const e=this.ext("WEBGL_draw_buffers");this._caps.maxVertexTextures=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS);this._caps.maxFragUniforms=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS);this._caps.maxTextureUnits=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS);this._caps.maxVertexAttribs=t.getParameter(t.MAX_VERTEX_ATTRIBS);this._caps.maxDrawBuffers=e?t.getParameter(e.MAX_DRAW_BUFFERS_WEBGL):1;this._caps.maxColorAttachments=e?t.getParameter(e.MAX_COLOR_ATTACHMENTS_WEBGL):1}_initStates(){const t=this._gl;t.disable(t.BLEND);t.blendFunc(t.ONE,t.ZERO);t.blendEquation(t.FUNC_ADD);t.blendColor(1,1,1,1);t.colorMask(true,true,true,true);t.enable(t.CULL_FACE);t.cullFace(t.BACK);t.disable(t.DEPTH_TEST);t.depthFunc(t.LESS);t.depthMask(false);t.disable(t.POLYGON_OFFSET_FILL);t.depthRange(0,1);t.disable(t.STENCIL_TEST);t.stencilFunc(t.ALWAYS,0,255);t.stencilMask(255);t.stencilOp(t.KEEP,t.KEEP,t.KEEP);t.clearDepth(1);t.clearColor(0,0,0,0);t.clearStencil(0);t.disable(t.SCISSOR_TEST)}_restoreTexture(t){const e=this._gl;let n=this._current.textureUnits[t];if(n){e.bindTexture(n._target,n._glID)}else{e.bindTexture(e.TEXTURE_2D,null)}}_restoreIndexBuffer(){const t=this._gl;let e=this._current.indexBuffer;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e?e._glID:null)}ext(t){return this._extensions[t]}setFrameBuffer(t){if(this._framebuffer===t){return}this._framebuffer=t;const e=this._gl;if(t===null){e.bindFramebuffer(e.FRAMEBUFFER,null);return}e.bindFramebuffer(e.FRAMEBUFFER,t._glID);let n=this._framebuffer._colors.length;for(let t=0;t<n;++t){let n=this._framebuffer._colors[t];Ne(e,e.COLOR_ATTACHMENT0+t,n)}for(let t=n;t<this._caps.maxColorAttachments;++t){e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.TEXTURE_2D,null,0)}if(this._framebuffer._depth){Ne(e,e.DEPTH_ATTACHMENT,this._framebuffer._depth)}if(this._framebuffer._stencil){Ne(e,e.STENCIL_ATTACHMENT,t._stencil)}if(this._framebuffer._depthStencil){Ne(e,e.DEPTH_STENCIL_ATTACHMENT,t._depthStencil)}}setViewport(t,e,n,r){if(this._vx!==t||this._vy!==e||this._vw!==n||this._vh!==r){this._gl.viewport(t,e,n,r);this._vx=t;this._vy=e;this._vw=n;this._vh=r}}setScissor(t,e,n,r){if(this._sx!==t||this._sy!==e||this._sw!==n||this._sh!==r){this._gl.scissor(t,e,n,r);this._sx=t;this._sy=e;this._sw=n;this._sh=r}}clear(t){const e=this._gl;let n=0;if(t.color!==undefined){n|=e.COLOR_BUFFER_BIT;e.clearColor(t.color[0],t.color[1],t.color[2],t.color[3])}if(t.depth!==undefined){n|=e.DEPTH_BUFFER_BIT;e.clearDepth(t.depth);e.enable(e.DEPTH_TEST);e.depthMask(true);e.depthFunc(e.ALWAYS)}if(t.stencil!==undefined){n|=e.STENCIL_BUFFER_BIT;e.clearStencil(t.stencil)}e.clear(n);if(t.depth!==undefined){if(this._current.depthTest===false){e.disable(e.DEPTH_TEST)}else{if(this._current.depthWrite===false){e.depthMask(false)}if(this._current.depthFunc!==Yt.DS_FUNC_ALWAYS){e.depthFunc(this._current.depthFunc)}}}}enableBlend(){this._next.blend=true}enableDepthTest(){this._next.depthTest=true}enableDepthWrite(){this._next.depthWrite=true}enableStencilTest(){this._next.stencilTest=true}setStencilFunc(t,e,n){this._next.stencilSep=false;this._next.stencilFuncFront=this._next.stencilFuncBack=t;this._next.stencilRefFront=this._next.stencilRefBack=e;this._next.stencilMaskFront=this._next.stencilMaskBack=n}setStencilFuncFront(t,e,n){this._next.stencilSep=true;this._next.stencilFuncFront=t;this._next.stencilRefFront=e;this._next.stencilMaskFront=n}setStencilFuncBack(t,e,n){this._next.stencilSep=true;this._next.stencilFuncBack=t;this._next.stencilRefBack=e;this._next.stencilMaskBack=n}setStencilOp(t,e,n,r){this._next.stencilFailOpFront=this._next.stencilFailOpBack=t;this._next.stencilZFailOpFront=this._next.stencilZFailOpBack=e;this._next.stencilZPassOpFront=this._next.stencilZPassOpBack=n;this._next.stencilWriteMaskFront=this._next.stencilWriteMaskBack=r}setStencilOpFront(t,e,n,r){this._next.stencilSep=true;this._next.stencilFailOpFront=t;this._next.stencilZFailOpFront=e;this._next.stencilZPassOpFront=n;this._next.stencilWriteMaskFront=r}setStencilOpBack(t,e,n,r){this._next.stencilSep=true;this._next.stencilFailOpBack=t;this._next.stencilZFailOpBack=e;this._next.stencilZPassOpBack=n;this._next.stencilWriteMaskBack=r}setDepthFunc(t){this._next.depthFunc=t}setBlendColor32(t){this._next.blendColor=t}setBlendColor(t,e,n,r){this._next.blendColor=(t*255<<24|e*255<<16|n*255<<8|r*255)>>>0}setBlendFunc(t,e){this._next.blendSep=false;this._next.blendSrc=t;this._next.blendDst=e}setBlendFuncSep(t,e,n,r){this._next.blendSep=true;this._next.blendSrc=t;this._next.blendDst=e;this._next.blendSrcAlpha=n;this._next.blendDstAlpha=r}setBlendEq(t){this._next.blendSep=false;this._next.blendEq=t}setBlendEqSep(t,e){this._next.blendSep=true;this._next.blendEq=t;this._next.blendAlphaEq=e}setCullMode(t){this._next.cullMode=t}setVertexBuffer(t,e,n=0){this._next.vertexBuffers[t]=e;this._next.vertexBufferOffsets[t]=n;if(this._next.maxStream<t){this._next.maxStream=t}}setIndexBuffer(t){this._next.indexBuffer=t}setProgram(t){this._next.program=t}setTexture(t,e,n){if(n>=this._caps.maxTextureUnits){console.warn(`Can not set texture ${t} at stage ${n}, max texture exceed: ${this._caps.maxTextureUnits}`);return}this._next.textureUnits[n]=e;this.setUniform(t,n)}setTextureArray(t,e,n){let r=e.length;if(r>=this._caps.maxTextureUnits){console.warn(`Can not set ${r} textures for ${t}, max texture exceed: ${this._caps.maxTextureUnits}`);return}for(let t=0;t<r;++t){let r=n[t];this._next.textureUnits[r]=e[t]}this.setUniform(t,n)}setUniform(t,e){let n=this._uniforms[t];if(!n){n={dirty:true,value:e}}else{n.dirty=true;n.value=e}this._uniforms[t]=n}setPrimitiveType(t){this._next.primitiveType=t}draw(t,e){const n=this._gl;let r=this._current;let i=this._next;Le(n,r,i);Ie(n,r,i);De(n,r,i);Ce(n,r,i);Oe(this,n,r,i);if(r.indexBuffer!==i.indexBuffer){n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,i.indexBuffer?i.indexBuffer._glID:null)}let s=false;if(r.program!==i.program){if(i.program._linked){n.useProgram(i.program._glID)}else{console.warn("Failed to use program: has not linked yet.")}s=true}Be(n,r,i);for(let t=0;t<i.program._uniforms.length;++t){let e=i.program._uniforms[t];let r=this._uniforms[e.name];if(!r){continue}if(!s&&!r.dirty){continue}r.dirty=false;let a=e.size===undefined?Fe[e.type]:Pe[e.type];if(!a){console.warn(`Can not find commit function for uniform ${e.name}`);continue}a(n,e.location,r.value)}if(i.indexBuffer){n.drawElements(this._next.primitiveType,e,i.indexBuffer._format,t*i.indexBuffer._bytesPerIndex)}else{n.drawArrays(this._next.primitiveType,t,e)}this._stats.drawcalls+=1;r.set(i);i.reset()}}let Ue={VertexFormat:Kt,IndexBuffer:Jt,VertexBuffer:Qt,Program:ne,Texture:ie,Texture2D:ae,TextureCube:le,RenderBuffer:oe,FrameBuffer:me,Device:ze,attrTypeBytes:$t,glFilter:Zt,glTextureFmt:jt};Object.assign(Ue,Yt);class Ve{constructor(t,e,n=Ue.PT_TRIANGLES){this._vertexBuffer=t;this._indexBuffer=e;this._primitiveType=n;this._start=0;this._count=-1}getPrimitiveCount(){if(this._count!==-1){return this._count}if(this._indexBuffer){return this._indexBuffer.count}return this._vertexBuffer.count}}class ke{constructor(t){this._programName=t;this._cullMode=Ue.CULL_BACK;this._blend=false;this._blendEq=Ue.BLEND_FUNC_ADD;this._blendAlphaEq=Ue.BLEND_FUNC_ADD;this._blendSrc=Ue.BLEND_ONE;this._blendDst=Ue.BLEND_ZERO;this._blendSrcAlpha=Ue.BLEND_ONE;this._blendDstAlpha=Ue.BLEND_ZERO;this._blendColor=4294967295;this._depthTest=false;this._depthWrite=false;this._depthFunc=Ue.DS_FUNC_LESS,this._stencilTest=false;this._stencilFuncFront=Ue.DS_FUNC_ALWAYS;this._stencilRefFront=0;this._stencilMaskFront=255;this._stencilFailOpFront=Ue.STENCIL_OP_KEEP;this._stencilZFailOpFront=Ue.STENCIL_OP_KEEP;this._stencilZPassOpFront=Ue.STENCIL_OP_KEEP;this._stencilWriteMaskFront=255;this._stencilFuncBack=Ue.DS_FUNC_ALWAYS;this._stencilRefBack=0;this._stencilMaskBack=255;this._stencilFailOpBack=Ue.STENCIL_OP_KEEP;this._stencilZFailOpBack=Ue.STENCIL_OP_KEEP;this._stencilZPassOpBack=Ue.STENCIL_OP_KEEP;this._stencilWriteMaskBack=255}setCullMode(t){this._cullMode=t}setBlend(t=Ue.BLEND_FUNC_ADD,e=Ue.BLEND_ONE,n=Ue.BLEND_ZERO,r=Ue.BLEND_FUNC_ADD,i=Ue.BLEND_ONE,s=Ue.BLEND_ZERO,a=4294967295){this._blend=true;this._blendEq=t;this._blendSrc=e;this._blendDst=n;this._blendAlphaEq=r;this._blendSrcAlpha=i;this._blendDstAlpha=s;this._blendColor=a}setDepth(t=false,e=false,n=Ue.DS_FUNC_LESS){this._depthTest=t;this._depthWrite=e;this._depthFunc=n}setStencilFront(t=Ue.DS_FUNC_ALWAYS,e=0,n=255,r=Ue.STENCIL_OP_KEEP,i=Ue.STENCIL_OP_KEEP,s=Ue.STENCIL_OP_KEEP,a=255){this._stencilTest=true;this._stencilFuncFront=t;this._stencilRefFront=e;this._stencilMaskFront=n;this._stencilFailOpFront=r;this._stencilZFailOpFront=i;this._stencilZPassOpFront=s;this._stencilWriteMaskFront=a}setStencilBack(t=Ue.DS_FUNC_ALWAYS,e=0,n=255,r=Ue.STENCIL_OP_KEEP,i=Ue.STENCIL_OP_KEEP,s=Ue.STENCIL_OP_KEEP,a=255){this._stencilTest=true;this._stencilFuncBack=t;this._stencilRefBack=e;this._stencilMaskBack=n;this._stencilFailOpBack=r;this._stencilZFailOpBack=i;this._stencilZPassOpBack=s;this._stencilWriteMaskBack=a}}let qe=0;let Xe={};var We={addStage:function(t){if(Xe[t]!==undefined){return}let e=1<<qe;Xe[t]=e;qe+=1},stageID:function(t){let e=Xe[t];if(e===undefined){return-1}return e},stageIDs:function(t){let e=0;for(let n=0;n<t.length;++n){let r=Xe[t[n]];if(r!==undefined){e|=r}}return e}};let Ge=0;class He{constructor(t,e,n,r=0){this._id=Ge++;this._stageIDs=We.stageIDs(t);this._parameters=e;this._passes=n;this._layer=r}setStages(t){this._stageIDs=We.stageIDs(t)}get passes(){return this._passes}get stageIDs(){return this._stageIDs}}class Ye{constructor(t,e={},n=[]){this._techniques=t;this._properties=e;this._defines=n}clear(){this._techniques.length=0;this._properties=null;this._defines.length=0}getTechnique(t){let e=We.stageID(t);for(let t=0;t<this._techniques.length;++t){let n=this._techniques[t];if(n.stageIDs&e){return n}}return null}getProperty(t){return this._properties[t]}setProperty(t,e){this._properties[t]=e}getDefine(t){for(let e=0;e<this._defines.length;++e){let n=this._defines[e];if(n.name===t){return n.value}}console.warn(`Failed to get define ${t}, define not found.`);return null}define(t,e){for(let n=0;n<this._defines.length;++n){let r=this._defines[n];if(r.name===t){r.value=e;return}}console.warn(`Failed to set define ${t}, define not found.`)}extractDefines(t={}){for(let e=0;e<this._defines.length;++e){let n=this._defines[e];t[n.name]=n.value}return t}}function $e(t,e){if(!e.positions){console.error("The data must have positions field");return null}let n=[];let r=e.positions.length/3;for(let t=0;t<r;++t){n.push(e.positions[3*t],e.positions[3*t+1],e.positions[3*t+2]);if(e.normals){n.push(e.normals[3*t],e.normals[3*t+1],e.normals[3*t+2])}if(e.uvs){n.push(e.uvs[2*t],e.uvs[2*t+1])}}let i=[];i.push({name:Ue.ATTR_POSITION,type:Ue.ATTR_TYPE_FLOAT32,num:3});if(e.normals){i.push({name:Ue.ATTR_NORMAL,type:Ue.ATTR_TYPE_FLOAT32,num:3})}if(e.uvs){i.push({name:Ue.ATTR_UV0,type:Ue.ATTR_TYPE_FLOAT32,num:2})}let s=new Ue.VertexBuffer(t,new Ue.VertexFormat(i),Ue.USAGE_STATIC,new Float32Array(n),r);let a=null;if(e.indices){a=new Ue.IndexBuffer(t,Ue.INDEX_FMT_UINT16,Ue.USAGE_STATIC,new Uint16Array(e.indices),e.indices.length)}return new Ve(s,a)}let Ze=at.create();let je=0;class Ke{constructor(){this._id=je++;this._rect={x:0,y:0,w:1,h:1};this._color=ct.new(.3,.3,.3,1);this._depth=1;this._stencil=1;this._clearFlags=dt.CLEAR_COLOR|dt.CLEAR_DEPTH;this._matView=at.create();this._matProj=at.create();this._matViewProj=at.create();this._matInvViewProj=at.create();this._stages=[];this._cullingByID=false;this._framebuffer=null;this._shadowLight=null}getForward(t){return q.set(t,-this._matView.m02,-this._matView.m06,-this._matView.m10)}getPosition(t){at.invert(Ze,this._matView);return at.getTranslation(t,Ze)}}const Je=q.new(0,0,-1);let Qe=at.create();let tn=$.create();let en=q.create();function nn(t,e,n){t._node.getWorldRT(e);at.invert(e,e);at.perspective(n,t._spotAngle*t._spotAngleScale,1,t._shadowMinDepth,t._shadowMaxDepth)}function rn(t,e,n){t._node.getWorldRT(e);at.invert(e,e);let r=t._shadowFustumSize/2;at.ortho(n,-r,r,-r,r,t._shadowMinDepth,t._shadowMaxDepth)}function sn(t,e,n){}class an{constructor(){this._poolID=-1;this._node=null;this._type=dt.LIGHT_DIRECTIONAL;this._color=mt.new(1,1,1);this._intensity=1;this._range=1;this._spotAngle=o(60);this._spotExp=1;this._directionUniform=new Float32Array(3);this._positionUniform=new Float32Array(3);this._colorUniform=new Float32Array([this._color.r*this._intensity,this._color.g*this._intensity,this._color.b*this._intensity]);this._spotUniform=new Float32Array([Math.cos(this._spotAngle*.5),this._spotExp]);this._shadowType=dt.SHADOW_NONE;this._shadowFrameBuffer=null;this._shadowMap=null;this._shadowMapDirty=false;this._shadowDepthBuffer=null;this._shadowResolution=1024;this._shadowBias=5e-5;this._shadowDarkness=1;this._shadowMinDepth=1;this._shadowMaxDepth=1e3;this._shadowDepthScale=50;this._frustumEdgeFalloff=0;this._viewProjMatrix=at.create();this._spotAngleScale=1;this._shadowFustumSize=80}setNode(t){this._node=t}setColor(t,e,n){mt.set(this._color,t,e,n);this._colorUniform[0]=t*this._intensity;this._colorUniform[1]=e*this._intensity;this._colorUniform[2]=n*this._intensity}get color(){return this._color}setIntensity(t){this._intensity=t;this._colorUniform[0]=t*this._color.r;this._colorUniform[1]=t*this._color.g;this._colorUniform[2]=t*this._color.b}get intensity(){return this._intensity}setType(t){this._type=t}get type(){return this._type}setSpotAngle(t){this._spotAngle=t;this._spotUniform[0]=Math.cos(this._spotAngle*.5)}get spotAngle(){return this._spotAngle}setSpotExp(t){this._spotExp=t;this._spotUniform[1]=t}get spotExp(){return this._spotExp}setRange(t){this._range=t}get range(){return this._range}setShadowType(t){if(this._shadowType===dt.SHADOW_NONE&&t!==dt.SHADOW_NONE){this._shadowMapDirty=true}this._shadowType=t}get shadowType(){return this._shadowType}get shadowMap(){return this._shadowMap}get viewProjMatrix(){return this._viewProjMatrix}setShadowResolution(t){if(this._shadowResolution!==t){this._shadowMapDirty=true}this._shadowResolution=t}get shadowResolution(){return this._shadowResolution}setShadowBias(t){this._shadowBias=t}get shadowBias(){return this._shadowBias}setShadowDarkness(t){this._shadowDarkness=t}get shadowDarkness(){return this._shadowDarkness}setShadowMinDepth(t){this._shadowMinDepth=t}get shadowMinDepth(){if(this._type===dt.LIGHT_DIRECTIONAL){return 1}return this._shadowMinDepth}setShadowMaxDepth(t){this._shadowMaxDepth=t}get shadowMaxDepth(){if(this._type===dt.LIGHT_DIRECTIONAL){return 1}return this._shadowMaxDepth}setShadowDepthScale(t){this._shadowDepthScale=t}get shadowDepthScale(){return this._shadowDepthScale}setFrustumEdgeFalloff(t){this._frustumEdgeFalloff=t}get frustumEdgeFalloff(){return this._frustumEdgeFalloff}extractView(t,e){t._shadowLight=this;t._rect.x=0;t._rect.y=0;t._rect.w=this._shadowResolution;t._rect.h=this._shadowResolution;ct.set(t._color,1,1,1,1);t._depth=1;t._stencil=1;t._clearFlags=dt.CLEAR_COLOR|dt.CLEAR_DEPTH;t._stages=e;t._framebuffer=this._shadowFrameBuffer;switch(this._type){case dt.LIGHT_SPOT:nn(this,t._matView,t._matProj);break;case dt.LIGHT_DIRECTIONAL:rn(this,t._matView,t._matProj);break;case dt.LIGHT_POINT:sn(this,t._matView,t._matProj);break;default:console.warn("shadow of this light type is not supported")}at.mul(t._matViewProj,t._matProj,t._matView);this._viewProjMatrix=t._matViewProj;at.invert(t._matInvViewProj,t._matViewProj)}_updateLightPositionAndDirection(){this._node.getWorldMatrix(Qe);$.fromMat4(tn,Qe);q.transformMat3(en,Je,tn);q.array(this._directionUniform,en);let t=this._positionUniform;t[0]=Qe.m12;t[1]=Qe.m13;t[2]=Qe.m14}_generateShadowMap(t){this._shadowMap=new Ue.Texture2D(t,{width:this._shadowResolution,height:this._shadowResolution,format:Ue.TEXTURE_FMT_RGBA8,wrapS:Ue.WRAP_CLAMP,wrapT:Ue.WRAP_CLAMP});this._shadowDepthBuffer=new Ue.RenderBuffer(t,Ue.RB_FMT_D16,this._shadowResolution,this._shadowResolution);this._shadowFrameBuffer=new Ue.FrameBuffer(t,this._shadowResolution,this._shadowResolution,{colors:[this._shadowMap],depth:this._shadowDepthBuffer})}_destroyShadowMap(){if(this._shadowMap){this._shadowMap.destroy();this._shadowDepthBuffer.destroy();this._shadowFrameBuffer.destroy();this._shadowMap=null;this._shadowDepthBuffer=null;this._shadowFrameBuffer=null}}update(t){this._updateLightPositionAndDirection();if(this._shadowType===dt.SHADOW_NONE){this._destroyShadowMap()}else if(this._shadowMapDirty){this._destroyShadowMap();this._generateShadowMap(t);this._shadowMapDirty=false}}}let ln=at.create();let on=at.create();let mn=at.create();let hn=at.create();let un=q.create();class cn{constructor(){this._poolID=-1;this._node=null;this._projection=dt.PROJ_PERSPECTIVE;this._color=ct.new(.2,.3,.47,1);this._depth=1;this._stencil=1;this._clearFlags=dt.CLEAR_COLOR|dt.CLEAR_DEPTH;this._stages=[];this._framebuffer=null;this._near=.01;this._far=1e3;this._fov=Math.PI/4;this._rect={x:0,y:0,w:1,h:1};this._orthoHeight=10}getNode(){return this._node}setNode(t){this._node=t}getType(){return this._projection}setType(t){this._projection=t}getOrthoHeight(){return this._orthoHeight}setOrthoHeight(t){this._orthoHeight=t}getFov(){return this._fov}setFov(t){this._fov=t}getNear(){return this._near}setNear(t){this._near=t}getFar(){return this._far}setFar(t){this._far=t}getColor(t){return ct.copy(t,this._color)}setColor(t,e,n,r){ct.set(this._color,t,e,n,r)}getDepth(){return this._depth}setDepth(t){this._depth=t}getStencil(){return this._stencil}setStencil(t){this._stencil=t}getClearFlags(){return this._clearFlags}setClearFlags(t){this._clearFlags=t}getRect(t){t.x=this._rect.x;t.y=this._rect.y;t.w=this._rect.w;t.h=this._rect.h;return t}setRect(t,e,n,r){this._rect.x=t;this._rect.y=e;this._rect.w=n;this._rect.h=r}getStages(){return this._stages}setStages(t){this._stages=t}getFramebuffer(){return this._framebuffer}setFramebuffer(t){this._framebuffer=t}extractView(t,e,n){t._rect.x=this._rect.x*e;t._rect.y=this._rect.y*n;t._rect.w=this._rect.w*e;t._rect.h=this._rect.h*n;t._color=this._color;t._depth=this._depth;t._stencil=this._stencil;t._clearFlags=this._clearFlags;t._stages=this._stages;t._framebuffer=this._framebuffer;this._node.getWorldRT(t._matView);at.invert(t._matView,t._matView);let r=e/n;if(this._projection===dt.PROJ_PERSPECTIVE){at.perspective(t._matProj,this._fov,r,this._near,this._far)}else{let e=this._orthoHeight*r;let n=this._orthoHeight;at.ortho(t._matProj,-e,e,-n,n,this._near,this._far)}at.mul(t._matViewProj,t._matProj,t._matView);at.invert(t._matInvViewProj,t._matViewProj)}screenToWorld(t,e,n,r){let i=n/r;let s=this._rect.x*n;let a=this._rect.y*r;let l=this._rect.w*n;let o=this._rect.h*r;this._node.getWorldRT(ln);at.invert(ln,ln);if(this._projection===dt.PROJ_PERSPECTIVE){at.perspective(on,this._fov,i,this._near,this._far)}else{let t=this._orthoHeight*i;let e=this._orthoHeight;at.ortho(on,-t,t,-e,e,this._near,this._far)}at.mul(mn,on,ln);at.invert(hn,mn);if(this._projection===dt.PROJ_PERSPECTIVE){q.set(t,(e.x-s)*2/l-1,(e.y-a)*2/o-1,1);q.transformMat4(t,t,hn);this._node.getWorldPos(un);q.lerp(t,un,t,e.z/this._far)}else{let n=this._farClip-this._nearClip;q.set(t,(e.x-s)*2/l-1,(e.y-a)*2/o-1,(this._far-e.z)/n*2-1);q.transformMat4(t,t,hn)}return t}worldToScreen(t,e,n,r){let i=n/r;let s=this._rect.x*n;let a=this._rect.y*r;let l=this._rect.w*n;let o=this._rect.h*r;this._node.getWorldRT(ln);at.invert(ln,ln);if(this._projection===dt.PROJ_PERSPECTIVE){at.perspective(on,this._fov,i,this._near,this._far)}else{let t=this._orthoHeight*i;let e=this._orthoHeight;at.ortho(on,-t,t,-e,e,this._near,this._far)}at.mul(mn,on,ln);let m=e.x*mn.m03+e.y*mn.m07+e.z*mn.m11+mn.m15;q.transformMat4(t,e,mn);t.x=s+(t.x/m+1)*.5*l;t.y=a+(t.y/m+1)*.5*o;return t}}class fn{constructor(){this._poolID=-1;this._node=null;this._inputAssemblers=[];this._effects=[];this._defines=[];this._dynamicIA=false;this._viewID=-1}get inputAssemblerCount(){return this._inputAssemblers.length}get dynamicIA(){return this._dynamicIA}get drawItemCount(){return this._dynamicIA?1:this._inputAssemblers.length}setNode(t){this._node=t}setDynamicIA(t){this._dynamicIA=t}addInputAssembler(t){if(this._inputAssemblers.indexOf(t)!==-1){return}this._inputAssemblers.push(t)}clearInputAssemblers(){this._inputAssemblers.length=0}addEffect(t){if(this._effects.indexOf(t)!==-1){return}this._effects.push(t);let e=Object.create(null);t.extractDefines(e);this._defines.push(e)}clearEffects(){this._effects.length=0;this._defines.length=0}extractDrawItem(t,e){if(this._dynamicIA){t.model=this;t.node=this._node;t.ia=null;t.effect=this._effects[0];t.defines=t.effect.extractDefines(this._defines[0]);return}if(e>=this._inputAssemblers.length){t.model=null;t.node=null;t.ia=null;t.effect=null;t.defines=null;return}t.model=this;t.node=this._node;t.ia=this._inputAssemblers[e];let n,r;if(e<this._effects.length){n=this._effects[e];r=this._defines[e]}else{n=this._effects[this._effects.length-1];r=this._defines[this._effects.length-1]}t.effect=n;t.defines=n.extractDefines(r)}}const _n=32;const dn=7;const pn=256;const xn=[1,10,100,1e3,1e4,1e5,1e6,1e7,1e8,1e9];function gn(t){if(t<1e5){if(t<100){return t<10?0:1}if(t<1e4){return t<1e3?2:3}return 4}if(t<1e7){return t<1e6?5:6}if(t<1e9){return t<1e8?7:8}return 9}function Tn(t,e){if(t===e){return 0}if(~~t===t&&~~e===e){if(t===0||e===0){return t<e?-1:1}if(t<0||e<0){if(e>=0){return-1}if(t>=0){return 1}t=-t;e=-e}const n=gn(t);const r=gn(e);let i=0;if(n<r){t*=xn[r-n-1];e/=10;i=-1}else if(n>r){e*=xn[n-r-1];t/=10;i=1}if(t===e){return i}return t<e?-1:1}let n=String(t);let r=String(e);if(n===r){return 0}return n<r?-1:1}function En(t){let e=0;while(t>=_n){e|=t&1;t>>=1}return t+e}function An(t,e,n,r){let i=e+1;if(i===n){return 1}if(r(t[i++],t[e])<0){while(i<n&&r(t[i],t[i-1])<0){i++}Mn(t,e,i)}else{while(i<n&&r(t[i],t[i-1])>=0){i++}}return i-e}function Mn(t,e,n){n--;while(e<n){let r=t[e];t[e++]=t[n];t[n--]=r}}function yn(t,e,n,r,i){if(r===e){r++}for(;r<n;r++){let n=t[r];let s=e;let a=r;while(s<a){let e=s+a>>>1;if(i(n,t[e])<0){a=e}else{s=e+1}}let l=r-s;switch(l){case 3:t[s+3]=t[s+2];case 2:t[s+2]=t[s+1];case 1:t[s+1]=t[s];break;default:while(l>0){t[s+l]=t[s+l-1];l--}}t[s]=n}}function Sn(t,e,n,r,i,s){let a=0;let l=0;let o=1;if(s(t,e[n+i])>0){l=r-i;while(o<l&&s(t,e[n+i+o])>0){a=o;o=(o<<1)+1;if(o<=0){o=l}}if(o>l){o=l}a+=i;o+=i}else{l=i+1;while(o<l&&s(t,e[n+i-o])<=0){a=o;o=(o<<1)+1;if(o<=0){o=l}}if(o>l){o=l}let r=a;a=i-o;o=i-r}a++;while(a<o){let r=a+(o-a>>>1);if(s(t,e[n+r])>0){a=r+1}else{o=r}}return o}function bn(t,e,n,r,i,s){let a=0;let l=0;let o=1;if(s(t,e[n+i])<0){l=i+1;while(o<l&&s(t,e[n+i-o])<0){a=o;o=(o<<1)+1;if(o<=0){o=l}}if(o>l){o=l}let r=a;a=i-o;o=i-r}else{l=r-i;while(o<l&&s(t,e[n+i+o])>=0){a=o;o=(o<<1)+1;if(o<=0){o=l}}if(o>l){o=l}a+=i;o+=i}a++;while(a<o){let r=a+(o-a>>>1);if(s(t,e[n+r])<0){o=r}else{a=r+1}}return o}class Rn{constructor(t,e){this.array=t;this.compare=e;this.minGallop=dn;this.length=t.length;this.tmpStorageLength=pn;if(this.length<2*pn){this.tmpStorageLength=this.length>>>1}this.tmp=new Array(this.tmpStorageLength);this.stackLength=this.length<120?5:this.length<1542?10:this.length<119151?19:40;this.runStart=new Array(this.stackLength);this.runLength=new Array(this.stackLength);this.stackSize=0}pushRun(t,e){this.runStart[this.stackSize]=t;this.runLength[this.stackSize]=e;this.stackSize+=1}mergeRuns(){while(this.stackSize>1){let t=this.stackSize-2;if(t>=1&&this.runLength[t-1]<=this.runLength[t]+this.runLength[t+1]||t>=2&&this.runLength[t-2]<=this.runLength[t]+this.runLength[t-1]){if(this.runLength[t-1]<this.runLength[t+1]){t--}}else if(this.runLength[t]>this.runLength[t+1]){break}this.mergeAt(t)}}forceMergeRuns(){while(this.stackSize>1){let t=this.stackSize-2;if(t>0&&this.runLength[t-1]<this.runLength[t+1]){t--}this.mergeAt(t)}}mergeAt(t){let e=this.compare;let n=this.array;let r=this.runStart[t];let i=this.runLength[t];let s=this.runStart[t+1];let a=this.runLength[t+1];this.runLength[t]=i+a;if(t===this.stackSize-3){this.runStart[t+1]=this.runStart[t+2];this.runLength[t+1]=this.runLength[t+2]}this.stackSize--;let l=bn(n[s],n,r,i,0,e);r+=l;i-=l;if(i===0){return}a=Sn(n[r+i-1],n,s,a,a-1,e);if(a===0){return}if(i<=a){this.mergeLow(r,i,s,a)}else{this.mergeHigh(r,i,s,a)}}mergeLow(t,e,n,r){let i=this.compare;let s=this.array;let a=this.tmp;let l=0;for(l=0;l<e;l++){a[l]=s[t+l]}let o=0;let m=n;let h=t;s[h++]=s[m++];if(--r===0){for(l=0;l<e;l++){s[h+l]=a[o+l]}return}if(e===1){for(l=0;l<r;l++){s[h+l]=s[m+l]}s[h+r]=a[o];return}let u=this.minGallop;while(true){let t=0;let n=0;let c=false;do{if(i(s[m],a[o])<0){s[h++]=s[m++];n++;t=0;if(--r===0){c=true;break}}else{s[h++]=a[o++];t++;n=0;if(--e===1){c=true;break}}}while((t|n)<u);if(c){break}do{t=bn(s[m],a,o,e,0,i);if(t!==0){for(l=0;l<t;l++){s[h+l]=a[o+l]}h+=t;o+=t;e-=t;if(e<=1){c=true;break}}s[h++]=s[m++];if(--r===0){c=true;break}n=Sn(a[o],s,m,r,0,i);if(n!==0){for(l=0;l<n;l++){s[h+l]=s[m+l]}h+=n;m+=n;r-=n;if(r===0){c=true;break}}s[h++]=a[o++];if(--e===1){c=true;break}u--}while(t>=dn||n>=dn);if(c){break}if(u<0){u=0}u+=2}this.minGallop=u;if(u<1){this.minGallop=1}if(e===1){for(l=0;l<r;l++){s[h+l]=s[m+l]}s[h+r]=a[o]}else if(e===0){throw new Error("mergeLow preconditions were not respected")}else{for(l=0;l<e;l++){s[h+l]=a[o+l]}}}mergeHigh(t,e,n,r){let i=this.compare;let s=this.array;let a=this.tmp;let l=0;for(l=0;l<r;l++){a[l]=s[n+l]}let o=t+e-1;let m=r-1;let h=n+r-1;let u=0;let c=0;s[h--]=s[o--];if(--e===0){u=h-(r-1);for(l=0;l<r;l++){s[u+l]=a[l]}return}if(r===1){h-=e;o-=e;c=h+1;u=o+1;for(l=e-1;l>=0;l--){s[c+l]=s[u+l]}s[h]=a[m];return}let f=this.minGallop;while(true){let n=0;let _=0;let d=false;do{if(i(a[m],s[o])<0){s[h--]=s[o--];n++;_=0;if(--e===0){d=true;break}}else{s[h--]=a[m--];_++;n=0;if(--r===1){d=true;break}}}while((n|_)<f);if(d){break}do{n=e-bn(a[m],s,t,e,e-1,i);if(n!==0){h-=n;o-=n;e-=n;c=h+1;u=o+1;for(l=n-1;l>=0;l--){s[c+l]=s[u+l]}if(e===0){d=true;break}}s[h--]=a[m--];if(--r===1){d=true;break}_=r-Sn(s[o],a,0,r,r-1,i);if(_!==0){h-=_;m-=_;r-=_;c=h+1;u=m+1;for(l=0;l<_;l++){s[c+l]=a[u+l]}if(r<=1){d=true;break}}s[h--]=s[o--];if(--e===0){d=true;break}f--}while(n>=dn||_>=dn);if(d){break}if(f<0){f=0}f+=2}this.minGallop=f;if(f<1){this.minGallop=1}if(r===1){h-=e;o-=e;c=h+1;u=o+1;for(l=e-1;l>=0;l--){s[c+l]=s[u+l]}s[h]=a[m]}else if(r===0){throw new Error("mergeHigh preconditions were not respected")}else{u=h-(r-1);for(l=0;l<r;l++){s[u+l]=a[l]}}}}var wn=function(t,e,n,r){if(!Array.isArray(t)){throw new TypeError("Can only sort arrays")}if(e===undefined){e=0}if(n===undefined){n=t.length}if(r===undefined){r=Tn}let i=n-e;if(i<2){return}let s=0;if(i<_n){s=An(t,e,n,r);yn(t,e,n,e+s,r);return}let a=new Rn(t,r);let l=En(i);do{s=An(t,e,n,r);if(s<l){let n=i;if(n>l){n=l}yn(t,e,e+n,e+s,r);s=n}a.pushRun(e,s);a.mergeRuns();i-=s;e+=s}while(i!==0);a.forceMergeRuns()};class vn{constructor(t){this._count=0;this._data=new Array(t)}_resize(t){if(t>this._data.length){for(let e=this._data.length;e<t;++e){this._data[e]=undefined}}}get length(){return this._count}get data(){return this._data}reset(){for(let t=0;t<this._count;++t){this._data[t]=undefined}this._count=0}push(t){if(this._count>=this._data.length){this._resize(this._data.length*2)}this._data[this._count]=t;++this._count}pop(){--this._count;if(this._count<0){this._count=0}let t=this._data[this._count];this._data[this._count]=undefined;return t}fastRemove(t){if(t>=this._count){return}let e=this._count-1;this._data[t]=this._data[e];this._data[e]=undefined;this._count-=1}indexOf(t){let e=this._data.indexOf(t);if(e>=this._count){return-1}return e}sort(t){return wn(this._data,0,this._count,t)}}class Fn{constructor(t,e){this._fn=t;this._idx=e-1;this._frees=new Array(e);for(let n=0;n<e;++n){this._frees[n]=t()}}_expand(t){let e=this._frees;this._frees=new Array(t);let n=t-e.length;for(let t=0;t<n;++t){this._frees[t]=this._fn()}for(let r=n,i=0;r<t;++r,++i){this._frees[r]=e[i]}this._idx+=n}alloc(){if(this._idx<0){this._expand(Math.round(this._frees.length*1.2)+1)}let t=this._frees[this._idx];this._frees[this._idx]=null;--this._idx;return t}free(t){++this._idx;this._frees[this._idx]=t}}class Pn{constructor(t,e){this._fn=t;this._count=0;this._data=new Array(e);for(let n=0;n<e;++n){this._data[n]=t()}}get length(){return this._count}get data(){return this._data}reset(){this._count=0}resize(t){if(t>this._data.length){for(let e=this._data.length;e<t;++e){this._data[e]=this._fn()}}}add(){if(this._count>=this._data.length){this.resize(this._data.length*2)}return this._data[this._count++]}remove(t){if(t>=this._count){return}let e=this._count-1;let n=this._data[t];this._data[t]=this._data[e];this._data[e]=n;this._count-=1}sort(t){return wn(this._data,0,this._count,t)}}let Ln=Array(8);for(let t=0;t<8;++t){Ln[t]=[]}class In{constructor(){this._lights=new vn(16);this._models=new vn(16);this._cameras=new vn(16);this._debugCamera=null;this._views=[]}_add(t,e){if(e._poolID!==-1){return}t.push(e);e._poolID=t.length-1}_remove(t,e){if(e._poolID===-1){return}t.data[t.length-1]._poolID=e._poolID;t.fastRemove(e._poolID);e._poolID=-1}reset(){for(let t=0;t<this._models.length;++t){let e=this._models.data[t];e._viewID=-1}}setDebugCamera(t){this._debugCamera=t}getCameraCount(){return this._cameras.length}getCamera(t){return this._cameras.data[t]}addCamera(t){this._add(this._cameras,t)}removeCamera(t){this._remove(this._cameras,t)}getModelCount(){return this._models.length}getModel(t){return this._models.data[t]}addModel(t){this._add(this._models,t)}removeModel(t){this._remove(this._models,t)}getLightCount(){return this._lights.length}getLight(t){return this._lights.data[t]}addLight(t){this._add(this._lights,t)}removeLight(t){this._remove(this._lights,t)}addView(t){if(this._views.indexOf(t)===-1){this._views.push(t)}}removeView(t){let e=this._views.indexOf(t);if(e!==-1){this._views.splice(e,1)}}}let Dn=0;function Cn(t){let e=[];for(let n in t){if(t[n]===true){e.push(`#define ${n}`)}}return e.join("\n")}function On(t,e){let n={};let r=t;for(let t in e){if(Number.isInteger(e[t])){n[t]=e[t]}}for(let t in n){let e=new RegExp(t,"g");r=r.replace(e,n[t])}return r}function Bn(t){let e=/#pragma for (\w+) in range\(\s*(\d+)\s*,\s*(\d+)\s*\)([\s\S]+?)#pragma endFor/g;function n(t,e,n,r,i){let s="";let a=parseInt(n);let l=parseInt(r);if(a.isNaN||l.isNaN){console.error("Unroll For Loops Error: begin and end of range must be an int num.")}for(let t=a;t<l;++t){s+=i.replace(new RegExp(`{${e}}`,"g"),t)}return s}return t.replace(e,n)}class Nn{constructor(t,e=[],n={}){this._device=t;this._precision=`precision highp float;\n`;this._templates={};for(let t=0;t<e.length;++t){let n=e[t];this.define(n.name,n.vert,n.frag,n.defines)}this._chunks={};Object.assign(this._chunks,n);this._cache={}}define(t,e,n,r){if(this._templates[t]){console.warn(`Failed to define shader ${t}: already exists.`);return}let i=++Dn;let s=0;for(let t=0;t<r.length;++t){let e=r[t];e._offset=s;let n=1;if(e.min!==undefined&&e.max!==undefined){n=Math.ceil((e.max-e.min)*.5);e._map=function(t){return t-this._min<<e._offset}.bind(e)}else{e._map=function(t){if(t){return 1<<e._offset}return 0}.bind(e)}s+=n;e._offset=s}e=this._precision+e;n=this._precision+n;this._templates[t]={id:i,name:t,vert:e,frag:n,defines:r}}getKey(t,e){let n=this._templates[t];let r=0;for(let t=0;t<n.defines.length;++t){let i=n.defines[t];let s=e[i.name];if(s===undefined){continue}r|=i._map(s)}return r<<8|n.id}getProgram(t,e){let n=this.getKey(t,e);let r=this._cache[n];if(r){return r}let i=this._templates[t];let s=Cn(e)+"\n";let a=On(i.vert,e);a=s+Bn(a);let l=On(i.frag,e);l=s+Bn(l);r=new Ue.Program(this._device,{vert:a,frag:l});r.link();this._cache[n]=r;return r}}let zn=$.create();let Un=at.create();let Vn=new Pn(()=>{return{stage:null,items:null}},8);let kn=new Pn(()=>{return new Float32Array(2)},8);let qn=new Pn(()=>{return new Float32Array(3)},8);let Xn=new Pn(()=>{return new Float32Array(4)},8);let Wn=new Pn(()=>{return new Float32Array(9)},8);let Gn=new Pn(()=>{return new Float32Array(16)},8);let Hn=new Pn(()=>{return new Float32Array(64)},8);let Yn=new Pn(()=>{return new Int32Array(2)},8);let $n=new Pn(()=>{return new Int32Array(3)},8);let Zn=new Pn(()=>{return new Int32Array(4)},8);let jn=new Pn(()=>{return new Int32Array(64)},8);let Kn={[dt.PARAM_INT]:function(t){return t},[dt.PARAM_INT2]:function(t){return U.array(Yn.add(),t)},[dt.PARAM_INT3]:function(t){return q.array($n.add(),t)},[dt.PARAM_INT4]:function(t){return G.array(Zn.add(),t)},[dt.PARAM_FLOAT]:function(t){return t},[dt.PARAM_FLOAT2]:function(t){return U.array(kn.add(),t)},[dt.PARAM_FLOAT3]:function(t){return q.array(qn.add(),t)},[dt.PARAM_FLOAT4]:function(t){return G.array(Xn.add(),t)},[dt.PARAM_COLOR3]:function(t){return mt.array(qn.add(),t)},[dt.PARAM_COLOR4]:function(t){return ct.array(Xn.add(),t)},[dt.PARAM_MAT2]:function(t){return tt.array(Xn.add(),t)},[dt.PARAM_MAT3]:function(t){return $.array(Wn.add(),t)},[dt.PARAM_MAT4]:function(t){return at.array(Gn.add(),t)}};let Jn={[dt.PARAM_INT]:{func(t){let e=jn.add();for(let n=0;n<t.length;++n){e[n]=t[n]}return e},size:1},[dt.PARAM_INT2]:{func(t){let e=jn.add();for(let n=0;n<t.length;++n){e[2*n]=t[n].x;e[2*n+1]=t[n].y}return e},size:2},[dt.PARAM_INT3]:{func:undefined,size:3},[dt.PARAM_INT4]:{func(t){let e=jn.add();for(let n=0;n<t.length;++n){let r=t[n];e[4*n]=r.x;e[4*n+1]=r.y;e[4*n+2]=r.z;e[4*n+3]=r.w}return e},size:4},[dt.PARAM_FLOAT]:{func(t){let e=Hn.add();for(let n=0;n<t.length;++n){e[n]=t[n]}return e},size:1},[dt.PARAM_FLOAT2]:{func(t){let e=Hn.add();for(let n=0;n<t.length;++n){e[2*n]=t[n].x;e[2*n+1]=t[n].y}return e},size:2},[dt.PARAM_FLOAT3]:{func:undefined,size:3},[dt.PARAM_FLOAT4]:{func(t){let e=Hn.add();for(let n=0;n<t.length;++n){let r=t[n];e[4*n]=r.x;e[4*n+1]=r.y;e[4*n+2]=r.z;e[4*n+3]=r.w}return e},size:4},[dt.PARAM_COLOR3]:{func:undefined,size:3},[dt.PARAM_COLOR4]:{func(t){let e=Hn.add();for(let n=0;n<t.length;++n){let r=t[n];e[4*n]=r.r;e[4*n+1]=r.g;e[4*n+2]=r.b;e[4*n+3]=r.a}return e},size:4},[dt.PARAM_MAT2]:{func(t){let e=Hn.add();for(let n=0;n<t.length;++n){let r=t[n];e[4*n]=r.m00;e[4*n+1]=r.m01;e[4*n+2]=r.m02;e[4*n+3]=r.m03}return e},size:4},[dt.PARAM_MAT3]:{func:undefined,size:9},[dt.PARAM_MAT4]:{func(t){let e=Hn.add();for(let n=0;n<t.length;++n){let r=t[n];e[16*n]=r.m00;e[16*n+1]=r.m01;e[16*n+2]=r.m02;e[16*n+3]=r.m03;e[16*n+4]=r.m04;e[16*n+5]=r.m05;e[16*n+6]=r.m06;e[16*n+7]=r.m07;e[16*n+8]=r.m08;e[16*n+9]=r.m09;e[16*n+10]=r.m10;e[16*n+11]=r.m11;e[16*n+12]=r.m12;e[16*n+13]=r.m13;e[16*n+14]=r.m14;e[16*n+15]=r.m15}return e},size:16}};class Qn{constructor(t,e){this._device=t;this._programLib=new Nn(t,e.programTemplates,e.programChunks);this._opts=e;this._type2defaultValue={[dt.PARAM_INT]:0,[dt.PARAM_INT2]:U.new(0,0),[dt.PARAM_INT3]:q.new(0,0,0),[dt.PARAM_INT4]:G.new(0,0,0,0),[dt.PARAM_FLOAT]:0,[dt.PARAM_FLOAT2]:U.new(0,0),[dt.PARAM_FLOAT3]:q.new(0,0,0),[dt.PARAM_FLOAT4]:G.new(0,0,0,0),[dt.PARAM_COLOR3]:mt.new(0,0,0),[dt.PARAM_COLOR4]:ct.new(0,0,0,1),[dt.PARAM_MAT2]:tt.create(),[dt.PARAM_MAT3]:$.create(),[dt.PARAM_MAT4]:at.create(),[dt.PARAM_TEXTURE_2D]:e.defaultTexture,[dt.PARAM_TEXTURE_CUBE]:e.defaultTextureCube};this._stage2fn={};this._usedTextureUnits=0;this._viewPools=new Pn(()=>{return new Ke},8);this._drawItemsPools=new Pn(()=>{return{model:null,node:null,ia:null,effect:null,defines:null}},100);this._stageItemsPools=new Pn(()=>{return new Pn(()=>{return{model:null,node:null,ia:null,effect:null,defines:null,technique:null,sortKey:-1}},100)},16)}_resetTextuerUnit(){this._usedTextureUnits=0}_allocTextuerUnit(){const t=this._device;let e=this._usedTextureUnits;if(e>=t._caps.maxTextureUnits){console.warn(`Trying to use ${e} texture units while this GPU supports only ${t._caps.maxTextureUnits}`)}this._usedTextureUnits+=1;return e}_registerStage(t,e){this._stage2fn[t]=e}_reset(){this._viewPools.reset();this._stageItemsPools.reset()}_requestView(){return this._viewPools.add()}_render(t,e){const n=this._device;n.setFrameBuffer(t._framebuffer);n.setViewport(t._rect.x,t._rect.y,t._rect.w,t._rect.h);let r={};if(t._clearFlags&dt.CLEAR_COLOR){r.color=[t._color.r,t._color.g,t._color.b,t._color.a]}if(t._clearFlags&dt.CLEAR_DEPTH){r.depth=t._depth}if(t._clearFlags&dt.CLEAR_STENCIL){r.stencil=t._stencil}n.clear(r);this._drawItemsPools.reset();for(let n=0;n<e._models.length;++n){let r=e._models.data[n];if(t._cullingByID){if(r._viewID!==t._id){continue}}else{if(r._viewID!==-1){continue}}for(let t=0;t<r.drawItemCount;++t){let e=this._drawItemsPools.add();r.extractDrawItem(e,t)}}Vn.reset();for(let e=0;e<t._stages.length;++e){let n=t._stages[e];let r=this._stageItemsPools.add();r.reset();for(let t=0;t<this._drawItemsPools.length;++t){let e=this._drawItemsPools.data[t];let i=e.effect.getTechnique(n);if(i){let t=r.add();t.model=e.model;t.node=e.node;t.ia=e.ia;t.effect=e.effect;t.defines=e.defines;t.technique=i;t.sortKey=-1}}let i=Vn.add();i.stage=n;i.items=r}for(let e=0;e<Vn.length;++e){let n=Vn.data[e];let r=this._stage2fn[n.stage];r(t,n.items)}}_draw(t){const e=this._device;const n=this._programLib;const{node:r,ia:i,effect:s,technique:a,defines:l}=t;kn.reset();qn.reset();Xn.reset();Wn.reset();Gn.reset();Hn.reset();Yn.reset();$n.reset();Zn.reset();jn.reset();r.getWorldMatrix(Un);e.setUniform("model",at.array(Gn.add(),Un));$.transpose(zn,$.invert(zn,$.fromMat4(zn,Un)));e.setUniform("normalMatrix",$.array(Wn.add(),zn));for(let t=0;t<a._parameters.length;++t){let n=a._parameters[t];let r=s.getProperty(n.name);if(r===undefined){r=n.val}if(r===undefined){r=this._type2defaultValue[n.type]}if(r===undefined){console.warn(`Failed to set technique property ${n.name}, value not found.`);continue}if(n.type===dt.PARAM_TEXTURE_2D||n.type===dt.PARAM_TEXTURE_CUBE){if(n.size!==undefined){if(n.size!==r.length){console.error(`The length of texture array (${r.length}) is not corrent(expect ${n.size}).`);continue}let t=jn.add();for(let e=0;e<r.length;++e){t[e]=this._allocTextuerUnit()}e.setTextureArray(n.name,r,t)}else{e.setTexture(n.name,r,this._allocTextuerUnit())}}else{let t;if(n.size!==undefined){let e=Jn[n.type];if(e.func===undefined){console.error("Uniform array of color3/int3/float3/mat3 can not be supportted!");continue}if(n.size*e.size>64){console.error("Uniform array is too long!");continue}t=e.func(r)}else{let e=Kn[n.type];t=e(r)}e.setUniform(n.name,t)}}for(let t=0;t<a._passes.length;++t){let r=a._passes[t];let s=i.getPrimitiveCount();e.setVertexBuffer(0,i._vertexBuffer);if(i._indexBuffer){e.setIndexBuffer(i._indexBuffer)}e.setPrimitiveType(i._primitiveType);let o=n.getProgram(r._programName,l);e.setProgram(o);e.setCullMode(r._cullMode);if(r._blend){e.enableBlend();e.setBlendFuncSep(r._blendSrc,r._blendDst,r._blendSrcAlpha,r._blendDstAlpha);e.setBlendEqSep(r._blendEq,r._blendAlphaEq);e.setBlendColor32(r._blendColor)}if(r._depthTest){e.enableDepthTest();e.setDepthFunc(r._depthFunc)}if(r._depthWrite){e.enableDepthWrite()}if(r._stencilTest){e.enableStencilTest();e.setStencilFuncFront(r._stencilFuncFront,r._stencilRefFront,r._stencilMaskFront);e.setStencilOpFront(r._stencilFailOpFront,r._stencilZFailOpFront,r._stencilZPassOpFront,r._stencilWriteMaskFront);e.setStencilFuncBack(r._stencilFuncBack,r._stencilRefBack,r._stencilMaskBack);e.setStencilOpBack(r._stencilFailOpBack,r._stencilZFailOpBack,r._stencilZPassOpBack,r._stencilWriteMaskBack)}e.draw(i._start,s);this._resetTextuerUnit()}}}let tr={addStage:We.addStage,createIA:$e,Pass:ke,Technique:He,Effect:Ye,InputAssembler:Ve,View:Ke,Light:an,Camera:cn,Model:fn,Scene:In,Base:Qn,ProgramLib:Nn};Object.assign(tr,dt);let er=q.create();let nr=q.create();let rr=q.create();let ir=new Float32Array(16);let sr=new Float32Array(16);let ar=new Float32Array(16);tr.addStage("transparent");class lr extends tr.Base{constructor(t,e){super(t,e);this._registerStage("transparent",this._transparentStage.bind(this))}render(t){this._reset();for(let e=0;e<t._cameras.length;++e){let n=t._cameras.data[e].getView();this._render(n,t)}}_transparentStage(t,e){this._device.setUniform("view",at.array(ir,t._matView));this._device.setUniform("proj",at.array(sr,t._matProj));this._device.setUniform("viewProj",at.array(ar,t._matViewProj));for(let t=0;t<e.length;++t){let n=e.data[t];let r=n.ia;let i=r._vertexBuffer;let s=r._indexBuffer;i.update(0,i._data);s.update(0,s._data);this._draw(n)}}}class or{constructor(t){let e;try{e=t.getContext("2d")}catch(t){console.error(t);return}this._canvas=t;this._ctx=e;this._caps={};this._stats={drawcalls:0};this._vx=this._vy=this._vw=this._vh=0;this._sx=this._sy=this._sw=this._sh=0}_restoreTexture(t){}setViewport(t,e,n,r){if(this._vx!==t||this._vy!==e||this._vw!==n||this._vh!==r){this._vx=t;this._vy=e;this._vw=n;this._vh=r}}setScissor(t,e,n,r){if(this._sx!==t||this._sy!==e||this._sw!==n||this._sh!==r){this._sx=t;this._sy=e;this._sw=n;this._sh=r}}clear(t){let e=this._ctx;e.clearRect(this._vx,this._vy,this._vw,this._vh);if(t&&(t[0]!==0||t[1]!==0||t[2]!==0)){e.fillStyle="rgb("+t[0]+","+t[1]+","+t[2]+")";e.globalAlpha=t[3];e.fillRect(this._vx,this._vy,this._vw,this._vh)}}}const mr=[0,0,0,1];class hr{constructor(t,e){this._device=t;this._opts=e;this._stage2fn={};this._drawItemsPools=new Pn(()=>{return{model:null,node:null}},100)}_registerStage(t,e){this._stage2fn[t]=e}_reset(){this._drawItemsPools.reset()}_render(t,e){const n=this._device;let r=t._stages[0];let i=n._ctx;let s=camera._viewProj;i.setTransform(s.m00,s.m01,s.m04,s.m05,s.m12,s.m13);n.setViewport(0,0,camera._rect.w,camera._rect.h);n.clear(mr);let a=this._drawItemsPools.alloc();a.reset();for(let t=0;t<e._models.length;++t){let n=e._models.data[t];let r=a.add();n.extractDrawItem(r)}let l=this._stage2fn[stages[0]];l(t,a)}_draw(t){const e=this._device;const n=e._ctx;t.model.draw(n)}}var ur={Base:hr};class cr{constructor(t,e){this._device=t;this._width=4;this._height=4;this._image=null;if(e){if(e.width!==undefined){this._width=e.width}if(e.height!==undefined){this._height=e.height}if(e.images&&e.images[0]){let t={image:e.images[0]};this.updateImage(t)}}}update(t){this.updateImage(t)}updateImage(t){if(t.image&&t.image!==this._image){this._image=t.image}}destroy(){this._image=null}}var fr={Device:or,renderer:ur,Texture2D:cr};const _r=fr.renderer;class dr extends _r.Base{constructor(t,e){super(t,e);this._registerStage("transparent",this._transparentStage.bind(this))}reset(){this._reset()}render(t,e){this.reset();this._render(t,e)}_transparentStage(t,e){let n=this._device._ctx;let r=t._viewProj;for(let t=0,i=e.length;t<i;++t){n.setTransform(r.m00,r.m01,r.m04,r.m05,r.m12,r.m13);let i=e.data[t];this._draw(i)}}}var pr={};var xr=[{name:"gray_sprite",vert:"uniform mat4 viewProj;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying lowp vec4 v_fragmentColor;\nattribute vec2 a_uv0;\nvarying vec2 uv0;\nvoid main () {\n  vec4 pos = viewProj * vec4(a_position, 1);\n  v_fragmentColor = a_color;\n  uv0 = a_uv0;\n  gl_Position = pos;\n}",frag:"uniform sampler2D texture;\nvarying vec2 uv0;\nvarying vec4 v_fragmentColor;\nvoid main () {\n  vec4 c = v_fragmentColor * texture2D(texture, uv0);\n  float gray = 0.2126*c.r + 0.7152*c.g + 0.0722*c.b;\n  gl_FragColor = vec4(gray, gray, gray, c.a);\n}",defines:[]},{name:"sprite",vert:"uniform mat4 viewProj;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying lowp vec4 v_fragmentColor;\n#ifdef useModel\n  uniform mat4 model;\n#endif\n#ifdef useTexture\n  attribute vec2 a_uv0;\n  varying vec2 uv0;\n#endif\nvoid main () {\n  mat4 mvp;\n  #ifdef useModel\n    mvp = viewProj * model;\n  #else\n    mvp = viewProj;\n  #endif\n  vec4 pos = mvp * vec4(a_position, 1);\n  v_fragmentColor = a_color;\n  \n  #ifdef useTexture\n    uv0 = a_uv0;\n  #endif\n  gl_Position = pos;\n}",frag:"#ifdef useTexture\n  uniform sampler2D texture;\n  varying vec2 uv0;\n#endif\n#ifdef alphaTest\n  uniform float alphaThreshold;\n#endif\nvarying vec4 v_fragmentColor;\nvoid main () {\n  vec4 o = v_fragmentColor;\n  #ifdef useTexture\n    o *= texture2D(texture, uv0);\n  #endif\n  #ifdef alphaTest\n    if (o.a <= alphaThreshold)\n      discard;\n  #endif\n  gl_FragColor = o;\n}",defines:[]},{name:"vfx_emitter",vert:"#ifdef GL_ES\nprecision highp float;\n#endif\nattribute vec2 a_quad;\nvarying vec2 index;\nvoid main() {\n    index = (a_quad + 1.0) / 2.0;\n    gl_Position = vec4(a_quad, 0, 1);\n}\n",frag:"uniform sampler2D noise;\nuniform sampler2D state;\nuniform vec2 statesize;\nuniform vec2 noisesize;\nuniform bool stopped;\nuniform float dt;\nuniform float mode;\nuniform float noiseId;\nuniform float emitVar;\nuniform float life;\nuniform float lifeVar;\nuniform vec2 pos;\nuniform vec2 posVar;\nuniform vec4 color;\nuniform vec4 colorVar;\nuniform vec4 endColor;\nuniform vec4 endColorVar;\nuniform float size;\nuniform float sizeVar;\nuniform float endSize;\nuniform float endSizeVar;\nuniform float rot;\nuniform float rotVar;\nuniform float endRot;\nuniform float endRotVar;\nuniform float angle;\nuniform float angleVar;\nuniform float speed;\nuniform float speedVar;\nuniform float radial;\nuniform float radialVar;\nuniform float tangent;\nuniform float tangentVar;\nuniform float radius;\nuniform float radiusVar;\nuniform float endRadius;\nuniform float endRadiusVar;\nuniform float rotatePS;\nuniform float rotatePSVar;\nuniform float sizeScale;\nuniform float accelScale;\nuniform float radiusScale;\nvarying vec2 index;\nconst float BASE = 255.0;\nconst float OFFSET = BASE * BASE / 2.0;\nconst float NOISE_SCALE = 10000.0;\nconst float POSITION_SCALE = 1.0;\nconst float ROTATION_SCALE = 1.0;\nconst float COLOR_SCALE = 1.0;\nconst float LIFE_SCALE = 60.0;\nconst float START_SIZE_EQUAL_TO_END_SIZE = -1.0;\nconst float START_RADIUS_EQUAL_TO_END_RADIUS = -1.0;\nfloat decode(vec2 channels, float scale) {\n    return (dot(channels, vec2(BASE, BASE * BASE)) - OFFSET) / scale;\n}\nvec2 encode(float value, float scale) {\n    value = value * scale + OFFSET;\n    float x = mod(value, BASE);\n    float y = floor(value / BASE);\n    return vec2(x, y) / BASE;\n}\nfloat randomMinus1To1(vec2 randomD) {\n    float random = decode(randomD, NOISE_SCALE);\n    return (random - 0.5) * 2.0;\n}\nbool doEmit (vec4 randomD) {\n    float random1 = decode(randomD.rg, NOISE_SCALE);\n    if (!stopped && (life + lifeVar) * random1 < life) {\n        return true;\n    }\n    else {\n        return false;\n    }\n}\nvec4 initLife (vec4 data, vec4 randomD) {\n    \n    if (doEmit(randomD)) {\n        float random2 = randomMinus1To1(randomD.ba);\n        float plife = life + lifeVar * random2;\n        vec2 l = encode(plife, LIFE_SCALE);\n        return vec4(l, l);\n    }\n    else {\n        return data;\n    }\n}\nvec4 initColor (float randr, float randg, float randb, float randa) {\n    vec4 random = vec4(randr, randg, randb, randa);\n    vec4 result = clamp(color + colorVar * random, 0.0, 255.0);\n    return result / 255.0;\n}\nvec4 initDeltaRG (vec2 startR, vec2 random) {\n    vec2 start = clamp(color.rg + colorVar.rg * startR, 0.0, 255.0);\n    vec2 end = clamp(endColor.rg + endColorVar.rg * random, 0.0, 255.0);\n    vec2 delta = end - start;\n    return vec4(encode(delta.x, COLOR_SCALE), encode(delta.y, COLOR_SCALE));\n}\nvec4 initDeltaBA (vec2 startR, vec2 random) {\n    vec2 start = clamp(color.ba + colorVar.ba * startR, 0.0, 255.0);\n    vec2 end = clamp(endColor.ba + endColorVar.ba * random, 0.0, 255.0);\n    vec2 delta = end - start;\n    return vec4(encode(delta.x, COLOR_SCALE), encode(delta.y, COLOR_SCALE));\n}\nvec4 initSize (float rand1, float rand2) {\n    float start = max(0.0, size + sizeVar * rand1);\n    if (endSize == START_SIZE_EQUAL_TO_END_SIZE) {\n        float delta = 0.0;\n        return vec4(encode(start, sizeScale), encode(delta, sizeScale));\n    }\n    else {\n        float end = max(0.0, endSize + endSizeVar * rand2);\n        float delta = end - start;\n        return vec4(encode(start, sizeScale), encode(delta, sizeScale));\n    }\n}\nvec4 initRotation (float rand1, float rand2) {\n    float start = rot + rotVar * rand1;\n    float end = endRot + endRotVar * rand2;\n    float delta = end - start;\n    return vec4(encode(start, ROTATION_SCALE), encode(delta, ROTATION_SCALE));\n}\nvec4 initControl1 (float rand1, float rand2) {\n    \n    if (mode == 0.0) {\n        float pAngle = angle + angleVar * rand1;\n        float dirX = cos(pAngle);\n        float dirY = sin(pAngle);\n        float pSpeed = speed + speedVar * rand2;\n        return vec4(encode(dirX * pSpeed, POSITION_SCALE), encode(dirY * pSpeed, POSITION_SCALE));\n    }\n    \n    else {\n        float pAngle = angle + angleVar * rand1;\n        float pRadius = radius + radiusVar * rand2;\n        return vec4(encode(pAngle, ROTATION_SCALE), encode(pRadius, radiusScale));\n    }\n}\nvec4 initControl2 (float startR1, float rand1, float rand2) {\n    \n    if (mode == 0.0) {\n        float pRadial = radial + radialVar * rand1;\n        float pTangent = tangent + tangentVar * rand2;\n        return vec4(encode(pRadial, accelScale), encode(pTangent, accelScale));\n    }\n    \n    else {\n        float degreesPerSecond = rotatePS + rotatePSVar * rand1;\n        float pDeltaRadius;\n        if (endRadius == START_RADIUS_EQUAL_TO_END_RADIUS) {\n            pDeltaRadius = 0.0;\n        }\n        else {\n            float pRadius = radius + radiusVar * startR1;\n            pDeltaRadius = (endRadius + endRadiusVar * rand2 - pRadius);\n        }\n        return vec4(encode(degreesPerSecond, ROTATION_SCALE), encode(pDeltaRadius, radiusScale));\n    }\n}\nvec4 initPos (float rand1, float rand2) {\n    vec2 result = pos + posVar * vec2(rand1, rand2);\n    return vec4(encode(result.x, POSITION_SCALE), encode(result.y, POSITION_SCALE));\n}\nvoid main() {\n    vec2 pixel = floor(index * statesize);\n    vec2 pindex = floor(pixel / 3.0);\n    vec2 temp = mod(pixel, vec2(3.0, 3.0));\n    float id = floor(temp.y * 3.0 + temp.x);\n    vec2 noffset = vec2(floor(noiseId / 4.0), mod(noiseId, 4.0));\n    vec2 nid = pixel + noffset;\n    vec4 randomD = texture2D(noise, nid / noisesize);\n    \n    vec4 lifeData = texture2D(state, pindex * 3.0 / statesize);\n    float rest = decode(lifeData.rg, LIFE_SCALE);\n    float life = decode(lifeData.ba, LIFE_SCALE);\n    \n    if (id == 0.0) {\n        vec4 data = texture2D(state, index);\n        if (rest <= 0.0) {\n            gl_FragColor = initLife(data, randomD);\n        }\n        else {\n            gl_FragColor = data;\n        }\n        return;\n    }\n    \n    if (rest > 0.0) {\n        vec4 data = texture2D(state, index);\n        gl_FragColor = data;\n        return;\n    }\n    vec2 lifeNid = pindex * 3.0 + noffset;\n    vec4 lifeRandomD = texture2D(noise, lifeNid / noisesize);\n    bool emitting = doEmit(lifeRandomD);\n    if (!emitting) {\n        vec4 data = texture2D(state, index);\n        gl_FragColor = data;\n        return;\n    }\n    \n    float random1 = randomMinus1To1(randomD.rg);\n    float random2 = randomMinus1To1(randomD.ba);\n    \n    if (id == 1.0) {\n        vec4 randomD3 = texture2D(noise, vec2(nid.x - 1.0, nid.y + 1.0) / noisesize);\n        float random3 = randomMinus1To1(randomD3.rg);\n        float random4 = randomMinus1To1(randomD3.ba);\n        gl_FragColor = initColor(random1, random2, random3, random4);\n        return;\n    }\n    \n    if (id == 2.0) {\n        vec4 randomD1 = texture2D(noise, vec2(nid.x - 1.0, nid.y) / noisesize);\n        float startR1 = randomMinus1To1(randomD1.rg);\n        float startR2 = randomMinus1To1(randomD1.ba);\n        vec2 startR = vec2(startR1, startR2);\n        gl_FragColor = initDeltaRG(startR, vec2(random1, random2));\n        return;\n    }\n    \n    if (id == 3.0) {\n        vec2 startR = vec2(random1, random2);\n        gl_FragColor = initDeltaBA(startR, vec2(random1, random2));\n        return;\n    }\n    \n    if (id == 4.0) {\n        gl_FragColor = initSize(random1, random2);\n        return;\n    }\n    \n    if (id == 5.0) {\n        gl_FragColor = initRotation(random1, random2);\n        return;\n    }\n    \n    if (id == 6.0) {\n        gl_FragColor = initControl1(random1, random2);\n        return;\n    }\n    \n    if (id == 7.0) {\n        vec4 randomD6 = texture2D(noise, vec2(nid.x - 1.0, nid.y) / noisesize);\n        float startR1 = randomMinus1To1(randomD6.rg);\n        gl_FragColor = initControl2(startR1, random1, random2);\n        return;\n    }\n    \n    if (id == 8.0) {\n        gl_FragColor = initPos(random1, random2);\n        return;\n    }\n}",defines:[]},{name:"vfx_particle",vert:"#ifdef GL_ES\nprecision highp float;\n#endif\nattribute vec2 a_quad;\nuniform mat4 model;\nuniform mat4 viewProj;\nuniform sampler2D state;\nuniform sampler2D quad;\nuniform vec2 statesize;\nuniform vec2 quadsize;\nuniform float z;\nuniform vec2 lb;\nuniform vec2 rt;\nvarying lowp vec4 v_fragmentColor;\nvarying vec2 uv0;\nconst float BASE = 255.0;\nconst float OFFSET = BASE * BASE / 2.0;\nconst float LIFE_SCALE = 60.0;\nconst float POSITION_SCALE = 1.0;\nfloat decode(vec2 channels, float scale) {\n    return (dot(channels, vec2(BASE, BASE * BASE)) - OFFSET) / scale;\n}\nvoid main() {\n    vec2 sIndex = floor(a_quad / 2.0) * 3.0;\n    vec4 lifeData = texture2D(state, sIndex / statesize);\n    float life = decode(lifeData.rg, LIFE_SCALE);\n    if (life <= 0.0) {\n        v_fragmentColor = vec4(0.0, 0.0, 0.0, 0.0);\n        uv0 = vec2(0.0, 0.0);\n        gl_Position = vec4(0.0, 0.0, 0.0, 1.0);\n    }\n    else {\n        vec2 posIndex = a_quad / quadsize;\n        vec4 posData = texture2D(quad, posIndex);\n        vec2 pos = vec2(decode(posData.rg, POSITION_SCALE), decode(posData.ba, POSITION_SCALE));\n        vec2 cIndex = vec2(sIndex.x + 1.0, sIndex.y) / statesize;\n        vec4 color = texture2D(state, cIndex);\n        v_fragmentColor = color;\n        float u, v;\n        vec2 uvId = mod(a_quad, vec2(2.0));\n        if (uvId.x == 0.0) {\n            u = lb.x;\n        }\n        else {\n            u = rt.x;\n        }\n        if (uvId.y == 0.0) {\n            v = lb.y;\n        }\n        else {\n            v = rt.y;\n        }\n        uv0 = vec2(u, v);\n        gl_Position = viewProj * model * vec4(pos, z, 1.0);\n    }    \n}\n",frag:"uniform sampler2D texture;\nvarying vec2 uv0;\nvarying vec4 v_fragmentColor;\nvoid main () {\n  vec4 o = v_fragmentColor;\n  o *= texture2D(texture, uv0);\n  gl_FragColor = o;\n}",defines:[]},{name:"vfx_quad",vert:"#ifdef GL_ES\nprecision highp float;\n#endif\nattribute vec2 a_quad;\nvarying vec2 index;\nvoid main() {\n    index = (a_quad + 1.0) / 2.0;\n    gl_Position = vec4(a_quad, 0, 1);\n}\n",frag:"uniform sampler2D state;\nuniform vec2 quadsize;\nuniform vec2 statesize;\nuniform float sizeScale;\nvarying vec2 index;\nconst float BASE = 255.0;\nconst float OFFSET = BASE * BASE / 2.0;\nconst float POSITION_SCALE = 1.0;\nconst float ROTATION_SCALE = 1.0;\nfloat decode(vec2 channels, float scale) {\n    return (dot(channels, vec2(BASE, BASE * BASE)) - OFFSET) / scale;\n}\nvec2 encode(float value, float scale) {\n    value = value * scale + OFFSET;\n    float x = mod(value, BASE);\n    float y = floor(value / BASE);\n    return vec2(x, y) / BASE;\n}\nvoid main() {\n    vec2 pIndex = floor(index * quadsize / 2.0) * 3.0;\n    vec2 dataIndex = (pIndex + 2.0) / statesize;\n    vec4 posData = texture2D(state, dataIndex);\n    vec2 pos = vec2(decode(posData.rg, POSITION_SCALE), decode(posData.ba, POSITION_SCALE));\n    dataIndex = (pIndex + 1.0) / statesize;\n    vec4 sizeData = texture2D(state, dataIndex);\n    float size = decode(sizeData.rg, sizeScale);\n    dataIndex.x = (pIndex.x + 2.0) / statesize.x;\n    dataIndex.y = (pIndex.y + 1.0) / statesize.y;\n    vec4 rotData = texture2D(state, dataIndex);\n    float rot = radians(floor(decode(rotData.rg, ROTATION_SCALE)));\n    float a = cos(rot);\n    float b = -sin(rot);\n    float c = -b;\n    float d = a;\n    vec2 vert = (mod(floor(index * quadsize), vec2(2.0)) - 0.5) * size;\n    float x = vert.x * a + vert.y * c + pos.x;\n    float y = vert.x * b + vert.y * d + pos.y;\n    gl_FragColor = vec4(encode(x, POSITION_SCALE), encode(y, POSITION_SCALE));\n}\n",defines:[]},{name:"vfx_update",vert:"#ifdef GL_ES\nprecision highp float;\n#endif\nattribute vec2 a_quad;\nvarying vec2 index;\nvoid main() {\n    index = (a_quad + 1.0) / 2.0;\n    gl_Position = vec4(a_quad, 0, 1);\n}\n",frag:"uniform sampler2D state;\nuniform vec2 statesize;\nuniform float dt;\nuniform float mode;\nuniform vec2 gravity;\nuniform float sizeScale;\nuniform float accelScale;\nuniform float radiusScale;\nvarying vec2 index;\nconst float BASE = 255.0;\nconst float OFFSET = BASE * BASE / 2.0;\nconst float MAX_VALUE = BASE * BASE;\nconst float LIFE_SCALE = 60.0;\nconst float POSITION_SCALE = 1.0;\nconst float ROTATION_SCALE = 1.0;\nconst float COLOR_SCALE = 1.0;\nfloat decode(vec2 channels, float scale) {\n    return (dot(channels, vec2(BASE, BASE * BASE)) - OFFSET) / scale;\n}\nvec2 encode(float value, float scale) {\n    value = value * scale + OFFSET;\n    float x = mod(value, BASE);\n    float y = floor(value / BASE);\n    return vec2(x, y) / BASE;\n}\nvec4 updateLife (vec4 data) {\n    float rest = decode(data.rg, LIFE_SCALE);\n    rest -= dt;\n    return vec4(encode(rest, LIFE_SCALE), data.ba);\n}\nvec4 updateColor (vec4 color, vec4 deltaRG, vec4 deltaBA, float life) {\n    float r = decode(deltaRG.rg, COLOR_SCALE);\n    float g = decode(deltaRG.ba, COLOR_SCALE);\n    float b = decode(deltaBA.rg, COLOR_SCALE);\n    float a = decode(deltaBA.ba, COLOR_SCALE);\n    vec4 deltaColor = vec4(r, g, b, a) / 255.0;\n    \n    color = clamp(color + deltaColor * dt / life, 0.0, 1.0);\n    return color;\n}\nvec4 updateSize (vec4 data, float life) {\n    float size = decode(data.rg, sizeScale);\n    float deltaSize = decode(data.ba, sizeScale);\n    size = clamp(size + deltaSize * dt / life, 0.0, MAX_VALUE);\n    return vec4(encode(size, sizeScale), data.ba);\n}\nvec4 updateRotation (vec4 data, float life) {\n    float rotation = decode(data.rg, ROTATION_SCALE);\n    float deltaRotation = decode(data.ba, ROTATION_SCALE);\n    rotation += deltaRotation * dt / life;\n    return vec4(encode(rotation, ROTATION_SCALE), data.ba);\n}\nvec4 updateControl (vec4 control1, vec4 control2, vec4 posData, float life) {\n    \n    if (mode == 0.0) {\n        vec2 dir = vec2(decode(control1.rg, POSITION_SCALE), decode(control1.ba, POSITION_SCALE));\n        float radialAccel = decode(control2.rg, accelScale);\n        float tangentialAccel = decode(control2.ba, accelScale);\n        vec2 pos = vec2(decode(posData.rg, POSITION_SCALE), decode(posData.ba, POSITION_SCALE));\n        vec2 radial = normalize(pos);\n        vec2 tangential = vec2(-radial.y, radial.x);\n        radial = radial * radialAccel;\n        tangential = tangential * tangentialAccel;\n        vec2 result = dir + (radial + tangentialAccel + gravity) * dt;\n        return vec4(encode(result.x, POSITION_SCALE), encode(result.y, POSITION_SCALE));\n    }\n    \n    else {\n        float angle = mod(decode(control1.rg, ROTATION_SCALE), 360.0);\n        float radius = decode(control1.ba, radiusScale);\n        float degreesPerSecond = decode(control2.rg, ROTATION_SCALE);\n        float deltaRadius = decode(control2.ba, radiusScale);\n        angle += degreesPerSecond * dt;\n        radius += deltaRadius * dt / life;\n        return vec4(encode(angle, ROTATION_SCALE), encode(radius, radiusScale));\n    }\n}\nvec4 updatePos (vec4 posData, vec4 control) {\n    vec2 result;\n    \n    if (mode == 0.0) {\n        vec2 dir = vec2(decode(control.rg, POSITION_SCALE), decode(control.ba, POSITION_SCALE));\n        vec2 pos = vec2(decode(posData.rg, POSITION_SCALE), decode(posData.ba, POSITION_SCALE));\n        result = pos + dir * dt;\n    }\n    \n    else {\n        float angle = radians(decode(control.rg, ROTATION_SCALE));\n        float radius = decode(control.ba, radiusScale);\n        result.x = -cos(angle) * radius;\n        result.y = -sin(angle) * radius;\n    }\n    return vec4(encode(result.x, POSITION_SCALE), encode(result.y, POSITION_SCALE));\n}\nvoid main() {\n    vec2 pixel = floor(index * statesize);\n    vec2 pindex = floor(pixel / 3.0);\n    vec2 temp = mod(pixel, vec2(3.0));\n    float id = floor(temp.y * 3.0 + temp.x);\n    \n    vec4 data = texture2D(state, index);\n    vec4 lifeData = texture2D(state, pindex * 3.0 / statesize);\n    float rest = decode(lifeData.rg, LIFE_SCALE);\n    if (rest <= 0.0) {\n        gl_FragColor = data;\n        return;\n    }\n    \n    if (id == 2.0 || id == 3.0 || id == 7.0) {\n        gl_FragColor = data;\n        return;\n    }\n    float life = decode(lifeData.ba, LIFE_SCALE);\n    \n    if (id == 0.0) {\n        gl_FragColor = updateLife(data);\n        return;\n    }\n    \n    if (id == 1.0) {\n        vec2 rgIndex = vec2(pixel.x + 1.0, pixel.y) / statesize;\n        vec4 deltaRG = texture2D(state, rgIndex);\n        vec2 baIndex = vec2(pixel.x - 1.0, pixel.y + 1.0) / statesize;\n        vec4 deltaBA = texture2D(state, baIndex);\n        gl_FragColor = updateColor(data, deltaRG, deltaBA, life);\n        return;\n    }\n    \n    if (id == 4.0) {\n        gl_FragColor = updateSize(data, life);\n        return;\n    }\n    \n    if (id == 5.0) {\n        gl_FragColor = updateRotation(data, life);\n        return;\n    }\n    \n    if (id == 6.0) {\n        vec2 ctrlIndex = vec2(pixel.x + 1.0, pixel.y) / statesize;\n        vec4 control2 = texture2D(state, ctrlIndex);\n        vec2 posIndex = vec2(pixel.x + 2.0, pixel.y) / statesize;\n        vec4 pos = texture2D(state, posIndex);\n        gl_FragColor = updateControl(data, control2, pos, life);\n        return;\n    }\n    \n    if (id == 8.0) {\n        vec2 ctrlIndex = vec2(pixel.x - 2.0, pixel.y) / statesize;\n        vec4 control1 = texture2D(state, ctrlIndex);\n        gl_FragColor = updatePos(data, control1);\n        return;\n    }\n}\n",defines:[]}];let gr={chunks:pr,templates:xr};function Tr(t,e){try{return t.getContext("webgl",e)||t.getContext("experimental-webgl",e)}catch(t){return null}}let Er=false;if(typeof window==="undefined"){Er=true}else{const t=window.cc&&window.cc.sys;let e=document.createElement("canvas");if(window.WebGLRenderingContext){Er=true;if(Er&&t&&t.os===t.OS_ANDROID){var Ar=parseFloat(t.browserVersion);switch(t.browserType){case t.BROWSER_TYPE_MOBILE_QQ:case t.BROWSER_TYPE_BAIDU:case t.BROWSER_TYPE_BAIDU_APP:if(Ar>=6.2){Er=true}else{Er=false}break;case t.BROWSER_TYPE_ANDROID:if(t.osMainVersion&&t.osMainVersion>=5){Er=true}break;case t.BROWSER_TYPE_CHROME:if(Ar>=30){Er=true}else{Er=false}break;case t.BROWSER_TYPE_UC:if(Ar>11){Er=true}else{Er=false}case t.BROWSER_TYPE_360:Er=false}}}}var Mr={supportWebGL:Er,create3DContext:Tr};class yr{constructor(t,e){this.view=null;this._node=null;this._poolID=-1;this._projection=yr.PROJECTION.PERSPECTIVE;this._color=ct.new(0,0,0,1);this._depth=1;this._stencil=1;this._clearFlags=tr.CLEAR_COLOR|tr.CLEAR_DEPTH;this._near=.1;this._far=1024;this._fov=Math.PI*60/180;this._rect={x:0,y:0,w:1,h:1};this._stages=[];this._framebuffer=null;this._matView=at.create();this._matProj=at.create();this._matViewProj=at.create();this._matInvViewProj=at.create();this.setViewport(t);if(e){this.setNode(e)}}setColor(t,e,n,r){ct.set(this._color,t,e,n,r)}setDepth(t){this._depth=t}setStencil(t){this._stencil=t}setClearFlags(t){this._clearFlags=t}setStages(t){this._stages=t}setFramebuffer(t){this._framebuffer=t}setNode(t){this._node=t;this._node.getWorldMatrix(this._matView);at.invert(this._matView,this._matView);at.mul(this._matViewProj,this._matProj,this._matView)}setViewport(t){if(t){this._rect=t}if(Mr.supportWebGL){let t=this._rect.w/this._rect.h;if(this._projection===yr.PROJECTION.PERSPECTIVE){let e=this._rect.h/1.1566;let n=at.create();at.perspective(n,this._fov,t,this._near,e*2);let r=q.new(-this._rect.x+this._rect.w/2,-this._rect.y+this._rect.h/2,e);let i=q.new(-this._rect.x+this._rect.w/2,-this._rect.y+this._rect.h/2,0);let s=q.new(0,1,0);let a=at.create();at.lookAt(a,r,i,s);at.mul(this._matProj,n,a)}else{at.ortho(this._matProj,0,this._rect.w,0,this._rect.h,this._near,this._far)}}else{at.identity(this._matProj);this._matProj.m12=this._rect.x;this._matProj.m13=this._rect.y+this._rect.h;this._matProj.m05=-1}at.mul(this._matViewProj,this._matProj,this._matView);at.invert(this._matInvViewProj,this._matViewProj)}getView(){return this}}yr.PROJECTION={PERSPECTIVE:0,ORTHO:1};var Sr;var br=new Fn(()=>{return{x:0,y:0,u:0,v:0,color:0}},128);class Rr{constructor(){this._data=[];this._indices=[];this.effect=null;this._pivotX=0;this._pivotY=0;this._width=0;this._height=0;this.vertexCount=0;this.indiceCount=0;this.uvDirty=true;this.vertDirty=true}get dataLength(){return this._data.length}set dataLength(t){let e=this._data;for(let n=t;n<e.length;n++){br.free(e[n])}for(let n=e.length;n<t;n++){e[n]=br.alloc()}e.length=t}updateSizeNPivot(t,e,n,r){if(t!==this._width||e!==this._height||n!==this._pivotX||r!==this._pivotY){this._width=t;this._height=e;this._pivotX=n;this._pivotY=r;this.vertDirty=true}}static alloc(){return Sr.alloc()}static free(t){if(t instanceof Rr){for(let e=t.length-1;e>0;e--){br.free(t._data[e])}t._data.length=0;t._indices.length=0;t.effect=null;t.uvDirty=true;t.vertDirty=true;t.vertexCount=0;t.indiceCount=0;Sr.free(t)}}}Sr=new Fn(()=>{return new Rr},32);const wr=255;const vr=1e4;const Fr=1;const Pr=60;const Lr=1;const Ir=1;const Dr=500;let Cr=new gfx.VertexFormat([{name:"a_quad",type:gfx.ATTR_TYPE_FLOAT32,num:2}]);let Or={width:0,height:0,minFilter:gfx.FILTER_NEAREST,magFilter:gfx.FILTER_NEAREST,wrapS:gfx.WRAP_CLAMP,wrapT:gfx.WRAP_CLAMP,format:gfx.TEXTURE_FMT_RGBA8,images:[]};function Br(t,e,n,r){t=t*e+wr*wr/2;n[r]=Math.floor(t%wr/wr*255);n[r+1]=Math.floor(Math.floor(t/wr)/wr*255)}function Nr(t,e,n){return(t[e]/255*wr+t[e+1]/255*wr*wr-wr*wr/2)/n}function zr(t,e,n){return t<e?e:t<n?t:n}class Ur{constructor(t,e,n){this._device=t;this._config=n;this._sizeScale=1;this._accelScale=1;this._radiusScale=1;let r={};let i=e._programLib;this.programs={emitter:i.getProgram("vfx_emitter",r),update:i.getProgram("vfx_update",r),quad:i.getProgram("vfx_quad",r)};this.textures={state0:new gfx.Texture2D(t,r),state1:new gfx.Texture2D(t,r),noise:new gfx.Texture2D(t,r),quads:new gfx.Texture2D(t,r)};this.framebuffers={state0:new gfx.FrameBuffer(t,0,0,{colors:[this.textures.state0]}),state1:new gfx.FrameBuffer(t,0,0,{colors:[this.textures.state1]}),quads:new gfx.FrameBuffer(t,0,0,{colors:[this.textures.quads]})};let s=new Float32Array([-1,-1,1,-1,-1,1,1,1]);let a=new Uint8Array([0,1,2,1,3,2]);this.buffers={updateVB:new gfx.VertexBuffer(t,Cr,gfx.USAGE_STATIC,s,4),updateIB:new gfx.IndexBuffer(t,gfx.INDEX_FMT_UINT8,gfx.USAGE_STATIC,a,6),indexes:null,particleCache:null};this._elapsed=0;this._stopped=false;this.updateMaxParticle(n);this.updateSizeScale(n);this.updateRadiusScale(n);this.updateAccelScale(n);this._pos=new Float32Array([n.sourcePos.x,n.sourcePos.y]);this._posVar=new Float32Array([n.posVar.x,n.posVar.y]);this._gravity=new Float32Array([n.gravity.x,n.gravity.y]);this._color=new Float32Array([n.startColor.r,n.startColor.g,n.startColor.b,n.startColor.a]);this._colorVar=new Float32Array([n.startColorVar.r,n.startColorVar.g,n.startColorVar.b,n.startColorVar.a]);this._endColor=new Float32Array([n.endColor.r,n.endColor.g,n.endColor.b,n.endColor.a]);this._endColorVar=new Float32Array([n.endColorVar.r,n.endColorVar.g,n.endColorVar.b,n.endColorVar.a])}get vertexFormat(){return Cr}get particleCount(){let t=0;let e=this._device;e.setFrameBuffer(this.framebuffers.state0);let n=this.statesize[0],r=this.statesize[1],i=this._tw,s=this._th,a=this.buffers.particleCache;e._gl.readPixels(0,0,n,r,e._gl.RGBA,e._gl.UNSIGNED_BYTE,a);for(let e=0;e<s;e++){for(let n=0;n<i;n++){let r=e*3*i*12+n*12;let s=Nr(a,r,Pr);if(s>0){t++}}}return t}get stopped(){return this._stopped}updateMaxParticle(t){let e=Math.floor(t.emissionRate*(t.life+t.lifeVar));let n;if(t.totalParticles>e){n=e;this._emitVar=t.lifeVar}else{n=t.totalParticles;this._emitVar=0}if(n!==this._maxParticle){this._maxParticle=n;this._tw=Math.ceil(Math.sqrt(n));this._th=Math.floor(Math.sqrt(n));this.initTextures();this.initBuffers()}}set pos(t){this._pos[0]=t.x;this._pos[1]=t.y}set posVar(t){this._posVar[0]=t.x;this._posVar[1]=t.y}set gravity(t){this._gravity[0]=t.x;this._gravity[1]=t.y}set startColor(t){this._color[0]=t.r;this._color[1]=t.g;this._color[2]=t.b;this._color[3]=t.a}set startColorVar(t){this._colorVar[0]=t.r;this._colorVar[1]=t.g;this._colorVar[2]=t.b;this._colorVar[3]=t.a}set endColor(t){this._endColor[0]=t.r;this._endColor[1]=t.g;this._endColor[2]=t.b;this._endColor[3]=t.a}set endColorVar(t){this._endColorVar[0]=t.r;this._endColorVar[1]=t.g;this._endColorVar[2]=t.b;this._endColorVar[3]=t.a}_updateTex(t,e,n,r){Or.images.length=1;Or.images[0]=e;Or.width=n;Or.height=r;t.update(Or)}_initNoise(){let t=this._tw,e=this._th;let n=(t+1)*3,r=(e+1)*3;let i=new Uint8Array(n*r*4);let s=0;for(let t=0;t<r;t++){for(let t=0;t<n;t++){Br(Math.random(),vr,i,s);Br(Math.random(),vr,i,s+2);s+=4}}this._noisesize=new Float32Array([n,r]);this._updateTex(this.textures.noise,i,n,r)}initTextures(){let t=this._tw,e=this._th;this.statesize=new Float32Array([t*3,e*3]);this.quadsize=new Float32Array([t*2,e*2]);let n=new Uint8Array(t*3*e*3*4);n.fill(97);this._updateTex(this.textures.state0,n,t*3,e*3);this._updateTex(this.textures.state1,n,t*3,e*3);this._updateTex(this.textures.quads,null,t*2,e*2);this._initNoise()}initBuffers(){var t=this.quadsize[0],e=this.quadsize[1],n=new Float32Array(t*e*2),r=0;for(var i=0;i<e;i++){for(var s=0;s<t;s++){n[r+0]=s;n[r+1]=i;r+=2}}this.buffers.indexes=n;this.buffers.particleCache=new Uint8Array(this.statesize[0]*this.statesize[1]*4)}updateSizeScale(t){let e=t.startSize,n=t.startSizeVar,r=t.endSize,i=t.endSizeVar;let s=Math.floor(Math.pow(wr,2)/Math.max(e+n,r+i));this._sizeScale=zr(s,1,Dr)}updateAccelScale(t){let e=t.radialAccel,n=t.radialAccelVar,r=t.tangentialAccel,i=t.tangentialAccelVar;let s=Math.floor(Math.pow(wr,2)/Math.max(Math.abs(e)+n,Math.abs(r)+i)/2);this._accelScale=zr(s,1,Dr)}updateRadiusScale(t){let e=t.startRadius,n=t.startRadiusVar,r=t.endRadius,i=t.endRadiusVar;let s=Math.floor(Math.pow(wr,2)/Math.max(Math.abs(e)+n,Math.abs(r)+i));this._radiusScale=zr(s,1,Dr)}resetSystem(){this._stopped=false}stopSystem(){this._stopped=true}getState(t){let e=this._device;e.setFrameBuffer(t);let n=this.statesize[0],r=this.statesize[1],i=this._tw,s=this._th,a=new Uint8Array(n*r*4);e._gl.readPixels(0,0,n,r,e._gl.RGBA,e._gl.UNSIGNED_BYTE,a);let l=[];for(let t=0;t<s;t++){for(let e=0;e<i;e++){let n=t*3*i*12+e*12;let r=n+1*4;let s=n+2*4;let o=n+i*12;let m=n+i*12+1*4;let h=n+i*12+2*4;let u=n+2*i*12;let c=n+2*i*12+1*4;let f=n+2*i*12+2*4;let _=Nr(a,n,Pr);let d=Nr(a,n+2,Pr);let p={r:a[r],g:a[r+1],b:a[r+2],a:a[r+3]};let x={r:Nr(a,s,Lr),g:Nr(a,s+2,Lr),b:Nr(a,o,Lr),a:Nr(a,o+2,Lr)};let g=Nr(a,m,this._sizeScale);let T=Nr(a,m+2,this._sizeScale);let E=Nr(a,h,Ir);let A=Nr(a,h+2,Ir);let M;if(this._config.emitterMode===0){M=[Nr(a,u,Fr),Nr(a,u+2,Fr),Nr(a,c,this._accelScale),Nr(a,c+2,this._accelScale)]}else{M=[Nr(a,u,Ir),Nr(a,u+2,this._radiusScale),Nr(a,c,Ir),Nr(a,c+2,this._radiusScale)]}let y={x:Nr(a,f,Fr),y:Nr(a,f+2,Fr)};l.push({rest:_,life:d,color:p,deltaColor:x,size:g,deltaSize:T,rot:E,deltaRot:A,control:M,pos:y})}}return l}getNoise(){let t=this._device;let e=new gfx.FrameBuffer(t,0,0,{colors:[this.textures.noise]});t.setFrameBuffer(e);let n=this._noisesize[0],r=this._noisesize[1],i=new Uint8Array(n*r*4);t._gl.readPixels(0,0,n,r,t._gl.RGBA,t._gl.UNSIGNED_BYTE,i);let s=[];let a=0;for(let t=0;t<r;t++){for(let t=0;t<n;t++){s.push(Nr(i,a,1e4));s.push(Nr(i,a+2,1e4));a+=4}}return s}getQuads(){let t=this._device;let e=new gfx.FrameBuffer(t,0,0,{colors:[this.textures.quads]});t.setFrameBuffer(e);let n=this.quadsize[0],r=this.quadsize[1],i=new Uint8Array(n*r*4);t._gl.readPixels(0,0,n,r,t._gl.RGBA,t._gl.UNSIGNED_BYTE,i);let s=[];let a=0,l=0;for(let t=0;t<r;t+=2){for(let e=0;e<n;e+=2){a=(t*n+e)*4;l=((t+1)*n+e)*4;s.push([Nr(i,a,Fr),Nr(i,a+2,Fr),Nr(i,a+4,Fr),Nr(i,a+6,Fr),Nr(i,l,Fr),Nr(i,l+2,Fr),Nr(i,l+4,Fr),Nr(i,l+6,Fr)])}}return s}step(t){let e=this._config;let n=this._device;n.setViewport(0,0,this.statesize[0],this.statesize[1]);n.setFrameBuffer(this.framebuffers.state1);n.setTexture("noise",this.textures.noise,0);n.setTexture("state",this.textures.state0,1);n.setUniform("statesize",this.statesize);n.setUniform("noisesize",this._noisesize);n.setUniform("stopped",this._stopped);n.setUniform("dt",t);n.setUniform("mode",e.emitterMode);n.setUniform("noiseId",Math.floor(Math.random()*16));n.setUniform("emitVar",this._emitVar);n.setUniform("life",e.life);n.setUniform("lifeVar",e.lifeVar);n.setUniform("pos",this._pos);n.setUniform("posVar",this._posVar);n.setUniform("color",this._color);n.setUniform("colorVar",this._colorVar);n.setUniform("endColor",this._endColor);n.setUniform("endColorVar",this._endColorVar);n.setUniform("size",e.startSize);n.setUniform("sizeVar",e.startSizeVar);n.setUniform("endSize",e.endSize);n.setUniform("endSizeVar",e.endSizeVar);n.setUniform("rot",e.startSpin);n.setUniform("rotVar",e.startSpinVar);n.setUniform("endRot",e.endSpin);n.setUniform("endRotVar",e.endSpinVar);n.setUniform("angle",e.angle);n.setUniform("angleVar",e.angleVar);n.setUniform("speed",e.speed);n.setUniform("speedVar",e.speedVar);n.setUniform("radial",e.radialAccel);n.setUniform("radialVar",e.radialAccelVar);n.setUniform("tangent",e.tangentialAccel);n.setUniform("tangentVar",e.tangentialAccelVar);n.setUniform("radius",e.startRadius);n.setUniform("radiusVar",e.startRadiusVar);n.setUniform("endRadius",e.endRadius);n.setUniform("endRadiusVar",e.endRadiusVar);n.setUniform("rotatePS",e.rotatePerS);n.setUniform("rotatePSVar",e.rotatePerSVar);n.setUniform("sizeScale",this._sizeScale);n.setUniform("accelScale",this._accelScale);n.setUniform("radiusScale",this._radiusScale);n.setVertexBuffer(0,this.buffers.updateVB);n.setIndexBuffer(this.buffers.updateIB);n.setProgram(this.programs.emitter);n.draw(0,this.buffers.updateIB.count);n.setFrameBuffer(this.framebuffers.state0);n.setTexture("state",this.textures.state1,0);n.setUniform("statesize",this.statesize);n.setUniform("dt",t);n.setUniform("mode",e.emitterMode);n.setUniform("gravity",this._gravity);n.setUniform("sizeScale",this._sizeScale);n.setUniform("accelScale",this._accelScale);n.setUniform("radiusScale",this._radiusScale);n.setVertexBuffer(0,this.buffers.updateVB);n.setIndexBuffer(this.buffers.updateIB);n.setProgram(this.programs.update);n.draw(0,this.buffers.updateIB.count);n.setViewport(0,0,this._tw*2,this._th*2);n.setFrameBuffer(this.framebuffers.quads);n.setTexture("state",this.textures.state0,0);n.setUniform("quadsize",this.quadsize);n.setUniform("statesize",this.statesize);n.setUniform("sizeScale",this._sizeScale);n.setVertexBuffer(0,this.buffers.updateVB);n.setIndexBuffer(this.buffers.updateIB);n.setProgram(this.programs.quad);n.draw(0,this.buffers.updateIB.count);this._elapsed+=t;if(e.duration!==-1&&e.duration<this._elapsed){this.stopSystem()}}}class Vr{constructor(t=true){this._loaded=false;this._persist=t}unload(){this._loaded=false}reload(){}}class kr extends Vr{constructor(t=false){super(t);this._effect=null}}class qr{constructor(){this._cache={}}get(t){return this._cache[t]}register(t,e){if(t===undefined||this._cache[t]){console.warn("Material key is invalid or already exists")}else if(!e instanceof kr){console.warn("Invalid Material")}else{this._cache[t]=e}}unregister(t){if(t!==undefined){delete this._cache[t]}}}class Xr extends kr{constructor(){super(false);var t=new tr.Pass("sprite");t.setDepth(false,false);t.setCullMode(gfx.CULL_NONE);t.setBlend(gfx.BLEND_FUNC_ADD,gfx.BLEND_SRC_ALPHA,gfx.BLEND_ONE_MINUS_SRC_ALPHA,gfx.BLEND_FUNC_ADD,gfx.BLEND_SRC_ALPHA,gfx.BLEND_ONE_MINUS_SRC_ALPHA);let e=new tr.Technique(["transparent"],[{name:"texture",type:tr.PARAM_TEXTURE_2D}],[t]);this._effect=new tr.Effect([e],{},[{name:"useTexture",value:true},{name:"useModel",value:false},{name:"alphaTest",value:false}]);this._mainTech=e}get effect(){return this._effect}set useTexture(t){this._effect.define("useTexture",t)}set useModel(t){this._effect.define("useModel",t)}get texture(){return this._effect.getProperty("texture")}set texture(t){this._effect.setProperty("texture",t)}clone(){let t=this._effect._values,e={};for(let n in t){let r=t[n];e[n]=r[n]}let n=new Xr(e);n.texture=this.texture;return n}}class Wr extends kr{constructor(){super(false);var t=new tr.Pass("gray_sprite");t.setDepth(false,false);t.setCullMode(gfx.CULL_NONE);t.setBlend(gfx.BLEND_FUNC_ADD,gfx.BLEND_SRC_ALPHA,gfx.BLEND_ONE_MINUS_SRC_ALPHA,gfx.BLEND_FUNC_ADD,gfx.BLEND_SRC_ALPHA,gfx.BLEND_ONE_MINUS_SRC_ALPHA);let e=new tr.Technique(["transparent"],[{name:"texture",type:tr.PARAM_TEXTURE_2D}],[t]);this._effect=new tr.Effect([e],{},[]);this._mainTech=e}get effect(){return this._effect}get texture(){return this._effect.getProperty("texture")}set texture(t){this._effect.setProperty("texture",t)}clone(){let t=this._effect._values,e={};for(let n in t){let r=t[n];e[n]=r[n]}let n=new Wr(e);n.texture=this.texture;return n}}class Gr extends kr{constructor(){super(false);this._pass=new tr.Pass("sprite");this._pass.setDepth(false,false);this._pass.setCullMode(gfx.CULL_NONE);this._pass.setBlend(gfx.BLEND_FUNC_ADD,gfx.BLEND_SRC_ALPHA,gfx.BLEND_ONE_MINUS_SRC_ALPHA,gfx.BLEND_FUNC_ADD,gfx.BLEND_SRC_ALPHA,gfx.BLEND_ONE_MINUS_SRC_ALPHA);let t=new tr.Technique(["transparent"],[{name:"texture",type:tr.PARAM_TEXTURE_2D},{name:"alphaThreshold",type:tr.PARAM_FLOAT}],[this._pass]);this._effect=new tr.Effect([t],{},[{name:"useTexture",value:true},{name:"useModel",value:false},{name:"alphaTest",value:true}]);this._mainTech=t}get effect(){return this._effect}get useTexture(){this._effect.getDefine("useTexture",val)}set useTexture(t){this._effect.define("useTexture",t)}get texture(){return this._effect.getProperty("texture")}set texture(t){this._effect.setProperty("texture",t)}get alphaThreshold(){return this._effect.getProperty("alphaThreshold")}set alphaThreshold(t){this._effect.setProperty("alphaThreshold",t)}clone(){let t=this._effect._values,e={};for(let n in t){let r=t[n];e[n]=r[n]}let n=new Gr(e);n.useTexture=this.useTexture;n.texture=this.texture;n.alphaThreshold=this.alphaThreshold;return n}}class Hr extends kr{constructor(){super(false);var t=new tr.Pass("vfx_particle");t.setDepth(false,false);t.setCullMode(gfx.CULL_NONE);t.setBlend(gfx.BLEND_FUNC_ADD,gfx.BLEND_SRC_ALPHA,gfx.BLEND_ONE_MINUS_SRC_ALPHA,gfx.BLEND_FUNC_ADD,gfx.BLEND_SRC_ALPHA,gfx.BLEND_ONE_MINUS_SRC_ALPHA);let e=new tr.Technique(["transparent"],[{name:"texture",type:tr.PARAM_TEXTURE_2D},{name:"state",type:tr.PARAM_TEXTURE_2D},{name:"quad",type:tr.PARAM_TEXTURE_2D},{name:"z",type:tr.PARAM_FLOAT},{name:"statesize",type:tr.PARAM_FLOAT2},{name:"quadsize",type:tr.PARAM_FLOAT2},{name:"lb",type:tr.PARAM_FLOAT2},{name:"rt",type:tr.PARAM_FLOAT2}],[t]);this._effect=new tr.Effect([e],{},[]);this._mainTech=e;this._lb=U.create();this._rt=U.create()}get effect(){return this._effect}get texture(){return this._effect.getProperty("texture")}set texture(t){this._effect.setProperty("texture",t)}get stateMap(){return this._effect.getProperty("state")}set stateMap(t){this._effect.setProperty("state",t)}get quadMap(){return this._effect.getProperty("quad")}set quadMap(t){this._effect.setProperty("quad",t)}get stateSize(){return this._effect.getProperty("statesize")}set stateSize(t){this._effect.setProperty("statesize",t)}get quadSize(){return this._effect.getProperty("quadsize")}set quadSize(t){this._effect.setProperty("quadsize",t)}get z(){return this._effect.getProperty("z")}set z(t){this._effect.setProperty("z",t)}get uv(){let t=this._effect.getProperty("lb");let e=this._effect.getProperty("rt");return{l:t.x,r:e.x,b:t.y,t:e.y}}set uv(t){this._lb.x=t.l;this._lb.y=t.b;this._rt.x=t.r;this._rt.y=t.t;this._effect.setProperty("lb",this._lb);this._effect.setProperty("rt",this._rt)}clone(){let t=this._effect._values,e={};for(let n in t){let r=t[n];e[n]=r[n]}let n=new Hr(e);n.texture=this.texture;n.stateMap=this.stateMap;n.quadMap=this.quadMap;n.stateSize=this.stateSize;n.quadSize=this.quadSize;n.z=this.z;n.uv=this.uv;return n}}const Yr=tr.Scene;const $r=Mr.supportWebGL?lr:dr;const Zr=Mr.supportWebGL?gfx.Texture2D:fr.Texture2D;const jr=Mr.supportWebGL?gfx.Device:fr.Device;const Kr=tr.Model;const Jr=tr.InputAssembler;let Qr={Device:jr,ForwardRenderer:$r,Texture2D:Zr,Scene:Yr,Camera:yr,Model:Kr,RenderData:Rr,InputAssembler:Jr,Particles:Ur,Asset:Vr,Material:kr,SpriteMaterial:Xr,GraySpriteMaterial:Wr,StencilMaterial:Gr,ParticleMaterial:Hr,shaders:gr,renderMode:Mr,MaterialUtil:qr,RecyclePool:Pn,Pool:Fn,math:_t,renderer:tr,gfx:window.gfx,canvas:fr};return Qr}();
//# sourceMappingURL=engine.min.js.map